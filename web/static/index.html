<!-- th3cl4w V4 Control Panel ‚Äî Sidebar Navigation -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>th3cl4w ‚Äî D1 Arm Control</title>
<style>
/* === Variables & Reset === */
:root {
  --bg: #1a1a2e;
  --card: #16213e;
  --card-border: #1a2744;
  --primary: #0f3460;
  --danger: #e94560;
  --success: #53d769;
  --warning: #f0ad4e;
  --info: #4a90d9;
  --text: #e0e0e0;
  --text-dim: #8892a4;
  --mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
  --sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --sidebar-w: 220px;
  --sidebar-collapsed: 48px;
  --statusbar-h: 32px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: var(--bg); color: var(--text); font-family: var(--sans); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

/* === Status Bar (top) === */
.statusbar { display: flex; align-items: center; gap: 10px; padding: 4px 12px; background: #0d1525; border-bottom: 1px solid var(--card-border); flex-shrink: 0; height: var(--statusbar-h); font-family: var(--mono); font-size: 11px; z-index: 100; }
.statusbar .logo { font-size: 16px; font-weight: 700; letter-spacing: 2px; color: var(--danger); cursor: pointer; }
.conn-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; flex-shrink: 0; }
.conn-dot.on { background: var(--success); box-shadow: 0 0 6px var(--success); }
.conn-dot.off { background: var(--danger); box-shadow: 0 0 6px var(--danger); }
.sb-sep { width: 1px; height: 16px; background: var(--card-border); }
.badge { font-size: 10px; font-family: var(--mono); padding: 2px 8px; border-radius: 3px; background: #1a2744; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
.badge.active { background: #0a3d20; color: var(--success); }
.badge.error { background: #3d0a0a; color: var(--danger); }
.badge.warn { background: #3d2a0a; color: var(--warning); }
.statusbar .spacer { flex: 1; }
#connLabel { color: var(--text-dim); }
#connQuality { color: var(--text-dim); }
#simBadge { display:none; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:bold; cursor:pointer; background:#f59e0b; color:#000; }
#taskStatus { color: var(--info); font-size: 10px; }

/* === Layout: sidebar + content === */
.app-layout { display: flex; flex: 1; overflow: hidden; }

/* === Sidebar === */
.sidebar { width: var(--sidebar-w); background: var(--card); border-right: 1px solid var(--card-border); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; overflow-x: hidden; transition: width 0.2s; z-index: 50; }
.sidebar.collapsed { width: var(--sidebar-collapsed); }
.sidebar.collapsed .nav-label, .sidebar.collapsed .nav-group-title span, .sidebar.collapsed .nav-ext-label { display: none; }
.sidebar.collapsed .nav-group-title { justify-content: center; padding: 6px 0; }
.sidebar.collapsed .nav-item { justify-content: center; padding: 6px 0; }

.sidebar-toggle { display: flex; align-items: center; justify-content: center; padding: 8px; cursor: pointer; color: var(--text-dim); border-bottom: 1px solid var(--card-border); flex-shrink: 0; }
.sidebar-toggle:hover { color: var(--text); background: rgba(255,255,255,0.03); }

.nav-group { border-bottom: 1px solid rgba(26,39,68,0.5); }
.nav-group-title { display: flex; align-items: center; gap: 8px; padding: 8px 12px; font-family: var(--mono); font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; cursor: pointer; user-select: none; }
.nav-group-title:hover { color: var(--text); background: rgba(255,255,255,0.02); }
.nav-group-title .arrow { font-size: 8px; transition: transform 0.15s; }
.nav-group.open .arrow { transform: rotate(90deg); }
.nav-items { display: none; }
.nav-group.open .nav-items { display: block; }

.nav-item { display: flex; align-items: center; gap: 8px; padding: 6px 12px 6px 24px; font-size: 12px; color: var(--text-dim); cursor: pointer; transition: all 0.1s; white-space: nowrap; }
.nav-item:hover { color: var(--text); background: rgba(74,144,217,0.08); }
.nav-item.active { color: var(--info); background: rgba(74,144,217,0.12); border-right: 2px solid var(--info); }
.nav-item .nav-icon { width: 16px; text-align: center; flex-shrink: 0; }
.nav-item.ext::after { content: '‚Üó'; font-size: 9px; margin-left: auto; opacity: 0.4; }

/* === Content area === */
.content { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

/* === Panels (each nav item shows one) === */
.panel { display: none; flex: 1; flex-direction: column; overflow: hidden; }
.panel.active { display: flex; }

/* === Panel: Control (preserves original layout) === */
.ctrl-layout { display: flex; flex: 1; overflow: hidden; }
.ctrl-left { flex: 1; min-width: 300px; display: flex; flex-direction: column; border-right: 1px solid var(--card-border); }
.ctrl-right { width: 400px; flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
.viz-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 8px; }
.viz-container canvas { max-width: 100%; max-height: 100%; }

/* === Controls === */
.controls { padding: 12px; display: flex; flex-direction: column; gap: 10px; }
.section-title { font-family: var(--mono); font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 2px; }

/* === Joint Sliders === */
.joint-row { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
.joint-label { font-family: var(--mono); font-size: 11px; width: 22px; color: var(--text-dim); text-align: right; }
.joint-slider { flex: 1; -webkit-appearance: none; appearance: none; height: 5px; background: #1a2744; border-radius: 3px; outline: none; }
.joint-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--primary); cursor: pointer; border: 2px solid #4a90d9; }
.joint-slider::-webkit-slider-thumb:hover { background: #4a90d9; }
.joint-slider::-moz-range-thumb { width: 12px; height: 12px; border-radius: 50%; background: var(--primary); cursor: pointer; border: 2px solid #4a90d9; }
.joint-value { font-family: var(--mono); font-size: 11px; width: 58px; text-align: right; color: var(--text); }

/* === Buttons === */
.btn-row { display: flex; gap: 6px; flex-wrap: wrap; }
.btn { font-family: var(--mono); font-size: 11px; padding: 6px 12px; border: 1px solid var(--card-border); border-radius: 4px; cursor: pointer; background: var(--card); color: var(--text); transition: all 0.15s; text-transform: uppercase; letter-spacing: 1px; }
.btn:hover:not(:disabled) { background: var(--primary); border-color: #4a90d9; }
.btn:active:not(:disabled) { transform: scale(0.97); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; }
.btn.on { background: #0a3d20; border-color: var(--success); color: var(--success); }
.btn.danger { border-color: var(--danger); color: var(--danger); }
.btn.danger:hover:not(:disabled) { background: #3d1a1a; }
.btn.warn { border-color: var(--warning); color: var(--warning); }
.btn.primary { border-color: var(--info); color: var(--info); }
.btn.primary:hover:not(:disabled) { background: rgba(74,144,217,0.15); }

/* === Emergency Stop === */
.estop { width: 100%; padding: 14px; font-size: 15px; font-weight: 700; background: var(--danger); color: #fff; border: 2px solid #ff6b81; border-radius: 6px; cursor: pointer; letter-spacing: 3px; text-transform: uppercase; font-family: var(--mono); transition: all 0.15s; }
.estop:hover { background: #ff2244; box-shadow: 0 0 20px rgba(233,69,96,0.5); }
.estop:active { transform: scale(0.98); }
.estop.flash { animation: estop-flash 0.8s infinite; }
@keyframes estop-flash { 0%,100% { box-shadow: 0 0 5px rgba(233,69,96,0.3); } 50% { box-shadow: 0 0 25px rgba(233,69,96,0.8); border-color: #fff; } }

/* === Text Command Input === */
.text-cmd-wrap { margin-top: 6px; }
.text-cmd { display: flex; gap: 6px; }
.text-cmd input { flex: 1; font-family: var(--mono); font-size: 12px; padding: 8px 10px; background: #0d1525; border: 1px solid var(--info); border-radius: 4px; color: var(--text); outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
.text-cmd input:focus { border-color: #6ab0ff; box-shadow: 0 0 8px rgba(74,144,217,0.3); }
.text-cmd input::placeholder { color: #556; font-style: italic; }
.text-cmd button { padding: 8px 14px; font-size: 11px; }
.text-cmd-feedback { font-family: var(--mono); font-size: 10px; margin-top: 4px; padding: 4px 8px; border-radius: 3px; display: none; line-height: 1.4; }
.text-cmd-feedback.ok { display: block; background: rgba(10,61,32,0.5); color: var(--success); border: 1px solid rgba(83,215,105,0.2); }
.text-cmd-feedback.err { display: block; background: rgba(61,10,10,0.5); color: var(--danger); border: 1px solid rgba(233,69,96,0.2); }
.text-cmd-examples { font-family: var(--mono); font-size: 9px; color: #445; margin-top: 3px; line-height: 1.5; }
.text-cmd-examples span { cursor: pointer; color: #556; transition: color 0.15s; padding: 1px 4px; border-radius: 2px; }
.text-cmd-examples span:hover { color: var(--info); background: rgba(74,144,217,0.1); }

/* === Raw Command Input === */
.raw-cmd { display: flex; gap: 6px; margin-top: 4px; }
.raw-cmd input { flex: 1; font-family: var(--mono); font-size: 11px; padding: 6px 8px; background: #0d1525; border: 1px solid var(--card-border); border-radius: 4px; color: var(--text); outline: none; }
.raw-cmd input:focus { border-color: var(--info); }

/* === Action Log === */
.log-panel { height: 140px; flex-shrink: 0; border-top: 1px solid var(--card-border); display: flex; flex-direction: column; }
.log-title { font-family: var(--mono); font-size: 10px; color: var(--text-dim); padding: 6px 12px 2px; text-transform: uppercase; letter-spacing: 2px; flex-shrink: 0; }
.log-scroll { flex: 1; overflow-y: auto; padding: 0 12px 6px; font-family: var(--mono); font-size: 10px; line-height: 1.5; }
.log-entry { white-space: nowrap; }
.log-entry .ts { color: #444; margin-right: 6px; }
.log-entry .act { margin-right: 6px; font-weight: 600; }
.log-entry.info .act { color: var(--info); }
.log-entry.error .act { color: var(--danger); }
.log-entry.warning .act { color: var(--warning); }
.log-entry.info .detail { color: var(--text-dim); }
.log-entry.error .detail { color: #d9534f; }
.log-entry.warning .detail { color: #c09853; }

/* === Camera Panel === */
.camera-panel { border-top: 1px solid var(--card-border); flex-shrink: 0; }
.camera-header { display: flex; align-items: center; justify-content: space-between; padding: 6px 12px; }
.cam-toggle { font-size: 10px !important; padding: 3px 8px !important; }
.camera-feeds { display: flex; gap: 8px; padding: 0 12px 8px; }
.camera-feeds.hidden { display: none; }
.cam-feed { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
.cam-label { font-family: var(--mono); font-size: 10px; color: var(--text-dim); display: flex; align-items: center; gap: 6px; }
.cam-live { color: var(--danger); font-size: 9px; animation: cam-blink 2s infinite; }
@keyframes cam-blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
.cam-img { width: 100%; aspect-ratio: 4/3; object-fit: contain; background: #0d1525; border: 1px solid var(--card-border); border-radius: 4px; }
.cam-snap { font-size: 9px !important; padding: 2px 6px !important; align-self: flex-start; }

/* === Generic panel content === */
.panel-body { padding: 16px; overflow-y: auto; flex: 1; }
.panel-header { font-family: var(--mono); font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text); display: flex; align-items: center; gap: 8px; }
.panel-card { background: var(--card); border: 1px solid var(--card-border); border-radius: 6px; padding: 12px; margin-bottom: 12px; }
.panel-card h3 { font-family: var(--mono); font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
.panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
.form-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.form-row label { font-family: var(--mono); font-size: 11px; color: var(--text-dim); min-width: 80px; }
.form-row input, .form-row select { font-family: var(--mono); font-size: 11px; padding: 5px 8px; background: #0d1525; border: 1px solid var(--card-border); border-radius: 3px; color: var(--text); flex: 1; }
.form-row input:focus, .form-row select:focus { border-color: var(--info); outline: none; }
.status-indicator { display: inline-flex; align-items: center; gap: 6px; font-family: var(--mono); font-size: 11px; padding: 4px 10px; border-radius: 4px; background: #0d1525; }
.status-indicator.running { border-left: 3px solid var(--success); }
.status-indicator.stopped { border-left: 3px solid var(--text-dim); }
.status-indicator.error { border-left: 3px solid var(--danger); }
.phase-display { display: flex; gap: 4px; margin: 8px 0; flex-wrap: wrap; }
.phase-chip { font-family: var(--mono); font-size: 10px; padding: 3px 8px; border-radius: 3px; background: #1a2744; color: var(--text-dim); border: 1px solid var(--card-border); }
.phase-chip.active { background: rgba(74,144,217,0.15); color: var(--info); border-color: var(--info); }
.phase-chip.done { background: rgba(83,215,105,0.1); color: var(--success); border-color: rgba(83,215,105,0.3); }
.phase-chip.error { background: rgba(233,69,96,0.1); color: var(--danger); border-color: rgba(233,69,96,0.3); }
.result-box { font-family: var(--mono); font-size: 11px; background: #0d1525; border: 1px solid var(--card-border); border-radius: 4px; padding: 8px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; color: var(--text-dim); line-height: 1.5; }
.inline-status { font-family: var(--mono); font-size: 10px; padding: 2px 8px; border-radius: 3px; }

/* === Scrollbar === */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: #2a3a5c; border-radius: 3px; }

/* === Debug Panel === */
.debug-panel { background: #111827; border-top: 2px solid #4a90d9; font-family: var(--mono); font-size: 11px; padding: 8px 12px; overflow-y: auto; max-height: 340px; display: none; }
.debug-section { margin-bottom: 10px; }
.debug-title { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; }
.debug-pipeline { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
.pipe-stage { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 4px 8px; border: 1px solid #333; border-radius: 4px; min-width: 54px; background: #0d1525; }
.pipe-stage.active { border-color: var(--success); }
.pipe-stage.active .pipe-dot { background: var(--success); box-shadow: 0 0 6px var(--success); }
.pipe-stage.error { border-color: var(--danger); }
.pipe-stage.error .pipe-dot { background: var(--danger); box-shadow: 0 0 6px var(--danger); }
.pipe-dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
.pipe-label { font-size: 9px; color: var(--text-dim); }
.pipe-latency { font-size: 8px; color: #555; }
.pipe-arrow { color: #444; font-size: 14px; }
.debug-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.stat-group { background: #0d1525; border: 1px solid #333; border-radius: 4px; padding: 6px 8px; }
.stat-header { font-size: 9px; color: var(--info); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.stat-row { display: flex; justify-content: space-between; gap: 6px; padding: 1px 0; }
.stat-row span:first-child { color: var(--text-dim); font-size: 9px; }
.stat-row span:last-child { color: var(--text); font-size: 10px; }
.debug-events { background: #0d1525; border: 1px solid #333; border-radius: 4px; padding: 4px 8px; max-height: 140px; overflow-y: auto; font-size: 10px; line-height: 1.6; }
.debug-evt { white-space: nowrap; }
.debug-evt .de-ts { color: #555; margin-right: 4px; }
.debug-evt .de-type { font-weight: 600; margin-right: 4px; }
.debug-evt .de-cid { color: #666; margin-right: 4px; }
.debug-evt .de-pay { color: var(--text-dim); }
.de-CMD_SENT { color: #4a90d9; }
.de-DDS_PUBLISH { color: #9b59b6; }
.de-DDS_RECEIVE { color: #53d769; }
.de-CMD_ACK { color: #7fff00; }
.de-CMD_EXEC { color: #2e8b57; }
.de-STATE_UPDATE { color: #f0ad4e; }
.de-WS_SEND { color: #87ceeb; }
.de-ERROR { color: #e94560; }
.de-CAM_FRAME { color: #888; }

/* === ASCII Tab (inside panel) === */
.ascii-tab-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.ascii-controls-bar { display: flex; align-items: center; gap: 12px; padding: 6px 12px; background: var(--card); border-bottom: 1px solid var(--card-border); flex-wrap: wrap; flex-shrink: 0; }
.ascii-controls-bar label { font-family: var(--mono); font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
.ascii-controls-bar select, .ascii-controls-bar input[type="number"] { font-family: var(--mono); font-size: 11px; padding: 3px 6px; background: #0d1525; border: 1px solid var(--card-border); border-radius: 3px; color: var(--text); }
.ascii-controls-bar input[type="number"] { width: 50px; }
.ascii-toggle { font-family: var(--mono); font-size: 10px; padding: 4px 10px; border: 1px solid var(--card-border); border-radius: 3px; cursor: pointer; background: var(--card); color: var(--text-dim); transition: all 0.15s; }
.ascii-toggle:hover { background: var(--primary); }
.ascii-toggle.on { background: #0a3d20; border-color: var(--success); color: var(--success); }
.ascii-status-bar { display: flex; align-items: center; gap: 12px; padding: 4px 12px; background: #0d1117; border-bottom: 1px solid var(--card-border); font-family: var(--mono); font-size: 10px; color: var(--text-dim); flex-shrink: 0; }
.ascii-status-dot { width: 7px; height: 7px; border-radius: 50%; background: #666; }
.ascii-status-dot.on { background: var(--success); box-shadow: 0 0 6px var(--success); }
.ascii-status-dot.err { background: var(--danger); box-shadow: 0 0 6px var(--danger); }
.ascii-viewport { flex: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; padding: 8px; gap: 12px; }
.ascii-pane { flex: 1; display: flex; flex-direction: column; align-items: center; overflow: hidden; min-width: 0; }
.ascii-pane-label { font-family: var(--mono); font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 4px; flex-shrink: 0; }
.ascii-pane pre { white-space: pre; line-height: 1.1; letter-spacing: 0.5px; color: #88cc88; text-align: center; user-select: text; font-family: var(--mono); }
.ascii-divider { width: 1px; background: var(--card-border); flex-shrink: 0; align-self: stretch; }
#asciiOutput { white-space: pre; line-height: 1.1; letter-spacing: 0.5px; color: #88cc88; text-align: center; user-select: text; font-family: var(--mono); }
#asciiOutput.color-mode { color: unset; }

/* === Collision Alert === */
.collision-alert { position: fixed; bottom: 12px; right: 12px; z-index: 9999; background: rgba(139,0,0,0.92); color: #fff; padding: 10px 14px; box-shadow: 0 2px 12px rgba(233,69,96,0.4); border-radius: 8px; border-left: 3px solid #e74c3c; animation: collisionFlash 0.3s ease-in-out; display: none; max-width: 340px; font-size: 12px; backdrop-filter: blur(8px); }
.collision-alert.visible { display: block; }
.collision-alert h3 { margin: 0 0 4px; font-family: var(--mono); font-size: 12px; }
.collision-alert p { margin: 2px 0; font-size: 11px; line-height: 1.3; }
.collision-alert .collision-images { display: flex; gap: 4px; margin: 6px 0; }
.collision-alert .collision-images img { width: 80px; height: 60px; object-fit: cover; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; }
.collision-alert .dismiss-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: #fff; padding: 2px 12px; border-radius: 3px; cursor: pointer; font-family: var(--mono); font-size: 11px; margin-top: 4px; }
@keyframes collisionFlash { 0% { opacity: 0; transform: translateY(-20px); } 100% { opacity: 1; transform: translateY(0); } }

/* === Simulator Panel === */
.sim-layout { display: flex; flex: 1; overflow: hidden; }
.sim-viewport { flex: 1; position: relative; min-width: 0; background: #0d1525; }
.sim-viewport canvas { display: block; width: 100%; height: 100%; }
.sim-sidebar { width: 340px; flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; border-left: 1px solid var(--card-border); background: var(--card); }
.sim-controls { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
.sim-mode-bar { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #0d1525; border-bottom: 1px solid var(--card-border); flex-shrink: 0; }
.sim-mode-toggle { position: relative; display: inline-flex; background: #1a2744; border-radius: 4px; border: 1px solid var(--card-border); overflow: hidden; }
.sim-mode-toggle label { font-family: var(--mono); font-size: 10px; padding: 5px 14px; cursor: pointer; color: var(--text-dim); transition: all 0.15s; text-transform: uppercase; letter-spacing: 1px; user-select: none; }
.sim-mode-toggle input { display: none; }
.sim-mode-toggle input:checked + label { background: var(--info); color: #fff; }
.sim-mode-toggle .mode-sim:checked + label { background: #f59e0b; color: #000; }
.sim-mode-toggle .mode-phys:checked + label { background: #ef4444; color: #fff; }
.sim-ee-info { font-family: var(--mono); font-size: 10px; color: var(--text-dim); padding: 6px 8px; background: #0d1525; border: 1px solid var(--card-border); border-radius: 4px; line-height: 1.6; }
.sim-ee-info .ee-label { color: var(--info); text-transform: uppercase; letter-spacing: 1px; font-size: 9px; }
.sim-ee-info .ee-val { color: var(--text); }
.sim-joint-row { display: flex; align-items: center; gap: 4px; margin-bottom: 1px; }
.sim-joint-row .sjl { font-family: var(--mono); font-size: 10px; width: 22px; color: var(--text-dim); text-align: right; }
.sim-joint-row input[type="range"] { flex: 1; -webkit-appearance: none; appearance: none; height: 4px; background: #1a2744; border-radius: 2px; outline: none; }
.sim-joint-row input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; border-radius: 50%; background: var(--info); cursor: pointer; border: 1px solid #6ab0ff; }
.sim-joint-row .sjv { font-family: var(--mono); font-size: 10px; width: 50px; text-align: right; color: var(--text); }
.sim-btn-row { display: flex; gap: 4px; flex-wrap: wrap; }
.sim-btn-row .btn { font-size: 10px; padding: 4px 8px; }
.sim-camera-presets { display: flex; gap: 3px; }
.sim-camera-presets .btn { font-size: 9px; padding: 3px 6px; }
.sim-viz-toggles { display: flex; gap: 3px; flex-wrap: wrap; }
.sim-viz-toggles .btn { font-size: 9px; padding: 3px 6px; }
.sim-viz-toggles .btn.on { background: #0a3d20; border-color: var(--success); color: var(--success); }
.sim-overlay-info { position: absolute; top: 8px; left: 8px; font-family: var(--mono); font-size: 10px; color: rgba(224,224,224,0.6); pointer-events: none; line-height: 1.5; }
.sim-overlay-mode { position: absolute; top: 8px; right: 8px; font-family: var(--mono); font-size: 11px; font-weight: bold; padding: 3px 10px; border-radius: 4px; pointer-events: none; }
.sim-overlay-mode.simulate { background: rgba(245,158,11,0.85); color: #000; }
.sim-overlay-mode.physical { background: rgba(239,68,68,0.85); color: #fff; }
.sim-execute-bar { padding: 8px; border-top: 1px solid var(--card-border); background: #0d1525; }
.sim-execute-bar .btn-execute { width: 100%; padding: 10px; font-size: 12px; font-weight: 700; font-family: var(--mono); letter-spacing: 2px; text-transform: uppercase; border-radius: 5px; cursor: pointer; transition: all 0.15s; border: 2px solid; }
.sim-execute-bar .btn-execute.sim-mode { background: rgba(245,158,11,0.15); border-color: #f59e0b; color: #f59e0b; }
.sim-execute-bar .btn-execute.sim-mode:hover { background: rgba(245,158,11,0.25); }
.sim-execute-bar .btn-execute.phys-mode { background: rgba(239,68,68,0.15); border-color: #ef4444; color: #ef4444; }
.sim-execute-bar .btn-execute.phys-mode:hover { background: rgba(239,68,68,0.3); box-shadow: 0 0 15px rgba(239,68,68,0.3); }

/* === Responsive === */
@media (max-width: 900px) {
  .sidebar { position: fixed; left: 0; top: var(--statusbar-h); bottom: 0; z-index: 200; box-shadow: 4px 0 20px rgba(0,0,0,0.5); }
  .sidebar.collapsed { width: 0; overflow: hidden; }
  .ctrl-layout { flex-direction: column; }
  .ctrl-left { min-height: 220px; border-right: none; border-bottom: 1px solid var(--card-border); }
  .ctrl-right { width: 100%; flex: 1; }
  .debug-stats { grid-template-columns: repeat(2, 1fr); }
}
/* Safety settings tooltips */
.setting-tooltip { position: relative; cursor: help; }
.setting-tooltip:hover::after {
  content: attr(data-tooltip);
  position: absolute; z-index: 100; bottom: 100%; left: 0;
  background: #1a2744; color: #e0e0e0; border: 1px solid var(--card-border);
  border-radius: 6px; padding: 6px 10px; font-size: 11px; line-height: 1.4;
  max-width: 300px; white-space: normal; pointer-events: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
/* Comprehensive Safety Panel */
.safety-section { border:1px solid var(--card-border); border-radius:8px; margin-bottom:8px; background:var(--card-bg); }
.safety-section[open] { border-color:var(--accent); }
.safety-section-title { padding:10px 14px; cursor:pointer; font-size:13px; font-weight:bold; display:flex; align-items:center; gap:8px; user-select:none; }
.safety-section-title:hover { background:rgba(255,255,255,0.03); }
.safety-section-body { padding:8px 14px 14px; border-top:1px solid var(--card-border); }
.safety-badge { font-size:10px; padding:2px 8px; border-radius:10px; font-weight:normal; margin-left:auto; }
.safety-badge.green { background:#1a5c2a; color:#6bff8d; }
.safety-badge.yellow { background:#5c4a1a; color:#ffd06b; }
.safety-badge.red { background:#5c1a1a; color:#ff6b6b; }
.safety-input { width:80px; background:var(--bg-darker); color:var(--text-primary); border:1px solid var(--card-border); padding:3px 6px; border-radius:4px; font-size:12px; }
.safety-field { font-size:12px; display:flex; align-items:center; gap:6px; cursor:help; }
.safety-risk { display:inline-block; width:12px; height:12px; border-radius:50%; }
.safety-risk.green { background:#27ae60; }
.safety-risk.yellow { background:#f39c12; }
.safety-risk.red { background:#e74c3c; }
</style>
</head>
<body>

<!-- === Collision Alert Overlay === -->
<div id="collisionAlert" class="collision-alert">
  <h3>‚ö† COLLISION DETECTED</h3>
  <p id="collisionInfo"></p>
  <p id="collisionAnalysis" style="font-style:italic; opacity:0.9;"></p>
  <div id="collisionImages" class="collision-images"></div>
  <button class="dismiss-btn" onclick="dismissCollision()">Dismiss</button>
</div>

<!-- === Status Bar === -->
<div class="statusbar">
  <span class="logo" onclick="document.querySelector('.sidebar').classList.toggle('collapsed')">th3cl4w</span>
  <div class="sb-sep"></div>
  <div class="conn-dot" id="connDot"></div>
  <span id="connLabel" style="font-size:10px">DISCONNECTED</span>
  <span id="connQuality"></span>
  <span id="simBadge" title="Click to toggle SIM/LIVE mode">SIM</span>
  <div class="sb-sep"></div>
  <div class="badge" id="badgePower">PWR OFF</div>
  <div class="badge" id="badgeEnabled">DISABLED</div>
  <div class="badge" id="badgeError">NO ERR</div>
  <div class="sb-sep"></div>
  <span id="taskStatus"></span>
  <div class="spacer"></div>
  <span style="font-size:10px;color:var(--text-dim)" id="camStatusBar">CAM: --</span>
</div>

<!-- === Main Layout === -->
<div class="app-layout">

<!-- === Sidebar Navigation === -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-toggle" onclick="this.parentElement.classList.toggle('collapsed')" title="Toggle sidebar">‚ò∞</div>

  <!-- üéÆ Control -->
  <div class="nav-group open" data-group="control">
    <div class="nav-group-title" onclick="toggleNavGroup(this)"><span class="arrow">‚ñ∂</span> <span>üéÆ Control</span></div>
    <div class="nav-items">
      <div class="nav-item active" data-panel="control" onclick="showPanel(this)"><span class="nav-icon">ü¶æ</span> <span class="nav-label">Arm Control</span></div>
      <div class="nav-item" data-panel="simulator" onclick="showPanel(this)"><span class="nav-icon">üîÆ</span> <span class="nav-label">3D Simulator <span class="beta-pill">BETA</span></span></div>
      <div class="nav-item" data-panel="cameras" onclick="showPanel(this)"><span class="nav-icon">üì∑</span> <span class="nav-label">Cameras</span></div>
    </div>
  </div>

  <!-- üéØ Pick & Place -->
  <div class="nav-group" data-group="pick">
    <div class="nav-group-title" onclick="toggleNavGroup(this)"><span class="arrow">‚ñ∂</span> <span>üéØ Pick & Place</span></div>
    <div class="nav-items">
      <div class="nav-item" data-panel="visual-servo" onclick="showPanel(this)"><span class="nav-icon">üéØ</span> <span class="nav-label">Visual Servo</span></div>
      <div class="nav-item" data-panel="multiview-pick" onclick="showPanel(this)"><span class="nav-icon">ü§è</span> <span class="nav-label">Multi-view Pick</span></div>
      <div class="nav-item" data-panel="pick-planner" onclick="showPanel(this)"><span class="nav-icon">üìê</span> <span class="nav-label">Pick Planner</span></div>
      <div class="nav-item" data-panel="vla" onclick="showPanel(this)"><span class="nav-icon">üß†</span> <span class="nav-label">VLA Agent</span></div>
    </div>
  </div>

  <!-- üó∫Ô∏è Mapping -->
  <div class="nav-group" data-group="mapping">
    <div class="nav-group-title" onclick="toggleNavGroup(this)"><span class="arrow">‚ñ∂</span> <span>üó∫Ô∏è Mapping</span></div>
    <div class="nav-items">
      <div class="nav-item" data-panel="bifocal" onclick="showPanel(this)"><span class="nav-icon">üîç</span> <span class="nav-label">Workspace Calibration</span></div>
      <div class="nav-item" data-panel="object-detect" onclick="showPanel(this)"><span class="nav-icon">üéØ</span> <span class="nav-label">Object Detection</span></div>
      <div class="nav-item" data-panel="scan3d" onclick="showPanel(this)"><span class="nav-icon">üì°</span> <span class="nav-label">3D Scan</span></div>
    </div>
  </div>

  <!-- üîß Calibration -->
  <div class="nav-group" data-group="calib">
    <div class="nav-group-title" onclick="toggleNavGroup(this)"><span class="arrow">‚ñ∂</span> <span>üîß Calibration</span></div>
    <div class="nav-items">
      <div class="nav-item" data-panel="calibration" onclick="showPanel(this)"><span class="nav-icon">üéØ</span> <span class="nav-label">Calibration</span></div>
    </div>
  </div>

  <!-- üìä Telemetry -->
  <div class="nav-group" data-group="telemetry">
    <div class="nav-group-title" onclick="toggleNavGroup(this)"><span class="arrow">‚ñ∂</span> <span>üìä Telemetry</span></div>
    <div class="nav-items">
      <div class="nav-item" data-panel="debug" onclick="showPanel(this)"><span class="nav-icon">üîß</span> <span class="nav-label">Debug Pipeline</span></div>
      <div class="nav-item" data-panel="diagnostics" onclick="showPanel(this)"><span class="nav-icon">ü©∫</span> <span class="nav-label">Diagnostics</span></div>
      <div class="nav-item ext" onclick="window.open('/telemetry','_blank')"><span class="nav-icon">üìä</span> <span class="nav-label">Telemetry Page</span></div>
    </div>
  </div>

  <!-- ü§ñ Vision -->
  <div class="nav-group" data-group="vision">
    <div class="nav-group-title" onclick="toggleNavGroup(this)"><span class="arrow">‚ñ∂</span> <span>ü§ñ Vision</span></div>
    <div class="nav-items">
      <div class="nav-item" data-panel="locate" onclick="showPanel(this)"><span class="nav-icon">üîé</span> <span class="nav-label">Object Locator</span></div>
      <div class="nav-item" data-panel="scene-analysis" onclick="showPanel(this)"><span class="nav-icon">üëÅ</span> <span class="nav-label">Scene Analysis</span></div>
      <div class="nav-item" data-panel="claw-prediction" onclick="showPanel(this)"><span class="nav-icon">ü¶Ä</span> <span class="nav-label">Claw Prediction</span></div>
    </div>
  </div>

  <!-- üé¨ 3D Views -->
  <div class="nav-group" data-group="3d">
    <div class="nav-group-title" onclick="toggleNavGroup(this)"><span class="arrow">‚ñ∂</span> <span>üé¨ 3D Views</span></div>
    <div class="nav-items">
      <div class="nav-item" data-panel="ascii" onclick="showPanel(this)"><span class="nav-icon">‚ñì</span> <span class="nav-label">ASCII Video</span></div>
      <div class="nav-item" data-panel="factory" onclick="showPanel(this)"><span class="nav-icon">üè≠</span> <span class="nav-label">Factory 3D</span></div>
      <div class="nav-item" data-panel="realworld" onclick="showPanel(this)"><span class="nav-icon">üåç</span> <span class="nav-label">Real World 3D</span></div>
      <div class="nav-item ext" onclick="window.open('/map3d.html','_blank')"><span class="nav-icon">üó∫Ô∏è</span> <span class="nav-label">Map 3D</span></div>
      <div class="nav-item ext" onclick="window.open('/scan3d.html','_blank')"><span class="nav-icon">‚òÅÔ∏è</span> <span class="nav-label">Scan Viewer</span></div>
      <div class="nav-item ext" onclick="window.open('http://'+location.hostname+':8084','_blank')"><span class="nav-icon">üì∫</span> <span class="nav-label">ASCII Server</span></div>
    </div>
  </div>

  <!-- ‚öôÔ∏è Settings -->
  <div class="nav-group" data-group="settings">
    <div class="nav-group-title" onclick="toggleNavGroup(this)"><span class="arrow">‚ñ∂</span> <span>‚öôÔ∏è Settings</span></div>
    <div class="nav-items">
      <div class="nav-item" data-panel="settings" onclick="showPanel(this)"><span class="nav-icon">‚öôÔ∏è</span> <span class="nav-label">Settings</span></div>
      <div class="nav-item" data-panel="safety" onclick="showPanel(this)"><span class="nav-icon">üõ°Ô∏è</span> <span class="nav-label">Safety</span></div>
    </div>
  </div>
</nav>

<!-- === Content Area === -->
<div class="content">

<!-- ============================================================ -->
<!-- PANEL: Arm Control (original control tab)                     -->
<!-- ============================================================ -->
<div class="panel active" id="panel-control">
<div class="ctrl-layout">
  <div class="ctrl-left">
    <div class="viz-container">
      <canvas id="armCanvas" width="600" height="500"></canvas>
    </div>
    <div class="camera-panel" id="cameraPanel">
      <div class="camera-header">
        <span class="section-title" style="margin:0">Cameras</span>
        <button class="btn cam-toggle" id="btnCamToggle" title="Toggle cameras">üëÅ HIDE</button>
        <button class="btn" id="btnCamSettings" title="Camera settings" style="font-size:10px;padding:3px 8px">‚öô SETTINGS</button>
      </div>
      <div class="camera-feeds" id="cameraFeeds">
        <div class="cam-feed">
          <div class="cam-label"><span class="cam-live" id="camLive0">‚óè LIVE</span> <span class="cam-label-text" id="camLabel0">Camera 0</span> <span class="cam-mode-badge" id="camMode0" style="font-size:8px;padding:1px 4px;border-radius:3px;background:#1a2744;color:var(--text-dim)">MJPEG</span></div>
          <img class="cam-img" id="camImg0" alt="Camera 0">
          <canvas class="cam-img" id="camCanvas0" style="display:none"></canvas>
          <button class="btn cam-snap" onclick="window.open(`http://${location.hostname}:8081/snap/0`,'_blank')">üì∑ Snap</button>
        </div>
        <div class="cam-feed">
          <div class="cam-label"><span class="cam-live" id="camLive1">‚óè LIVE</span> <span class="cam-label-text" id="camLabel1">Camera 1</span> <span class="cam-mode-badge" id="camMode1" style="font-size:8px;padding:1px 4px;border-radius:3px;background:#1a2744;color:var(--text-dim)">MJPEG</span></div>
          <img class="cam-img" id="camImg1" alt="Camera 1">
          <canvas class="cam-img" id="camCanvas1" style="display:none"></canvas>
          <button class="btn cam-snap" onclick="window.open(`http://${location.hostname}:8081/snap/1`,'_blank')">üì∑ Snap</button>
        </div>
        <div class="cam-feed">
          <div class="cam-label"><span class="cam-live" id="camLive2">‚óè LIVE</span> <span class="cam-label-text" id="camLabel2">Camera 2</span> <span class="cam-mode-badge" id="camMode2" style="font-size:8px;padding:1px 4px;border-radius:3px;background:#1a2744;color:var(--text-dim)">MJPEG</span></div>
          <img class="cam-img" id="camImg2" alt="Camera 2">
          <canvas class="cam-img" id="camCanvas2" style="display:none"></canvas>
          <button class="btn cam-snap" onclick="window.open(`http://${location.hostname}:8081/snap/2`,'_blank')">üì∑ Snap</button>
        </div>
      </div>
      <div style="padding:2px 12px 6px;display:flex;gap:6px;align-items:center;">
        <button class="btn" id="btnCamModeToggle" style="font-size:9px;padding:2px 8px" title="Toggle between MJPEG and WebSocket+Canvas mode">üîÑ WS MODE</button>
        <span style="font-family:var(--mono);font-size:9px;color:var(--text-dim)" id="camModeInfo">MJPEG streaming (low latency)</span>
      </div>
      <div id="cameraSettings" style="display:none; padding:8px 12px; border-top:1px solid var(--card-border);">
        <div class="section-title" style="margin-bottom:6px">Camera Settings</div>
        <div id="camSettingsRows"></div>
        <button class="btn" id="btnSaveCamConfig" style="margin-top:6px">üíæ SAVE</button>
      </div>
    </div>
  </div>

  <div class="ctrl-right">
    <div class="controls">
      <div class="section-title">Joint Control (6 DOF)</div>
      <div id="jointSliders"></div>

      <div style="margin-top:4px">
        <div class="section-title">Gripper</div>
        <div class="joint-row">
          <span class="joint-label">G</span>
          <input type="range" class="joint-slider" id="gripperSlider" min="0" max="65" step="0.5" value="0">
          <span class="joint-value" id="gripperValue">0.0 mm</span>
        </div>
      </div>

      <div style="margin-top:6px">
        <div class="section-title">Commands</div>
        <div class="btn-row">
          <button class="btn" id="btnPowerOn">Power On</button>
          <button class="btn" id="btnPowerOff">Power Off</button>
          <button class="btn" id="btnEnable">Enable</button>
          <button class="btn" id="btnEnableHere" title="Enable motors and hold current position">Enable Here</button>
          <button class="btn" id="btnDisable">Disable</button>
          <button class="btn warn" id="btnResetEnable" title="Safe enable (no reset to zero)">Reset + Enable</button>
          <button class="btn warn" id="btnHardResetEnable" title="‚ö† Resets all joints to 0¬∞ ‚Äî only use near home!" style="font-size:10px">Hard Reset</button>
        </div>
      </div>

      <div style="margin-top:6px">
        <div class="section-title">Tasks</div>
        <div class="btn-row">
          <button class="btn" id="btnTaskHome">Home</button>
          <button class="btn" id="btnSafeHome" title="Move to home one joint at a time (safe)">Safe Home</button>
          <button class="btn" id="btnTaskReady">Ready</button>
          <button class="btn" id="btnTaskWave">Wave</button>
          <button class="btn warn" id="btnTaskStop">Stop Task</button>
        </div>
      </div>

      <button class="estop" id="btnEstop">‚ö† EMERGENCY STOP</button>

      <div class="section-title">3D Tracking Status</div>
      <div id="calibStatusPanel" style="font-size:11px;color:#8899aa;padding:4px 0;line-height:1.6">
        <span id="calibCams">Cameras: --</span><br>
        <span id="calibLoaded">Calibration: --</span><br>
        <span id="calibQuality">Tracking: --</span>
      </div>

      <div class="section-title">Text Command</div>
      <div class="text-cmd-wrap">
        <div class="text-cmd">
          <input type="text" id="textCmdInput" placeholder="Tell the arm what to do...">
          <button class="btn" id="btnTextCmd">GO</button>
        </div>
        <div class="text-cmd-feedback" id="textCmdFeedback"></div>
        <div class="text-cmd-examples">try: <span onclick="textCmdFill(this)">wave hello</span> <span onclick="textCmdFill(this)">go home</span> <span onclick="textCmdFill(this)">open gripper</span> <span onclick="textCmdFill(this)">reach forward</span> <span onclick="textCmdFill(this)">point left</span> <span onclick="textCmdFill(this)">nod</span> <span onclick="textCmdFill(this)">raise</span> <span onclick="textCmdFill(this)">set j0 to 45</span></div>
      </div>

      <div class="section-title">Raw Command</div>
      <div class="raw-cmd">
        <input type="text" id="rawInput" placeholder='{"action":"set-joint","id":0,"angle":45}'>
        <button class="btn" id="btnRawSend">Send</button>
      </div>

      <div style="margin-top:10px;padding:8px;background:var(--card);border:1px solid var(--card-border);border-radius:4px;">
        <div class="section-title">LLM/CV Calibration</div>
        <div style="display:flex;gap:6px;margin-top:4px;">
          <button class="btn" id="btnStartCalib" style="flex:1">START CALIBRATION</button>
          <button class="btn warn" id="btnStopCalib" style="flex:1" disabled>STOP</button>
        </div>
        <div id="calibProgress" style="display:none;margin-top:6px;font-size:11px;color:var(--text-dim);">
          <div>Pose <span id="calibCurrent">0</span> / <span id="calibTotal">20</span></div>
          <div style="background:#1a2744;border-radius:3px;height:6px;margin-top:4px;overflow:hidden;">
            <div id="calibProgressBar" style="background:var(--info);height:100%;width:0%;transition:width 0.3s;"></div>
          </div>
        </div>
        <div id="calibResults" style="display:none;margin-top:6px;font-size:11px;color:var(--text-dim);max-height:150px;overflow-y:auto;white-space:pre-wrap;font-family:var(--mono);"></div>
      </div>
    </div>
  </div>
</div>
<div class="log-panel">
  <div class="log-title">Action Log</div>
  <div class="log-scroll" id="logScroll"></div>
</div>
</div><!-- /panel-control -->

<!-- ============================================================ -->
<!-- PANEL: 3D Simulator                                           -->
<!-- ============================================================ -->
<div class="panel" id="panel-simulator">
<div class="sim-layout">
  <div class="sim-viewport" id="simViewport">
    <div class="sim-overlay-info" id="simOverlayInfo">D1 Arm Simulator</div>
    <div class="sim-overlay-mode simulate" id="simOverlayMode">SIMULATE</div>
  </div>
  <div class="sim-sidebar">
    <div class="sim-mode-bar">
      <span style="font-family:var(--mono);font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;">Mode:</span>
      <div class="sim-mode-toggle">
        <input type="radio" name="simMode" id="simModeSim" class="mode-sim" value="simulate" checked>
        <label for="simModeSim">Simulate</label>
        <input type="radio" name="simMode" id="simModePhys" class="mode-phys" value="physical">
        <label for="simModePhys">Physical</label>
      </div>
      <span style="flex:1"></span>
      <span style="font-family:var(--mono);font-size:9px;color:var(--text-dim)" id="simFpsDisplay">-- fps</span>
    </div>
    <div class="sim-controls">
      <div class="section-title">Sim Joint Control</div>
      <div id="simJointSliders"></div>

      <div style="margin-top:2px">
        <div class="section-title">Gripper</div>
        <div class="sim-joint-row">
          <span class="sjl">G</span>
          <input type="range" id="simGripperSlider" min="0" max="65" step="0.5" value="0">
          <span class="sjv" id="simGripperValue">0.0</span>
        </div>
      </div>

      <div class="section-title">End Effector</div>
      <div class="sim-ee-info" id="simEEInfo">
        <span class="ee-label">Position:</span> <span class="ee-val" id="simEEPos">x:0 y:0 z:0</span><br>
        <span class="ee-label">Reach:</span> <span class="ee-val" id="simEEReach">0.000 m</span>
      </div>

      <div class="section-title">Quick Actions</div>
      <div class="sim-btn-row">
        <button class="btn" id="simBtnHome" title="Reset to home position">Home</button>
        <button class="btn" id="simBtnSync" title="Sync from live arm state">Sync Live</button>
        <button class="btn" id="simBtnFollow" title="Continuously follow live arm">Follow Arm</button>
        <button class="btn" id="simBtnClearTrail" title="Clear end-effector trail">Clear Trail</button>
      </div>

      <div class="section-title">Camera View</div>
      <div class="sim-camera-presets">
        <button class="btn" onclick="window._sim && window._sim.setCameraPreset('front')">Front</button>
        <button class="btn" onclick="window._sim && window._sim.setCameraPreset('side')">Side</button>
        <button class="btn" onclick="window._sim && window._sim.setCameraPreset('top')">Top</button>
        <button class="btn" onclick="window._sim && window._sim.setCameraPreset('iso')">Iso</button>
        <button class="btn" onclick="window._sim && window._sim.setCameraPreset('close')">Close</button>
      </div>

      <div class="section-title">Display</div>
      <div class="sim-viz-toggles">
        <button class="btn on" id="simTogGrid" title="Toggle grid">Grid</button>
        <button class="btn on" id="simTogAxes" title="Toggle axes">Axes</button>
        <button class="btn on" id="simTogEnv" title="Toggle workspace envelope">Envelope</button>
        <button class="btn on" id="simTogGhost" title="Toggle ghost (live) arm">Ghost</button>
        <button class="btn on" id="simTogTrail" title="Toggle EE trail">Trail</button>
        <button class="btn" id="simTogObjects" title="Toggle detected objects">Objects</button>
        <button class="btn on" id="simTogCams" title="Toggle camera frustums">Cameras</button>
      </div>

      <div class="section-title" style="margin-top:8px">Object Detection</div>
      <div class="sim-btn-row">
        <button class="btn" id="simObjToggle" title="Enable/disable object detection">Enable</button>
        <button class="btn primary" id="simObjDetect" title="Run detection on current camera frames" disabled>Detect</button>
        <button class="btn" id="simObjClear" title="Clear detected objects">Clear</button>
      </div>
      <div id="simObjStatus" style="font-family:var(--mono);font-size:10px;color:var(--text-dim);padding:4px 0;line-height:1.5">
        Detection: <span id="simObjEnabledLabel" style="color:var(--text-dim)">OFF</span><br>
        Objects: <span id="simObjCount">0</span> total, <span id="simObjReachable" style="color:var(--success)">0</span> reachable
      </div>
      <div id="simObjList" style="font-family:var(--mono);font-size:9px;color:var(--text-dim);max-height:120px;overflow-y:auto;padding:2px 0"></div>

      <details style="margin-top:8px;">
        <summary class="section-title" style="cursor:pointer;user-select:none;">‚ñ∂ Detection Config</summary>
        <div id="detConfigPanel" style="margin-top:6px;font-size:10px;">
          <div style="margin-bottom:6px;font-weight:600;color:var(--text-dim)">HSV Color Ranges</div>
          <div id="detConfigColors"></div>
          <div style="margin-top:6px;font-weight:600;color:var(--text-dim)">Detection Params</div>
          <div class="form-row"><label style="min-width:100px">Min Area</label><input type="number" id="detCfgMinArea" value="800" style="width:70px"></div>
          <div class="form-row"><label style="min-width:100px">Max Area</label><input type="number" id="detCfgMaxArea" value="200000" style="width:70px"></div>
          <div class="form-row"><label style="min-width:100px">Max Objects</label><input type="number" id="detCfgMaxObj" value="20" style="width:70px"></div>
          <div style="margin-top:6px;font-weight:600;color:var(--text-dim)">Workspace Bounds (mm)</div>
          <div class="form-row"><label style="min-width:50px">X min</label><input type="number" id="detCfgXMin" value="-400" style="width:60px"><label style="min-width:40px;text-align:right">max</label><input type="number" id="detCfgXMax" value="400" style="width:60px"></div>
          <div class="form-row"><label style="min-width:50px">Y min</label><input type="number" id="detCfgYMin" value="-400" style="width:60px"><label style="min-width:40px;text-align:right">max</label><input type="number" id="detCfgYMax" value="400" style="width:60px"></div>
          <div style="margin-top:6px;font-weight:600;color:var(--text-dim)">Table Dimensions (mm)</div>
          <div class="form-row"><label style="min-width:50px">Width</label><input type="number" id="detCfgTableW" value="800" style="width:70px"><label style="min-width:40px;text-align:right">Depth</label><input type="number" id="detCfgTableD" value="800" style="width:70px"></div>
          <div style="margin-top:6px;font-weight:600;color:var(--text-dim)">Height Estimation</div>
          <div class="form-row"><label style="min-width:100px">Table Y frac</label><input type="number" id="detCfgTableYF" value="0.85" step="0.01" style="width:60px"></div>
          <div class="form-row"><label style="min-width:100px">Max height</label><input type="number" id="detCfgMaxH" value="300" style="width:60px"></div>
          <div class="sim-btn-row" style="margin-top:8px;">
            <button class="btn primary" id="detCfgSave" style="font-size:9px">Save Config</button>
            <button class="btn" id="detCfgLoad" style="font-size:9px">Load Current</button>
          </div>
        </div>
      </details>

      <details style="margin-top:8px;">
        <summary class="section-title" style="cursor:pointer;user-select:none;">&#9654; Camera Positioning</summary>
        <div id="camPosPanel" style="margin-top:6px;font-size:10px;">
          <div style="margin-bottom:6px;display:flex;gap:4px;align-items:center;">
            <label style="font-weight:600;color:var(--text-dim)">Camera:</label>
            <select id="camPosSelect" style="flex:1;background:#1a1a2e;color:#ccc;border:1px solid #334;padding:2px 4px;font-family:var(--mono);font-size:10px;">
              <option value="0">0 ‚Äî Overhead</option>
              <option value="1">1 ‚Äî Arm Cam</option>
              <option value="2">2 ‚Äî Side View</option>
            </select>
          </div>
          <div style="font-weight:600;color:var(--text-dim);margin-bottom:4px">Position (meters, Z-up)</div>
          <div class="sim-joint-row"><span class="sjl">X</span><input type="range" id="camPosX" min="-1.5" max="1.5" step="0.01" value="0"><span class="sjv" id="camPosXVal">0.00</span></div>
          <div class="sim-joint-row"><span class="sjl">Y</span><input type="range" id="camPosY" min="-1.5" max="1.5" step="0.01" value="0"><span class="sjv" id="camPosYVal">0.00</span></div>
          <div class="sim-joint-row"><span class="sjl">Z</span><input type="range" id="camPosZ" min="-0.5" max="1.5" step="0.01" value="0"><span class="sjv" id="camPosZVal">0.00</span></div>
          <div style="font-weight:600;color:var(--text-dim);margin-top:4px;margin-bottom:4px">Rotation (degrees)</div>
          <div class="sim-joint-row"><span class="sjl">Rx</span><input type="range" id="camRotRx" min="-180" max="180" step="1" value="0"><span class="sjv" id="camRotRxVal">0</span></div>
          <div class="sim-joint-row"><span class="sjl">Ry</span><input type="range" id="camRotRy" min="-180" max="180" step="1" value="0"><span class="sjv" id="camRotRyVal">0</span></div>
          <div class="sim-joint-row"><span class="sjl">Rz</span><input type="range" id="camRotRz" min="-180" max="180" step="1" value="0"><span class="sjv" id="camRotRzVal">0</span></div>
          <div style="font-weight:600;color:var(--text-dim);margin-top:4px;margin-bottom:4px">FOV</div>
          <div class="sim-joint-row"><span class="sjl">FOV</span><input type="range" id="camPosFov" min="30" max="120" step="1" value="60"><span class="sjv" id="camPosFovVal">60</span></div>
          <div style="margin-top:4px;font-family:var(--mono);font-size:9px;color:var(--text-dim);line-height:1.6" id="camPosDistInfo">
            Dist to base: ‚Äî | Dist to EE: ‚Äî
          </div>
          <div class="sim-btn-row" style="margin-top:6px;">
            <button class="btn" id="camPosLookAt" title="Auto-orient camera to look at arm">Look At Arm</button>
            <button class="btn primary" id="camPosSave" title="Save camera config to server">Save</button>
            <button class="btn" id="camPosReset" title="Reload from server">Reset</button>
          </div>
        </div>
      </details>

      <details style="margin-top:8px;">
        <summary class="section-title" style="cursor:pointer;user-select:none;">&#9654; Gemini Camera Assessment <span class="beta-pill">BETA</span></summary>
        <div id="geminiAssessPanel" style="margin-top:6px;font-size:10px;">
          <div style="color:var(--text-dim);line-height:1.5;margin-bottom:6px;">
            Captures live snapshots from all 3 cameras, sends them to Gemini, and gets an AI assessment of where each camera is positioned relative to the arm.
          </div>
          <div class="sim-btn-row">
            <button class="btn primary" id="geminiAssessBtn" title="Capture all cameras and assess with Gemini">Assess Camera Positions</button>
          </div>
          <div id="geminiAssessStatus" style="font-family:var(--mono);font-size:9px;color:var(--text-dim);padding:4px 0;display:none;">
          </div>
          <div id="geminiAssessPreviews" style="display:none;margin-top:6px;">
            <div style="font-weight:600;color:var(--text-dim);margin-bottom:4px">Camera Captures</div>
            <div style="display:flex;gap:4px;">
              <div style="flex:1;text-align:center;"><div style="font-size:8px;color:var(--text-dim)">Cam 0</div><img id="geminiPreview0" style="width:100%;border-radius:3px;border:1px solid #334;"></div>
              <div style="flex:1;text-align:center;"><div style="font-size:8px;color:var(--text-dim)">Cam 1</div><img id="geminiPreview1" style="width:100%;border-radius:3px;border:1px solid #334;"></div>
              <div style="flex:1;text-align:center;"><div style="font-size:8px;color:var(--text-dim)">Cam 2</div><img id="geminiPreview2" style="width:100%;border-radius:3px;border:1px solid #334;"></div>
            </div>
          </div>
          <div id="geminiAssessResult" style="display:none;margin-top:6px;padding:6px;background:#0d1525;border:1px solid #334;border-radius:4px;max-height:300px;overflow-y:auto;">
          </div>
        </div>
      </details>
    </div>
    <div style="flex:1"></div>
    <div class="sim-execute-bar">
      <button class="btn-execute sim-mode" id="simBtnExecute">
        Send to Arm
      </button>
    </div>
  </div>
</div>
</div><!-- /panel-simulator -->

<!-- ============================================================ -->
<!-- PANEL: Cameras (dedicated full-page camera view)              -->
<!-- ============================================================ -->
<div class="panel" id="panel-cameras">
  <div class="panel-body">
    <div class="panel-header">üì∑ Camera Feeds</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:12px;">
      <div class="panel-card" id="camFullCard0"><h3>Camera 0</h3><img id="camFull0" style="width:100%;background:#0d1525;border-radius:4px;" alt="Cam 0"><div style="margin-top:6px;display:flex;gap:6px;"><button class="btn" onclick="window.open(`http://${location.hostname}:8081/snap/0`,'_blank')">üì∑ Snap</button></div></div>
      <div class="panel-card" id="camFullCard1"><h3>Camera 1</h3><img id="camFull1" style="width:100%;background:#0d1525;border-radius:4px;" alt="Cam 1"><div style="margin-top:6px;display:flex;gap:6px;"><button class="btn" onclick="window.open(`http://${location.hostname}:8081/snap/1`,'_blank')">üì∑ Snap</button></div></div>
      <div class="panel-card" id="camFullCard2"><h3>Camera 2</h3><img id="camFull2" style="width:100%;background:#0d1525;border-radius:4px;" alt="Cam 2"><div style="margin-top:6px;display:flex;gap:6px;"><button class="btn" onclick="window.open(`http://${location.hostname}:8081/snap/2`,'_blank')">üì∑ Snap</button></div></div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Visual Servo                                           -->
<!-- ============================================================ -->
<div class="panel" id="panel-visual-servo">
  <div class="panel-body">
    <div class="panel-header">üéØ Visual Servo</div>
    <div class="panel-grid">
      <div class="panel-card">
        <h3>Overhead Servo</h3>
        <p style="font-size:0.85em;color:#aaa;margin:4px 0 0;">Color-based detection via overhead camera. Moves gripper to target object using proportional control.</p>
        <div class="status-indicator stopped" id="vsOverheadStatus">STOPPED</div>
        <div class="form-row" style="margin-top:8px;">
          <label>Target</label><input type="text" id="vsOhTarget" value="redbull" placeholder="e.g. redbull">
        </div>
        <div class="form-row">
          <label>Camera</label>
          <select id="vsOhCam"><option value="1">Camera 1 (Overhead)</option><option value="0">Camera 0</option><option value="2">Camera 2</option></select>
        </div>
        <div class="btn-row" style="margin-top:8px;">
          <button class="btn primary" onclick="vsStart('overhead')">‚ñ∂ START</button>
          <button class="btn danger" onclick="vsStop('overhead')">‚èπ STOP</button>
          <button class="btn" onclick="vsStatus('overhead')">‚Üª STATUS</button>
        </div>
        <div class="result-box" id="vsOverheadResult" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="panel-card">
        <h3>Approach Servo</h3>
        <p style="font-size:0.85em;color:#aaa;margin:4px 0 0;">LLM-guided approach using Gemini. Moves arm step-by-step toward a described target.</p>
        <div class="status-indicator stopped" id="vsApproachStatus">STOPPED</div>
        <div class="form-row" style="margin-top:8px;">
          <label>Target</label><input type="text" id="vsApTarget" value="red bull can" placeholder="e.g. red bull can">
        </div>
        <div class="form-row">
          <label>Max Steps</label><input type="number" id="vsApMaxSteps" value="25" min="1" max="100">
        </div>
        <div class="btn-row" style="margin-top:8px;">
          <button class="btn primary" onclick="vsStart('approach')">‚ñ∂ START</button>
          <button class="btn danger" onclick="vsStop('approach')">‚èπ STOP</button>
          <button class="btn" onclick="vsStatus('approach')">‚Üª STATUS</button>
        </div>
        <div class="result-box" id="vsApproachResult" style="margin-top:8px;display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Multi-view Pick                                        -->
<!-- ============================================================ -->
<div class="panel" id="panel-multiview-pick">
  <div class="panel-body">
    <div class="panel-header">ü§è Multi-view Pick Pipeline</div>
    <div class="panel-card">
      <h3>Pipeline Status</h3>
      <div class="status-indicator stopped" id="mvpStatus">IDLE</div>
      <div class="phase-display" id="mvpPhases" style="margin-top:8px;">
        <div class="phase-chip" data-phase="detect">1. Detect</div>
        <div class="phase-chip" data-phase="plan">2. Plan</div>
        <div class="phase-chip" data-phase="approach">3. Approach</div>
        <div class="phase-chip" data-phase="servo">4. Servo</div>
        <div class="phase-chip" data-phase="grasp">5. Grasp</div>
        <div class="phase-chip" data-phase="retreat">6. Retreat</div>
      </div>
      <div class="form-row" style="margin-top:8px;">
        <label>Target</label><input type="text" id="mvpTarget" placeholder="Object to pick (e.g., red block)">
      </div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn primary" onclick="mvpStart()">‚ñ∂ START PICK</button>
        <button class="btn danger" onclick="mvpStop()">‚èπ ABORT</button>
        <button class="btn" onclick="mvpRefresh()">‚Üª STATUS</button>
      </div>
      <div class="result-box" id="mvpResult" style="margin-top:8px;display:none;"></div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Pick Planner                                           -->
<!-- ============================================================ -->
<div class="panel" id="panel-pick-planner">
  <div class="panel-body">
    <div class="panel-header">üìê Pick Planner</div>
    <div class="panel-grid">
      <div class="panel-card">
        <h3>Detect Objects</h3>
        <div class="form-row">
          <label>Target</label>
          <input type="text" id="ppDetectTarget" placeholder="redbull" value="redbull">
        </div>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn primary" onclick="ppDetect()">üîç DETECT</button>
        </div>
        <div class="result-box" id="ppDetectResult" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="panel-card">
        <h3>Plan Pick</h3>
        <div class="form-row">
          <label>Target</label><input type="text" id="ppTarget" placeholder="redbull" value="redbull">
        </div>
        <div class="form-row" style="margin-top:4px;">
          <label>Pos (mm)</label>
          <input type="number" id="ppPosX" placeholder="X" style="width:60px;">
          <input type="number" id="ppPosY" placeholder="Y" style="width:60px;">
          <input type="number" id="ppPosZ" placeholder="Z" style="width:60px;">
        </div>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn primary" onclick="ppPlan()">üìã PLAN</button>
          <button class="btn" onclick="ppFromPos()">üìç FROM POSITION</button>
        </div>
        <div class="result-box" id="ppPlanResult" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="panel-card">
        <h3>Camera-Arm Calibration</h3>
        <button class="btn primary" onclick="ppCalibrate()">üéØ CALIBRATE</button>
        <div class="result-box" id="ppCalibResult" style="margin-top:8px;display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: VLA Agent                                              -->
<!-- ============================================================ -->
<div class="panel" id="panel-vla">
  <div class="panel-body">
    <div class="panel-header">üß† Vision-Language-Action Agent</div>
    <div class="panel-grid">
      <div class="panel-card">
        <h3>VLA Status</h3>
        <div class="status-indicator stopped" id="vlaStatus">UNKNOWN</div>
        <button class="btn" onclick="vlaRefreshStatus()" style="margin-top:6px;">‚Üª REFRESH</button>
      </div>
      <div class="panel-card">
        <h3>Execute Action</h3>
        <div class="form-row">
          <label>Prompt</label><input type="text" id="vlaPrompt" placeholder="Pick up the red object" style="flex:2">
        </div>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn primary" onclick="vlaAct()">üöÄ ACT</button>
          <button class="btn" onclick="vlaPreviewCams()">üëÅ PREVIEW</button>
          <button class="btn danger" onclick="apiPost('/api/vla/abort').then(d=>showResult('vlaActResult',d))">‚õî ABORT</button>
        </div>
        <div id="vlaCamPreview" style="display:none;margin-top:8px;">
          <div style="display:flex;gap:6px;">
            <div style="flex:1;text-align:center"><span style="font-size:9px;color:var(--text-dim)">Camera 0</span><img id="vlaCam0Img" style="width:100%;border-radius:4px;border:1px solid var(--card-border)" alt="Cam 0"></div>
            <div style="flex:1;text-align:center"><span style="font-size:9px;color:var(--text-dim)">Camera 1</span><img id="vlaCam1Img" style="width:100%;border-radius:4px;border:1px solid var(--card-border)" alt="Cam 1"></div>
          </div>
        </div>
        <div class="result-box" id="vlaActResult" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="panel-card">
        <h3>Demonstrations</h3>
        <div class="form-row">
          <label>Task</label><input type="text" id="vlaDemoTask" placeholder="Task name">
        </div>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn primary" onclick="vlaDemoStart()">‚è∫ COLLECT</button>
          <button class="btn danger" onclick="vlaDemoStop()">‚èπ STOP</button>
          <button class="btn" onclick="vlaDemoList()">üìã LIST</button>
        </div>
        <div class="result-box" id="vlaDemoResult" style="margin-top:8px;display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Workspace Calibration                                  -->
<!-- ============================================================ -->
<div class="panel" id="panel-bifocal">
  <div class="panel-body">
    <div class="panel-header">üîç Workspace Calibration</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;">
      <div class="panel-card" id="wsCalibCam0">
        <h3>Camera 0 ‚Äî Overhead</h3>
        <img id="wsCalibImg0" style="width:100%;background:#0d1525;border-radius:4px;" alt="Cam 0">
        <div style="margin-top:6px;display:flex;gap:6px;">
          <button class="btn" onclick="window.open(`http://${location.hostname}:8081/snap/0`,'_blank')">Snap</button>
        </div>
      </div>
      <div class="panel-card" id="wsCalibCam1">
        <h3>Camera 1 ‚Äî Arm</h3>
        <img id="wsCalibImg1" style="width:100%;background:#0d1525;border-radius:4px;" alt="Cam 1">
        <div style="margin-top:6px;display:flex;gap:6px;">
          <button class="btn" onclick="window.open(`http://${location.hostname}:8081/snap/1`,'_blank')">Snap</button>
        </div>
      </div>
      <div class="panel-card" id="wsCalibCam2">
        <h3>Camera 2 ‚Äî Side</h3>
        <img id="wsCalibImg2" style="width:100%;background:#0d1525;border-radius:4px;" alt="Cam 2">
        <div style="margin-top:6px;display:flex;gap:6px;">
          <button class="btn" onclick="window.open(`http://${location.hostname}:8081/snap/2`,'_blank')">Snap</button>
        </div>
      </div>
    </div>
    <div class="panel-grid" style="margin-top:12px;">
      <div class="panel-card">
        <h3>Scale Calibration</h3>
        <p style="font-size:11px;color:#888;margin:4px 0;">Place a checkerboard in view of the overhead camera, then calibrate to establish pixel-to-mm scale.</p>
        <div class="form-row" style="margin-top:6px;">
          <label>Square size (mm)</label>
          <input type="number" id="wsCalibSquareMm" value="25" min="1" max="100" step="0.1" style="width:80px;">
        </div>
        <div class="btn-row" style="margin-top:8px;">
          <button class="btn primary" onclick="wsCalibScale()">CALIBRATE</button>
          <button class="btn" onclick="wsCalibPreview()">PREVIEW</button>
        </div>
        <div class="result-box" id="wsCalibResult" style="margin-top:8px;display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Object Detection                                       -->
<!-- ============================================================ -->
<div class="panel" id="panel-object-detect">
  <div class="panel-body">
    <div class="panel-header">Object Detection & Mapping</div>

    <!-- Top row: Controls -->
    <div class="panel-card" style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <h3 style="margin:0;">Detection Control</h3>
        <div class="status-indicator stopped" id="objDetectPanelStatus" style="margin:0;">OFF</div>
        <div class="btn-row" style="margin:0;">
          <button class="btn primary" id="objPanelEnable" onclick="objPanelToggle()">ENABLE</button>
          <button class="btn primary" id="objPanelDetect" onclick="objPanelRunDetect()" disabled>DETECT NOW</button>
          <button class="btn" onclick="objPanelClear()">CLEAR</button>
        </div>
        <span style="font-family:var(--mono);font-size:11px;color:var(--text-dim);">
          Total: <span id="objPanelTotal">0</span> |
          Reachable: <span id="objPanelReachable" style="color:var(--success)">0</span>
        </span>
      </div>
    </div>

    <!-- Main content: Camera overlay + Workspace map side by side -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">

      <!-- Camera Overlay View -->
      <div class="panel-card">
        <h3>Camera Detection View</h3>
        <div id="objDetectCamView" style="position:relative;background:#0a0f1a;border-radius:4px;overflow:hidden;min-height:300px;display:flex;align-items:center;justify-content:center;">
          <div id="objDetectCamPlaceholder" style="text-align:center;color:#445;font-family:var(--mono);font-size:11px;padding:20px;">
            Enable detection and click DETECT NOW<br>to see camera overlay with detected objects
          </div>
          <img id="objDetectCamImg" style="width:100%;display:none;border-radius:4px;" alt="Detection overlay">
        </div>
        <p style="font-family:var(--mono);font-size:9px;color:var(--text-dim);margin-top:6px;line-height:1.4;">
          Overhead camera (cam1) with bounding boxes, circles, and labels for each detected object.
          <strong style="color:var(--success)">Green</strong> = within reach |
          <strong style="color:var(--warning)">Orange</strong> = out of reach
        </p>
      </div>

      <!-- 2D Workspace Map -->
      <div class="panel-card">
        <h3>Workspace Map</h3>
        <div style="position:relative;background:#0a0f1a;border-radius:4px;overflow:hidden;">
          <canvas id="objDetectWorkspaceCanvas" width="400" height="400" style="width:100%;display:block;"></canvas>
        </div>
        <p style="font-family:var(--mono);font-size:9px;color:var(--text-dim);margin-top:6px;line-height:1.4;">
          Top-down workspace view. Circle = arm reach (550mm).
          Objects shown at their detected positions with labels and distances.
        </p>
      </div>
    </div>

    <!-- Object list -->
    <div class="panel-card">
      <h3>Detected Objects</h3>
      <div class="result-box" id="objPanelList" style="max-height:200px;">No objects detected</div>
    </div>

    <!-- Scan & Review Workflow -->
    <div class="panel-card" style="margin-top:10px;">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <h3 style="margin:0;">Scan & Review</h3>
        <button class="btn primary" id="btnScanTable" style="font-size:12px;padding:8px 16px;font-weight:700;letter-spacing:1px">üîç SCAN TABLE</button>
        <button class="btn" id="btnAcceptDetections" style="display:none">‚úì Accept & Update</button>
      </div>
    </div>

    <!-- Review Panel (hidden until scan) -->
    <div id="scanReviewPanel" style="display:none;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
        <div class="panel-card">
          <h3>Overhead (Annotated)</h3>
          <img id="scanOverheadImg" style="width:100%;background:#0a0f1a;border-radius:4px;" alt="Overhead">
        </div>
        <div class="panel-card">
          <h3>Side Camera</h3>
          <img id="scanSideImg" style="width:100%;background:#0a0f1a;border-radius:4px;" alt="Side">
        </div>
      </div>
      <div class="panel-card">
        <h3>Detected Objects</h3>
        <div id="scanObjectTable" style="font-family:var(--mono);font-size:11px;max-height:250px;overflow-y:auto;"></div>
      </div>
    </div>

    <!-- Detection Log -->
    <div class="panel-card" style="margin-top:10px;">
      <h3>Detection Log</h3>
      <div id="detectionLog" style="font-family:var(--mono);font-size:10px;max-height:120px;overflow-y:auto;color:var(--text-dim);line-height:1.6;">No scans yet</div>
    </div>

    <!-- Simulator Integration -->
    <div class="panel-card" style="margin-top:10px;">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <h3 style="margin:0;">Simulator Integration</h3>
        <div class="btn-row" style="margin:0;">
          <button class="btn primary" onclick="objPanelSyncToSim()">Sync to 3D Simulator</button>
          <button class="btn" onclick="showPanel(document.querySelector('[data-panel=simulator]'))">Open Simulator</button>
        </div>
        <span style="font-family:var(--mono);font-size:10px;color:var(--text-dim);">
          Detected objects are synced to the 3D simulator for pick practice
        </span>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: 3D Scan                                                -->
<!-- ============================================================ -->
<div class="panel" id="panel-scan3d">
  <div class="panel-body">
    <div class="panel-header">üì° 3D Scan</div>
    <div class="panel-card">
      <h3>Scan Control</h3>
      <div class="status-indicator stopped" id="scan3dStatus">IDLE</div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn primary" onclick="scan3dStart()">‚ñ∂ START SCAN</button>
        <button class="btn danger" onclick="scan3dStop()">‚èπ STOP</button>
        <button class="btn" onclick="scan3dRefresh()">‚Üª STATUS</button>
      </div>
      <div class="result-box" id="scan3dResult" style="margin-top:8px;display:none;"></div>
    </div>
    <div class="panel-card">
      <h3>Scan History</h3>
      <button class="btn" onclick="scan3dList()">üìã LIST SCANS</button>
      <div class="result-box" id="scan3dListResult" style="margin-top:8px;display:none;"></div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Calibration Dashboard                                  -->
<!-- ============================================================ -->
<div class="panel" id="panel-calibration">
  <div class="panel-body">
    <div class="panel-header">Calibration</div>

    <!-- ===== STATUS OVERVIEW ===== -->
    <div id="calibHealthCard" class="panel-card" style="margin-bottom:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
        <div>
          <h3 style="margin:0;">System Status</h3>
          <div id="calibHealthSummary" style="font-size:13px;color:#888;margin-top:4px;">Checking...</div>
        </div>
        <div id="calibHealthScore" style="font-size:28px;font-weight:bold;color:#888;">--</div>
      </div>
      <div id="calibHealthItems" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:12px;"></div>
      <button class="btn" onclick="calibCheckHealth()" style="margin-top:10px;">Refresh Status</button>
    </div>

    <!-- ===== STEP-BY-STEP CALIBRATION ===== -->
    <div class="panel-card" style="margin-bottom:12px;">
      <h3>Calibrate</h3>
      <p style="font-size:12px;color:#888;margin:4px 0 10px;">Run each step in order. Green steps are already done and can be skipped.</p>
      <div style="display:flex;flex-direction:column;gap:8px;">

        <div id="calibStep1" style="display:flex;align-items:center;gap:10px;padding:8px;background:#1a1a2e;border-radius:6px;">
          <span id="calibStep1Icon" style="font-size:18px;width:24px;text-align:center;">1</span>
          <div style="flex:1;">
            <div style="font-weight:bold;font-size:13px;">Camera Intrinsics</div>
            <div style="font-size:11px;color:#888;">Calibrate lens parameters for all 3 cameras</div>
          </div>
          <button class="btn primary" onclick="calibRunIntrinsics()" id="btnCalibStep1">Run</button>
        </div>

        <div id="calibStep2" style="display:flex;align-items:center;gap:10px;padding:8px;background:#1a1a2e;border-radius:6px;">
          <span id="calibStep2Icon" style="font-size:18px;width:24px;text-align:center;">2</span>
          <div style="flex:1;">
            <div style="font-weight:bold;font-size:13px;">Joint Mapping</div>
            <div style="font-size:11px;color:#888;">Detect which software joint controls which physical joint</div>
          </div>
          <button class="btn primary" onclick="jmStart()" id="btnCalibStep2">Run</button>
        </div>

        <div id="calibStep3" style="display:flex;align-items:center;gap:10px;padding:8px;background:#1a1a2e;border-radius:6px;">
          <span id="calibStep3Icon" style="font-size:18px;width:24px;text-align:center;">3</span>
          <div style="flex:1;">
            <div style="font-weight:bold;font-size:13px;">Camera Extrinsics</div>
            <div style="font-size:11px;color:#888;">Determine camera positions relative to the arm</div>
          </div>
          <button class="btn primary" onclick="charucoStart()" id="btnCalibStep3">Run</button>
        </div>
      </div>

      <!-- Unified progress area -->
      <div id="calibProgress" style="margin-top:10px;display:none;">
        <div class="status-indicator running" id="calibProgressStatus">RUNNING...</div>
        <div style="background:#333;border-radius:4px;overflow:hidden;height:20px;margin-top:6px;">
          <div id="calibProgressBar" style="background:#4CAF50;height:100%;width:0%;transition:width 0.3s;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;"></div>
        </div>
        <button class="btn danger" onclick="calibStopCurrent()" style="margin-top:6px;">Stop</button>
      </div>
      <div class="result-box" id="calibStepResult" style="margin-top:8px;display:none;"></div>
    </div>

    <!-- ===== ADVANCED (COLLAPSED) ===== -->
    <div class="panel-card" style="margin-bottom:0;">
      <div style="display:flex;align-items:center;cursor:pointer;gap:6px;" onclick="document.getElementById('calibAdvanced').style.display=document.getElementById('calibAdvanced').style.display==='none'?'block':'none'; this.querySelector('.adv-arrow').textContent=document.getElementById('calibAdvanced').style.display==='none'?'\u25B6':'\u25BC';">
        <span class="adv-arrow" style="font-size:11px;">&#9654;</span>
        <h3 style="margin:0;">Advanced</h3>
        <span style="font-size:11px;color:#666;margin-left:4px;">Individual tools, results, diagnostics</span>
      </div>
      <div id="calibAdvanced" style="display:none;margin-top:12px;">
        <div class="panel-grid">

          <div class="panel-card">
            <h3>Calibration Runs</h3>
            <div class="btn-row">
              <button class="btn primary" onclick="calibStartRun('overhead')">Overhead</button>
              <button class="btn primary" onclick="calibStartRun('side')">Side</button>
              <button class="btn danger" onclick="calibStopRun()">Stop</button>
            </div>
            <div class="status-indicator stopped" id="calibRunStatus" style="margin-top:8px;">IDLE</div>
            <div class="result-box" id="calibRunResult" style="margin-top:8px;display:none;"></div>
          </div>

          <div class="panel-card">
            <h3>Results</h3>
            <div class="btn-row">
              <button class="btn" onclick="calibListResults()">List</button>
              <button class="btn" onclick="calibViewReport()">Report</button>
            </div>
            <div class="result-box" id="calibResultsBox" style="margin-top:8px;display:none;"></div>
          </div>

          <div class="panel-card">
            <h3>Frame Viewer</h3>
            <div class="form-row">
              <label>Session</label><input type="text" id="calibFrameSession" placeholder="Session ID">
            </div>
            <button class="btn" onclick="calibViewFrames()" style="margin-top:6px;">View Frames</button>
            <div id="calibFrameContainer" style="margin-top:8px;display:flex;gap:4px;flex-wrap:wrap;"></div>
          </div>

          <div class="panel-card">
            <h3>Extrinsics</h3>
            <button class="btn" onclick="calibViewExtrinsics()">View</button>
            <div class="result-box" id="calibExtrinsicsResult" style="margin-top:8px;display:none;"></div>
          </div>

          <div class="panel-card">
            <h3>Viz Calibration</h3>
            <button class="btn primary" id="btnCalibrateViz" title="Move arm through ~20 poses to calibrate visualization">Calibrate Viz</button>
            <div class="result-box" id="vizCalibResult" style="margin-top:8px;display:none;"></div>
          </div>

          <div class="panel-card">
            <h3>ChArUco Calibration</h3>
            <div class="btn-row">
              <button class="btn primary" onclick="charucoStart()">Start</button>
              <button class="btn danger" onclick="charucoStop()">Stop</button>
            </div>
            <div class="status-indicator stopped" id="charucoStatus" style="margin-top:8px;">IDLE</div>
            <div class="result-box" id="charucoResult" style="margin-top:8px;display:none;"></div>
          </div>

          <div class="panel-card">
            <h3>Compare Calibrations</h3>
            <button class="btn" onclick="calibCompare()">Compare</button>
            <div class="result-box" id="calibCompareResult" style="margin-top:8px;display:none;"></div>
          </div>

          <div class="panel-card" style="grid-column: 1 / -1;">
            <h3>Intrinsic Calibration</h3>
            <div class="form-row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:end;">
              <div>
                <label>Camera</label>
                <select id="icalCamId" style="width:100px;">
                  <option value="0">cam0 ‚Äî overhead</option>
                  <option value="1">cam1 ‚Äî arm</option>
                  <option value="2">cam2 ‚Äî side</option>
                </select>
              </div>
              <div>
                <label>Board W√óH</label>
                <div style="display:flex;gap:4px;">
                  <input type="number" id="icalBoardW" value="8" min="3" max="20" style="width:50px;">
                  <span style="line-height:28px;">√ó</span>
                  <input type="number" id="icalBoardH" value="5" min="3" max="20" style="width:50px;">
                </div>
              </div>
              <div>
                <label>Square (mm)</label>
                <input type="number" id="icalSquareMm" value="19" min="1" max="100" step="0.1" style="width:60px;">
              </div>
              <div>
                <label>Frames</label>
                <input type="number" id="icalNumFrames" value="10" min="3" max="50" style="width:60px;">
              </div>
              <button class="btn primary" onclick="icalStart()">Calibrate</button>
              <button class="btn primary" onclick="icalStartAll()">All Cams</button>
              <button class="btn" onclick="icalValidate()">Validate</button>
            </div>
            <div style="margin-top:8px;">
              <div class="status-indicator stopped" id="icalStatus">IDLE</div>
            </div>
            <div class="result-box" id="icalResult" style="margin-top:8px;display:none;"></div>
          </div>

          <div class="panel-card" style="grid-column: 1 / -1;">
            <h3>Joint Mapping</h3>
            <div class="btn-row">
              <button class="btn primary" id="btnJmStart" onclick="jmStart()">Start</button>
              <button class="btn danger" onclick="jmStop()">Stop</button>
            </div>
            <div class="status-indicator stopped" id="jmStatus" style="margin-top:8px;">IDLE</div>
            <div id="jmProgress" style="margin-top:8px;display:none;">
              <div style="background:#333;border-radius:4px;overflow:hidden;height:20px;">
                <div id="jmProgressBar" style="background:#2196F3;height:100%;width:0%;transition:width 0.3s;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;"></div>
              </div>
            </div>
            <table id="jmResultsTable" style="margin-top:8px;display:none;width:100%;font-size:12px;border-collapse:collapse;">
              <thead>
                <tr style="border-bottom:1px solid #444;">
                  <th style="text-align:left;padding:4px;">DDS Index</th>
                  <th style="text-align:left;padding:4px;">Moved?</th>
                  <th style="text-align:left;padding:4px;">Diff Score</th>
                  <th style="text-align:left;padding:4px;">Region</th>
                  <th style="text-align:left;padding:4px;">Suggested Label</th>
                </tr>
              </thead>
              <tbody id="jmResultsBody"></tbody>
            </table>
            <div id="jmApplySection" style="margin-top:8px;display:none;">
              <h4 style="margin:8px 0 4px;">Edit Mapping (UI Joint ‚Üí DDS Index)</h4>
              <div id="jmMappingEditors" style="display:grid;grid-template-columns:1fr 1fr;gap:4px;"></div>
              <button class="btn primary" onclick="jmApply()" style="margin-top:8px;">Apply Mapping</button>
            </div>
            <div class="result-box" id="jmApplyResult" style="margin-top:8px;display:none;"></div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Debug Pipeline                                         -->
<!-- ============================================================ -->
<div class="panel" id="panel-debug">
  <div class="panel-body" style="padding:0;">
    <div style="padding:12px 16px;display:flex;align-items:center;gap:8px;">
      <span class="panel-header" style="margin:0;">üîß Debug Pipeline</span>
      <button class="btn" id="btnDebug">ENABLE</button>
    </div>
    <div class="debug-panel" id="debugPanel">
      <div class="debug-section">
        <div class="debug-title">Pipeline</div>
        <div class="debug-pipeline" id="debugPipeline">
          <div class="pipe-stage" data-stage="CMD_SENT"><div class="pipe-dot"></div><div class="pipe-label">CMD</div><div class="pipe-latency" id="plCmd">‚Äî</div></div>
          <div class="pipe-arrow">‚Üí</div>
          <div class="pipe-stage" data-stage="DDS_PUBLISH"><div class="pipe-dot"></div><div class="pipe-label">DDS TX</div><div class="pipe-latency" id="plDdsTx">‚Äî</div></div>
          <div class="pipe-arrow">‚Üí</div>
          <div class="pipe-stage" data-stage="DDS_RECEIVE"><div class="pipe-dot"></div><div class="pipe-label">ARM RX</div><div class="pipe-latency" id="plArmRx">‚Äî</div></div>
          <div class="pipe-arrow">‚Üí</div>
          <div class="pipe-stage" data-stage="CMD_EXEC"><div class="pipe-dot"></div><div class="pipe-label">EXEC</div><div class="pipe-latency" id="plExec">‚Äî</div></div>
          <div class="pipe-arrow">‚Üí</div>
          <div class="pipe-stage" data-stage="STATE_UPDATE"><div class="pipe-dot"></div><div class="pipe-label">STATE</div><div class="pipe-latency" id="plState">‚Äî</div></div>
          <div class="pipe-arrow">‚Üí</div>
          <div class="pipe-stage" data-stage="WS_SEND"><div class="pipe-dot"></div><div class="pipe-label">WS TX</div><div class="pipe-latency" id="plWsTx">‚Äî</div></div>
          <div class="pipe-arrow">‚Üí</div>
          <div class="pipe-stage" data-stage="UI"><div class="pipe-dot"></div><div class="pipe-label">UI</div><div class="pipe-latency" id="plUi">‚Äî</div></div>
        </div>
      </div>
      <div class="debug-section">
        <div class="debug-title">Stats</div>
        <div class="debug-stats" id="debugStats">
          <div class="stat-group"><div class="stat-header">DDS</div><div class="stat-row"><span>TX rate</span><span id="dsTxRate">N/A</span></div><div class="stat-row"><span>RX rate</span><span id="dsRxRate">N/A</span></div><div class="stat-row"><span>Last RX age</span><span id="dsRxAge">N/A</span></div></div>
          <div class="stat-group"><div class="stat-header">Cameras</div><div class="stat-row"><span>C0 FPS</span><span id="dsC0Fps">N/A</span></div><div class="stat-row"><span>C1 FPS</span><span id="dsC1Fps">N/A</span></div><div class="stat-row"><span>Motion</span><span id="dsMotion">N/A</span></div></div>
          <div class="stat-group"><div class="stat-header">WebSocket</div><div class="stat-row"><span>Send rate</span><span id="dsWsSend">N/A</span></div><div class="stat-row"><span>Latency</span><span id="dsWsLat">N/A</span></div><div class="stat-row"><span>RX interval</span><span id="dsWsRxInt">N/A</span></div></div>
          <div class="stat-group"><div class="stat-header">Latency</div><div class="stat-row"><span>Cmd‚ÜíAck</span><span id="dsLatCmdAck">N/A</span></div><div class="stat-row"><span>Ack‚ÜíExec</span><span id="dsLatAckExec">N/A</span></div><div class="stat-row"><span>End-to-end</span><span id="dsLatE2e">N/A</span></div></div>
        </div>
      </div>
      <div class="debug-section">
        <div class="debug-title">Event Stream</div>
        <div class="debug-events" id="debugEvents"></div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Diagnostics                                            -->
<!-- ============================================================ -->
<div class="panel" id="panel-diagnostics">
  <div class="panel-body">
    <div class="panel-header">ü©∫ Diagnostics</div>
    <div class="panel-grid">
      <div class="panel-card">
        <h3>Feedback Monitor</h3>
        <button class="btn primary" onclick="diagFeedback()">üì° QUERY</button>
        <div class="result-box" id="diagFeedbackResult" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="panel-card">
        <h3>Smoother Status</h3>
        <button class="btn primary" onclick="diagSmoother()">üì° QUERY</button>
        <div class="result-box" id="diagSmootherResult" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="panel-card">
        <h3>GPU Status</h3>
        <button class="btn primary" onclick="diagGpu()">üì° QUERY</button>
        <div class="result-box" id="diagGpuResult" style="margin-top:8px;display:none;"></div>
      </div>
    </div>
  </div>
</div>


<!-- ============================================================ -->
<!-- PANEL: Object Locator                                         -->
<!-- ============================================================ -->
<div class="panel" id="panel-locate">
  <div class="panel-body">
    <div class="panel-header">üîé Object Locator</div>
    <div class="panel-card">
      <div class="form-row">
        <label>Target</label><input type="text" id="locateTarget" placeholder="Object to find (e.g., red ball)">
      </div>
      <div class="form-row">
        <label>Camera</label>
        <select id="locateCam"><option value="1">Camera 1</option><option value="0">Camera 0</option><option value="2">Camera 2</option></select>
      </div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn primary" onclick="locateObject()">üîç LOCATE</button>
      </div>
      <div class="result-box" id="locateResult" style="margin-top:8px;display:none;"></div>
      <div style="margin-top:8px;">
        <img id="locatePreview" style="max-width:100%;border-radius:4px;display:none;" alt="Location preview">
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Scene Analysis                                         -->
<!-- ============================================================ -->
<div class="panel" id="panel-scene-analysis">
  <div class="panel-body">
    <div class="panel-header">üëÅ Scene Analysis</div>
    <div class="panel-card">
      <div class="form-row">
        <label>Camera</label>
        <select id="sceneCam"><option value="1">Camera 1</option><option value="0">Camera 0</option><option value="2">Camera 2</option></select>
      </div>
      <div class="form-row">
        <label>Prompt</label><input type="text" id="scenePrompt" placeholder="What do you see? (optional)">
      </div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn primary" onclick="sceneAnalyze()">üëÅ ANALYZE</button>
      </div>
      <div class="result-box" id="sceneResult" style="margin-top:8px;display:none;"></div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Claw Prediction                                        -->
<!-- ============================================================ -->
<div class="panel" id="panel-claw-prediction">
  <div class="panel-body">
    <div class="panel-header">ü¶Ä Claw Prediction</div>
    <div class="panel-grid">
      <div class="panel-card">
        <h3>Toggle</h3>
        <div class="status-indicator stopped" id="clawPredStatus">OFF</div>
        <div class="btn-row" style="margin-top:8px;">
          <button class="btn primary" onclick="clawPredToggle(true)">ENABLE</button>
          <button class="btn danger" onclick="clawPredToggle(false)">DISABLE</button>
        </div>
      </div>
      <div class="panel-card">
        <h3>HSV Config</h3>
        <div class="form-row"><label>H Low</label><input type="number" id="cpHL" value="0" min="0" max="179"></div>
        <div class="form-row"><label>H High</label><input type="number" id="cpHH" value="179" min="0" max="179"></div>
        <div class="form-row"><label>S Low</label><input type="number" id="cpSL" value="0" min="0" max="255"></div>
        <div class="form-row"><label>S High</label><input type="number" id="cpSH" value="255" min="0" max="255"></div>
        <div class="form-row"><label>V Low</label><input type="number" id="cpVL" value="0" min="0" max="255"></div>
        <div class="form-row"><label>V High</label><input type="number" id="cpVH" value="255" min="0" max="255"></div>
        <button class="btn primary" onclick="clawPredSaveHSV()" style="margin-top:6px;">üíæ SAVE HSV</button>
      </div>
      <div class="panel-card">
        <h3>ROI Config</h3>
        <button class="btn" onclick="clawPredGetROI()">üìã GET ROI</button>
        <div class="result-box" id="cpRoiResult" style="margin-top:8px;display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: ASCII Video                                            -->
<!-- ============================================================ -->
<div class="panel" id="panel-ascii">
  <div class="ascii-tab-wrap">
    <div class="ascii-controls-bar">
      <label>CHARS</label>
      <select id="ascCharset"><option value="standard">Standard</option><option value="detailed">Detailed</option><option value="blocks">Blocks</option><option value="minimal">Minimal</option></select>
      <label>W</label><input type="number" id="ascWidth" value="320" min="20" max="500" step="10">
      <label>H</label><input type="number" id="ascHeight" value="140" min="10" max="300" step="5">
      <button class="ascii-toggle" id="ascColor">COLOR</button>
      <button class="ascii-toggle on" id="ascInvert">INVERT</button>
      <button class="ascii-toggle" id="ascPause">PAUSE</button>
      <button class="ascii-toggle" id="ascFkOverlay" title="Show FK joint overlay on ASCII frames">FK OVERLAY</button>
    </div>
    <div class="ascii-status-bar">
      <span class="ascii-status-dot" id="ascDot0"></span>
      <span>CAM 0</span>
      <span class="ascii-status-dot" id="ascDot1"></span>
      <span>CAM 1</span>
      <span style="flex:1"></span>
      <span id="ascFps">-- fps</span>
    </div>
    <div class="ascii-viewport" id="asciiViewport">
      <div class="ascii-pane">
        <div class="ascii-pane-label">üì∑ CAM 0 ‚Äî Front</div>
        <pre id="asciiOutput0">Waiting for stream...</pre>
      </div>
      <div class="ascii-divider"></div>
      <div class="ascii-pane">
        <div class="ascii-pane-label">üì∑ CAM 1 ‚Äî Overhead</div>
        <pre id="asciiOutput1">Waiting for stream...</pre>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Factory 3D                                             -->
<!-- ============================================================ -->
<div class="panel" id="panel-factory" style="position:relative;background:#000;">
  <canvas id="factoryCanvas" tabindex="0" style="display:block;width:100%;height:100%;image-rendering:pixelated;outline:none;"></canvas>
</div>

<!-- ============================================================ -->
<!-- PANEL: Real World 3D                                          -->
<!-- ============================================================ -->
<div class="panel" id="panel-realworld" style="position:relative;background:#000;">
  <canvas id="realworldCanvas" tabindex="0" style="display:block;width:100%;height:100%;image-rendering:pixelated;outline:none;"></canvas>
</div>

<!-- ============================================================ -->
<!-- PANEL: Settings                                               -->
<!-- ============================================================ -->
<div class="panel" id="panel-settings">
  <div class="panel-body">
    <div class="panel-header">‚öôÔ∏è Settings</div>
    <div class="panel-grid">
      <div class="panel-card">
        <h3>Simulator</h3>
        <div class="status-indicator stopped" id="simStatus">UNKNOWN</div>
        <div class="btn-row" style="margin-top:8px;">
          <button class="btn primary" onclick="simToggle()">üîÑ TOGGLE SIM/LIVE</button>
          <button class="btn" onclick="simRefresh()">‚Üª STATUS</button>
        </div>
      </div>
      <div class="panel-card">
        <h3>GPU Status</h3>
        <button class="btn primary" onclick="diagGpu()">üì° QUERY GPU</button>
        <div class="result-box" id="settingsGpuResult" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="panel-card">
        <h3>External Pages</h3>
        <div class="btn-row">
          <a href="/telemetry" class="btn" target="_blank" style="text-decoration:none">üìä Telemetry</a>
          <a href="/scan3d.html" class="btn" target="_blank" style="text-decoration:none">‚òÅÔ∏è 3D Scan</a>
          <a href="/map3d.html" class="btn" target="_blank" style="text-decoration:none">üó∫Ô∏è Map 3D</a>
        </div>
      </div>
    </div>

    <!-- Camera Orientation Section -->
    <div class="panel-header" style="margin-top:16px">üì∑ Camera Setup</div>
    <div class="panel-card" id="cameraOrientationCard">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn primary" onclick="camOrientLoad()">üì• Load</button>
        <button class="btn" onclick="camOrientSaveAll()">üíæ Save All</button>
        <button class="btn" onclick="camOrientLoadCalib()" title="Load from calibration extrinsics">üéØ From Calibration</button>
      </div>
      <div id="camOrientContainer"></div>
    </div>

    <!-- Safety & Limits Section -->
    <div class="panel-header" style="margin-top:16px">üõ°Ô∏è Safety & Limits</div>
    <div class="panel-card" style="margin-bottom:12px">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn primary" onclick="limitsLoad()">üì• Load</button>
        <button class="btn" onclick="limitsSave()">üíæ Save</button>
        <button class="btn" onclick="limitsApply()" title="Apply settings without saving to disk">‚ö° Apply Without Save</button>
        <button class="btn" onclick="limitsReset()" style="background:#c0392b;color:#fff">‚Ü∫ Reset Defaults</button>
      </div>
      <div id="limitsContainer" style="display:none">
        <!-- Joint Limits -->
        <h4 style="margin:8px 0 4px;color:var(--accent)">Joint Limits (degrees)</h4>
        <table style="width:100%;border-collapse:collapse;font-size:12px" id="jointLimitsTable">
          <thead><tr style="color:var(--text-secondary)">
            <th style="text-align:left;padding:4px">Joint</th>
            <th style="text-align:left;padding:4px">Min (¬∞)</th>
            <th style="text-align:left;padding:4px">Max (¬∞)</th>
            <th style="text-align:left;padding:4px">Info</th>
          </tr></thead>
          <tbody id="jointLimitsBody"></tbody>
        </table>

        <!-- Torque Proxy -->
        <h4 style="margin:12px 0 4px;color:var(--accent)">Torque Proxy</h4>
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px"
             class="setting-tooltip"
             data-tooltip="Rejects commands when estimated torque load exceeds limit. Formula: |J1| + |J2| √ó factor > limit. Disable if arm handles extended poses safely. Default limit: 150, factor: 0.7.">
          ‚ÑπÔ∏è Hover for details
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;align-items:center">
          <label style="font-size:12px" class="setting-tooltip"
                 data-tooltip="Maximum torque proxy value before commands are rejected. Increase to allow more extended poses. Default: 150.">
            Limit: <input type="number" id="lim_torqueLimit" step="1" style="width:70px;background:var(--bg-darker);color:var(--text-primary);border:1px solid var(--card-border);padding:2px 4px;border-radius:4px">
          </label>
          <label style="font-size:12px" class="setting-tooltip"
                 data-tooltip="Weight factor for J2 (elbow) in the torque formula. Higher = stricter on elbow extension. Default: 0.7.">
            J2 Factor: <input type="number" id="lim_torqueJ2" step="0.05" style="width:70px;background:var(--bg-darker);color:var(--text-primary);border:1px solid var(--card-border);padding:2px 4px;border-radius:4px">
          </label>
          <label style="font-size:12px" class="setting-tooltip"
                 data-tooltip="When disabled, the torque proxy check is skipped entirely. Disable if the arm handles extended poses safely.">
            <input type="checkbox" id="lim_torqueEnabled"> Enabled
          </label>
        </div>

        <!-- Stall Detection -->
        <h4 style="margin:12px 0 4px;color:var(--accent)">Stall Detection</h4>
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px"
             class="setting-tooltip"
             data-tooltip="Detects when a joint fails to reach its target. Increase delay for slow movements. Increase threshold to reduce false positives. Defaults: delay 5.0s, threshold 15.0¬∞.">
          ‚ÑπÔ∏è Hover for details
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;align-items:center">
          <label style="font-size:12px" class="setting-tooltip"
                 data-tooltip="Seconds to wait before checking if joint reached target. Increase for slow movements. Default: 5.0s.">
            Delay (s): <input type="number" id="lim_stallDelay" step="0.5" style="width:70px;background:var(--bg-darker);color:var(--text-primary);border:1px solid var(--card-border);padding:2px 4px;border-radius:4px">
          </label>
          <label style="font-size:12px" class="setting-tooltip"
                 data-tooltip="Degrees of error allowed before declaring a stall. Increase to reduce false positives. Default: 15.0¬∞.">
            Threshold (¬∞): <input type="number" id="lim_stallThresh" step="0.5" style="width:70px;background:var(--bg-darker);color:var(--text-primary);border:1px solid var(--card-border);padding:2px 4px;border-radius:4px">
          </label>
          <label style="font-size:12px" class="setting-tooltip"
                 data-tooltip="When disabled, stall detection is skipped. Useful during calibration or testing.">
            <input type="checkbox" id="lim_stallEnabled"> Enabled
          </label>
        </div>
      </div>
      <div class="result-box" id="limitsResult" style="margin-top:8px;display:none;"></div>
    </div>

    <!-- Pick Config Section -->
    <div class="panel-header" style="margin-top:16px">üéØ Pick Task Configuration</div>
    <div style="margin-bottom:8px">
      <button class="btn primary" onclick="pickCfgLoad()">üì• Load Config</button>
      <button class="btn" onclick="pickCfgSave()">üíæ Save</button>
      <button class="btn" onclick="pickCfgReset()" style="background:#c0392b;color:#fff">‚Ü∫ Reset Defaults</button>
    </div>
    <div id="pickCfgContainer" style="display:none">
      <div id="pickCfgSections"></div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- PANEL: Safety Settings (Comprehensive)                        -->
<!-- ============================================================ -->
<div class="panel" id="panel-safety">
  <div class="panel-body">
    <div class="panel-header">üõ°Ô∏è Comprehensive Safety Settings</div>

    <!-- Presets & Actions Bar -->
    <div class="panel-card" style="margin-bottom:12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span style="font-weight:bold;font-size:13px;margin-right:8px">Presets:</span>
        <button class="btn" onclick="safetyPreset('conservative')" style="background:#27ae60;color:#fff" title="Tighter limits, slower motion, collision detection ON">üü¢ Conservative</button>
        <button class="btn" onclick="safetyPreset('normal')" style="background:#f39c12;color:#fff" title="Default settings ‚Äî balanced safety and usability">üü° Normal</button>
        <button class="btn" onclick="safetyPreset('aggressive')" style="background:#e74c3c;color:#fff" title="Wider limits, faster motion, most checks disabled. USE WITH CAUTION.">üî¥ Aggressive</button>
        <span style="flex:1"></span>
        <button class="btn primary" onclick="safetyLoad()">üì• Load</button>
        <button class="btn" onclick="safetySave()">üíæ Save All</button>
        <button class="btn" onclick="safetyPreset('normal')" style="background:#c0392b;color:#fff">‚Ü∫ Reset Defaults</button>
      </div>
      <div class="result-box" id="safetyResult" style="margin-top:8px;display:none;"></div>
    </div>

    <!-- E-Stop Status -->
    <div class="panel-card" id="safetyEstopCard" style="margin-bottom:12px;display:none">
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:24px">üö®</span>
        <div>
          <div style="font-weight:bold;color:#e74c3c;font-size:14px">EMERGENCY STOP ACTIVE</div>
          <div style="font-size:12px;color:var(--text-secondary)">All commands blocked. Power cycle to reset.</div>
        </div>
      </div>
    </div>

    <div id="safetyContainer" style="display:none">

    <!-- Joint Position Limits -->
    <details class="safety-section" open>
      <summary class="safety-section-title">üìê Joint Position Limits <span class="safety-badge" id="badge-jpl">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          Per-joint min/max angles in degrees. Hardware limits shown for reference. ‚ö†Ô∏è Exceeding hardware limits may damage motors.
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:12px" id="safetyJointTable">
          <thead><tr style="color:var(--text-secondary)">
            <th style="text-align:left;padding:4px">Joint</th>
            <th style="text-align:center;padding:4px">Min (¬∞)</th>
            <th style="text-align:center;padding:4px">Max (¬∞)</th>
            <th style="text-align:center;padding:4px">HW Limit</th>
            <th style="text-align:center;padding:4px">Risk</th>
          </tr></thead>
          <tbody id="safetyJointBody"></tbody>
        </table>
      </div>
    </details>

    <!-- Torque Proxy -->
    <details class="safety-section">
      <summary class="safety-section-title">üí™ Torque Proxy <span class="safety-badge" id="badge-tp">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          Estimates torque load from joint angles: |J1| + |J2| √ó factor. Rejects commands that would overload motors.
          <br>üîß <b>Software safety layer</b> ‚Äî not a D1 hardware feature.
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;align-items:center">
          <label class="safety-field" title="Maximum torque proxy value before rejection. ‚Üë = more permissive, ‚Üì = stricter. Default: 150">
            Limit: <input type="number" id="sf_tp_limit" step="5" class="safety-input">
          </label>
          <label class="safety-field" title="Weight factor for J2 (elbow). ‚Üë = stricter on elbow extension. Default: 0.7">
            J2 Factor: <input type="number" id="sf_tp_j2" step="0.05" class="safety-input">
          </label>
          <label class="safety-field" title="When OFF, torque proxy check is skipped entirely.">
            <input type="checkbox" id="sf_tp_enabled"> Enabled
          </label>
        </div>
      </div>
    </details>

    <!-- Stall Detection -->
    <details class="safety-section">
      <summary class="safety-section-title">üîç Stall Detection <span class="safety-badge" id="badge-sd">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          Checks if joints reached their target after a delay. Logs warning if error exceeds threshold.
          <br>üîß <b>Software safety layer</b>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;align-items:center">
          <label class="safety-field" title="Seconds to wait before checking. ‚Üë for slow movements. Default: 5.0s">
            Delay (s): <input type="number" id="sf_sd_delay" step="0.5" class="safety-input">
          </label>
          <label class="safety-field" title="Degrees of error allowed. ‚Üë = fewer false positives. Default: 15.0¬∞">
            Threshold (¬∞): <input type="number" id="sf_sd_thresh" step="1" class="safety-input">
          </label>
          <label class="safety-field" title="When OFF, stall detection is skipped.">
            <input type="checkbox" id="sf_sd_enabled"> Enabled
          </label>
        </div>
      </div>
    </details>

    <!-- Collision Detection -->
    <details class="safety-section">
      <summary class="safety-section-title">üí• Collision Detection <span class="safety-badge" id="badge-cd">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          Monitors commanded vs actual positions in real-time. Fires stall event if error persists.
          <br>‚ö†Ô∏è Disabled by default ‚Äî 3¬∞ threshold triggers on normal motion lag.
          <br>üîß <b>Software safety layer</b>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center">
          <label class="safety-field" title="Position error to enter error state. ‚Üì = more sensitive. Default: 3.0¬∞">
            Error Threshold (¬∞): <input type="number" id="sf_cd_error" step="0.5" class="safety-input">
          </label>
          <label class="safety-field" title="Error must persist this long before stall fires. ‚Üì = faster response. Default: 0.5s">
            Duration (s): <input type="number" id="sf_cd_dur" step="0.1" class="safety-input">
          </label>
          <label class="safety-field" title="Min time between stall events per joint. Default: 5.0s">
            Cooldown (s): <input type="number" id="sf_cd_cool" step="1" class="safety-input">
          </label>
          <label class="safety-field" title="Enable real-time collision detection. May cause false positives.">
            <input type="checkbox" id="sf_cd_enabled"> Enabled
          </label>
        </div>
      </div>
    </details>

    <!-- Command Smoother -->
    <details class="safety-section">
      <summary class="safety-section-title">üîÑ Command Smoother <span class="safety-badge" id="badge-cs">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          Interpolates between current and target positions to prevent jerky motion. Runs at fixed rate.
          <br>üîß <b>Software safety layer</b> ‚Äî changes apply immediately.
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center">
          <label class="safety-field" title="Exponential smoothing factor. 0.1=very smooth/slow, 1.0=instant/no smoothing. Default: 0.35">
            Alpha (smoothing): <input type="number" id="sf_cs_alpha" step="0.05" min="0.05" max="1.0" class="safety-input">
          </label>
          <label class="safety-field" title="Max degrees per tick. Safety velocity cap. ‚Üë = faster motion. Default: 10.0¬∞">
            Max Step (¬∞/tick): <input type="number" id="sf_cs_step" step="1" class="safety-input">
          </label>
          <label class="safety-field" title="Max gripper change per tick. Default: 5.0mm">
            Max Gripper Step (mm): <input type="number" id="sf_cs_grip" step="1" class="safety-input">
          </label>
          <label class="safety-field" title="Refuse commands if feedback is older than this. Default: 0.5s">
            Feedback Staleness (s): <input type="number" id="sf_cs_stale" step="0.1" class="safety-input">
          </label>
        </div>
      </div>
    </details>

    <!-- Velocity Limits -->
    <details class="safety-section">
      <summary class="safety-section-title">‚ö° Velocity Limits <span class="safety-badge" id="badge-vl">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          Maximum joint velocities for SafetyMonitor validation and motion planner.
          <br>üîß <b>Software safety layer</b> ‚Äî validated before sending to D1.
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead><tr style="color:var(--text-secondary)">
            <th style="text-align:left;padding:4px">Joint</th>
            <th style="text-align:center;padding:4px">Max (rad/s)</th>
            <th style="text-align:center;padding:4px">Max (¬∞/s)</th>
          </tr></thead>
          <tbody id="safetyVelBody"></tbody>
        </table>
      </div>
    </details>

    <!-- Torque Limits -->
    <details class="safety-section">
      <summary class="safety-section-title">üèãÔ∏è Torque Limits <span class="safety-badge" id="badge-tl">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          Maximum torque per joint (Nm). Used by SafetyMonitor for command validation.
          <br>üîß <b>Software safety layer</b>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead><tr style="color:var(--text-secondary)">
            <th style="text-align:left;padding:4px">Joint</th>
            <th style="text-align:center;padding:4px">Max Torque (Nm)</th>
          </tr></thead>
          <tbody id="safetyTorqueBody"></tbody>
        </table>
      </div>
    </details>

    <!-- Workspace Bounds -->
    <details class="safety-section">
      <summary class="safety-section-title">üåê Workspace Bounds <span class="safety-badge" id="badge-wb">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          Spherical workspace limit from base. Rejects state if estimated reach exceeds radius.
          <br>üîß <b>Software safety layer</b>
        </div>
        <label class="safety-field" title="Max reach from base in mm. ‚Üì = smaller safe zone. Default: 550mm">
          Max Radius (mm): <input type="number" id="sf_wb_radius" step="10" class="safety-input">
        </label>
      </div>
    </details>

    <!-- Ramp Control -->
    <details class="safety-section">
      <summary class="safety-section-title">üìà Ramp Control <span class="safety-badge" id="badge-rc">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          Large movements are broken into incremental steps to avoid motor overload.
          <br>üîß <b>Software safety layer</b>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;align-items:center">
          <label class="safety-field" title="Movements larger than this are ramped. Default: 20¬∞">
            Threshold (¬∞): <input type="number" id="sf_rc_thresh" step="5" class="safety-input">
          </label>
          <label class="safety-field" title="Size of each ramp increment. Default: 10¬∞">
            Step (¬∞): <input type="number" id="sf_rc_step" step="1" class="safety-input">
          </label>
          <label class="safety-field" title="Delay between ramp steps. Default: 0.3s">
            Delay (s): <input type="number" id="sf_rc_delay" step="0.05" class="safety-input">
          </label>
        </div>
      </div>
    </details>

    <!-- Emergency Stop & Recovery -->
    <details class="safety-section">
      <summary class="safety-section-title">üö® Emergency Stop & Recovery <span class="safety-badge" id="badge-es">‚Äî</span></summary>
      <div class="safety-section-body">
        <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">
          E-Stop disables motors and powers off. Auto-recovery attempts safe enable after power loss.
          <br>üîß <b>Software safety layer</b>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center">
          <label class="safety-field" title="Auto-recover from power loss. Default: enabled">
            <input type="checkbox" id="sf_es_auto"> Auto-Recovery Enabled
          </label>
          <label class="safety-field" title="Seconds to wait before auto-recovery. Default: 3.0s">
            Recovery Delay (s): <input type="number" id="sf_es_delay" step="0.5" class="safety-input">
          </label>
        </div>
      </div>
    </details>

    </div><!-- /safetyContainer -->
  </div>
</div>

</div><!-- /content -->
</div><!-- /app-layout -->

<script>
'use strict';

// =====================================================//  NAVIGATION
// =====================================================
function toggleNavGroup(el) {
  el.parentElement.classList.toggle('open');
}

let _activePanel = 'control';

function showPanel(navItem) {
  const panelId = navItem.dataset.panel;
  if (!panelId) return;

  // Deactivate previous
  const prevPanel = _activePanel;
  if (prevPanel === 'ascii' && typeof asciiDisconnect === 'function') asciiDisconnect();
  if (prevPanel === 'factory' && typeof fw_deactivate === 'function') fw_deactivate();
  if (prevPanel === 'realworld' && typeof rw_deactivate === 'function') rw_deactivate();
  if (prevPanel === 'simulator' && typeof sim_deactivate === 'function') sim_deactivate();
  if (prevPanel === 'bifocal' && typeof wsCalibStopStreams === 'function') wsCalibStopStreams();

  // Update nav
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  navItem.classList.add('active');

  // Update panels
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById('panel-' + panelId);
  if (panel) panel.classList.add('active');
  _activePanel = panelId;

  // Activate new panel
  setTimeout(() => {
    if (panelId === 'control') resizeCanvas();
    if (panelId === 'ascii' && typeof asciiConnect === 'function') asciiConnect();
    if (panelId === 'factory' && typeof fw_activate === 'function') fw_activate();
    if (panelId === 'realworld' && typeof rw_activate === 'function') rw_activate();
    if (panelId === 'simulator' && typeof sim_activate === 'function') sim_activate();
    if (panelId === 'bifocal' && typeof wsCalibStartStreams === 'function') wsCalibStartStreams();
    if (panelId === 'cameras') refreshCameraPanel();
    if (panelId === 'safety') safetyLoad();
    if (panelId === 'debug' && debugOn) pollDebug();
  }, 100);
}

function refreshCameraPanel() {
  for (let i = 0; i < 3; i++) {
    const img = document.getElementById('camFull' + i);
    if (img) img.src = `http://${location.hostname}:8081/snap/${i}?t=` + Date.now();
  }
}

// Compat: keep window._activeTab for ascii-video.js etc
Object.defineProperty(window, '_activeTab', {
  get() { return _activePanel; },
  set(v) { /* ignore */ }
});

// =====================================================//  CONSTANTS & SPECS
// =====================================================
const JOINT_SPECS = [
  { name: 'J0', min: -135, max: 135, label: 'Base Yaw',    type: 'yaw'   },  // was already ¬±135
  { name: 'J1', min: -90,  max: 90,  label: 'Shoulder',    type: 'pitch' },  // widened from ¬±80
  { name: 'J2', min: -90,  max: 90,  label: 'Elbow',       type: 'pitch' },  // widened from ¬±80
  { name: 'J3', min: -135, max: 135, label: 'Wrist Roll',  type: 'roll'  },
  { name: 'J4', min: -90,  max: 90,  label: 'Wrist Pitch', type: 'pitch' },  // widened from ¬±80
  { name: 'J5', min: -135, max: 135, label: 'Wrist Roll',  type: 'roll'  },
];

let LINKS_MM = { base: 80, shoulder: 170, elbow: 170, wrist1: 60, wrist2: 60, end: 50 };
let CAM_PARAMS = null;
let USE_3D_PROJECTION = false;

function fkPositions(jointsDeg) {
  const D = Math.PI / 180;
  const j = jointsDeg.map(v => (v || 0) * D);
  const d0 = 0.1215, L1 = 0.2085, L2 = 0.2085, L3 = 0.1130;
  function rz(a) { const c=Math.cos(a),s=Math.sin(a); return [c,-s,0, s,c,0, 0,0,1]; }
  function ry(a) { const c=Math.cos(a),s=Math.sin(a); return [c,0,s, 0,1,0, -s,0,c]; }
  function mul(A,B) { const C=new Array(9); for(let r=0;r<3;r++) for(let c=0;c<3;c++) C[r*3+c]=A[r*3]*B[c]+A[r*3+1]*B[3+c]+A[r*3+2]*B[6+c]; return C; }
  function apply(R,v) { return [R[0]*v[0]+R[1]*v[1]+R[2]*v[2], R[3]*v[0]+R[4]*v[1]+R[5]*v[2], R[6]*v[0]+R[7]*v[1]+R[8]*v[2]]; }
  function vadd(a,b) { return [a[0]+b[0],a[1]+b[1],a[2]+b[2]]; }
  const base=[0,0,0], shoulder=[0,0,d0];
  let R=mul(rz(j[0]),ry(j[1]));
  const elbow=vadd(shoulder,apply(R,[0,0,L1]));
  R=mul(R,ry(Math.PI/2+j[2]));
  const wrist=vadd(elbow,apply(R,[0,0,L2]));
  R=mul(R,rz(j[3]));
  R=mul(R,ry(j[4]));
  const ee=vadd(wrist,apply(R,[0,0,L3]));
  return [base,shoulder,elbow,wrist,ee];
}

function rodrigues(rv) {
  const angle=Math.sqrt(rv[0]*rv[0]+rv[1]*rv[1]+rv[2]*rv[2]);
  if(angle<1e-8) return [[1,0,0],[0,1,0],[0,0,1]];
  const k=[rv[0]/angle,rv[1]/angle,rv[2]/angle];
  const c=Math.cos(angle),s=Math.sin(angle),v=1-c;
  return [[k[0]*k[0]*v+c,k[0]*k[1]*v-k[2]*s,k[0]*k[2]*v+k[1]*s],[k[1]*k[0]*v+k[2]*s,k[1]*k[1]*v+c,k[1]*k[2]*v-k[0]*s],[k[2]*k[0]*v-k[1]*s,k[2]*k[1]*v+k[0]*s,k[2]*k[2]*v+c]];
}

function projectPoint3D(p3d,cam) {
  const R=rodrigues([cam.rx,cam.ry,cam.rz]);
  const pc=[R[0][0]*p3d[0]+R[0][1]*p3d[1]+R[0][2]*p3d[2]+cam.tx, R[1][0]*p3d[0]+R[1][1]*p3d[1]+R[1][2]*p3d[2]+cam.ty, R[2][0]*p3d[0]+R[2][1]*p3d[1]+R[2][2]*p3d[2]+cam.tz];
  if(pc[2]<=0) return null;
  return [cam.fx*pc[0]/pc[2]+cam.cx, cam.fy*pc[1]/pc[2]+cam.cy];
}

(async function loadVizCalibration() {
  try {
    const resp=await fetch('/api/viz/calibration');
    if(resp.ok) { const data=await resp.json(); if(data.ok&&data.camera_params) { const cam=data.camera_params.cam1||data.camera_params.cam0; if(cam){CAM_PARAMS=cam;USE_3D_PROJECTION=true;} } }
  } catch(e) {}
})();

// =====================================================//  STATE
// =====================================================
let ws = null;
let armState = { connected: false, joints: [0,0,0,0,0,0], gripper: 0, power: false, enabled: false, error: 0, log: [] };
let lastStateTs = 0;
let userDragging = -1;
let animFrameId = null;
let localLog = [];
let armSynced = false;
let updatingFromState = false;
let vizDirty = true;
let lastGoodJoints = [0,0,0,0,0,0];
let vizJoints = [0,0,0,0,0,0];
let jointSource = 'init';
let wsUpdateCount = 0;

// =====================================================//  UTILITIES
// =====================================================
function logLocal(action, details, level) {
  const now = new Date();
  const ts_str = now.toTimeString().slice(0,8) + '.' + String(now.getMilliseconds()).padStart(3,'0');
  localLog.push({ ts_str, action, details, level });
  if (localLog.length > 100) localLog.shift();
}

function esc(s) { if(!s) return ''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

function makeThrottle(fn, ms=50) {
  let lastCall=0, timer=null;
  return function(...args) {
    const now=Date.now();
    if(now-lastCall>=ms){lastCall=now;fn(...args);}
    else{clearTimeout(timer);timer=setTimeout(()=>{lastCall=Date.now();fn(...args);},ms-(now-lastCall));}
  };
}

// Generic API helper
async function apiCall(url, opts={}) {
  try {
    const resp = await fetch(url, opts);
    return await resp.json();
  } catch(e) {
    return { ok: false, error: e.message };
  }
}

async function apiPost(url, body={}) {
  return apiCall(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
}

function showResult(elId, data) {
  const el = document.getElementById(elId);
  if (!el) return;
  el.style.display = 'block';
  el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
}

// =====================================================//  SLIDER SETUP
// =====================================================
const slidersDiv = document.getElementById('jointSliders');
for (let i = 0; i < 6; i++) {
  const spec = JOINT_SPECS[i];
  const row = document.createElement('div');
  row.className = 'joint-row';
  row.innerHTML = `<span class="joint-label">${spec.name}</span><input type="range" class="joint-slider" id="js${i}" min="${spec.min}" max="${spec.max}" step="0.5" value="0"><span class="joint-value" id="jv${i}">0.0¬∞</span>`;
  slidersDiv.appendChild(row);
  const slider = row.querySelector('input');
  slider.addEventListener('mousedown', () => userDragging = i);
  slider.addEventListener('touchstart', () => userDragging = i);
  slider.addEventListener('input', () => {
    document.getElementById(`jv${i}`).textContent = parseFloat(slider.value).toFixed(1) + '¬∞';
    if (!armSynced || updatingFromState) return;
    throttledSendJoint(i, parseFloat(slider.value));
  });
  const release = () => { if (userDragging === i) { sendJoint(i, parseFloat(slider.value)); userDragging = -1; } };
  slider.addEventListener('mouseup', release);
  slider.addEventListener('touchend', release);
  slider.addEventListener('change', release);
}

const gripSlider = document.getElementById('gripperSlider');
gripSlider.addEventListener('mousedown', () => userDragging = 6);
gripSlider.addEventListener('touchstart', () => userDragging = 6);
gripSlider.addEventListener('input', () => {
  document.getElementById('gripperValue').textContent = parseFloat(gripSlider.value).toFixed(1) + ' mm';
  if (!armSynced || updatingFromState) return;
  throttledSendGripper(parseFloat(gripSlider.value));
});
const gripRelease = () => { if (userDragging === 6) { sendGripper(parseFloat(gripSlider.value)); userDragging = -1; } };
gripSlider.addEventListener('mouseup', gripRelease);
gripSlider.addEventListener('touchend', gripRelease);
gripSlider.addEventListener('change', gripRelease);

const throttledSendJoint = makeThrottle((id, angle) => sendJoint(id, angle), 50);
const throttledSendGripper = makeThrottle((pos) => sendGripper(pos), 50);

// =====================================================//  COMMANDS (API calls)
// =====================================================
async function cmd(action) {
  logLocal(action.toUpperCase(), `Sending POST /api/command/${action}`, 'info');
  try {
    const resp = await fetch(`/api/command/${action}`, { method: 'POST' });
    const data = await resp.json();
    if (data.ok) logLocal(action.toUpperCase(), '‚úì Success', 'info');
    else logLocal(action.toUpperCase(), `‚úó Failed: ${data.error || 'unknown'}`, 'error');
    if (data.state) { armState = { ...armState, ...data.state }; vizDirty = true; }
    updateUI();
  } catch(e) { logLocal(action.toUpperCase(), `‚úó Network error: ${e.message}`, 'error'); }
}

// =====================================================
//  BUTTON FEEDBACK HELPER
// =====================================================
async function btnFetch(btn, url, options = {}) {
  if (!btn || btn.disabled) return null;
  const origText = btn.textContent;
  const origBg = btn.style.background;
  const origBorder = btn.style.borderColor;
  btn.disabled = true;
  btn.textContent = '...';
  try {
    const resp = await fetch(url, { method: 'POST', ...options });
    const data = options.raw ? resp : await resp.json();
    const ok = options.raw ? resp.ok : (data && data.ok !== false);
    // Flash green on success
    btn.style.background = 'rgba(83,215,105,0.25)';
    btn.style.borderColor = 'var(--success)';
    btn.textContent = origText;
    setTimeout(() => { btn.style.background = origBg; btn.style.borderColor = origBorder; }, 500);
    btn.disabled = false;
    return data;
  } catch (e) {
    // Flash red on error
    btn.style.background = 'rgba(233,69,96,0.25)';
    btn.style.borderColor = 'var(--danger)';
    btn.textContent = origText;
    setTimeout(() => { btn.style.background = origBg; btn.style.borderColor = origBorder; }, 800);
    btn.disabled = false;
    console.error('btnFetch error:', e);
    return null;
  }
}

// Wrap cmd() with button feedback
async function cmdBtn(btn, action) {
  if (!btn) return;
  const origText = btn.textContent;
  const origBg = btn.style.background;
  const origBorder = btn.style.borderColor;
  btn.disabled = true;
  btn.textContent = '...';
  logLocal(action.toUpperCase(), `Sending POST /api/command/${action}`, 'info');
  try {
    const resp = await fetch(`/api/command/${action}`, { method: 'POST' });
    const data = await resp.json();
    if (data.ok) {
      logLocal(action.toUpperCase(), '‚úì Success', 'info');
      btn.style.background = 'rgba(83,215,105,0.25)';
      btn.style.borderColor = 'var(--success)';
    } else {
      logLocal(action.toUpperCase(), `‚úó Failed: ${data.error || 'unknown'}`, 'error');
      btn.style.background = 'rgba(233,69,96,0.25)';
      btn.style.borderColor = 'var(--danger)';
    }
    if (data.state) { armState = { ...armState, ...data.state }; vizDirty = true; }
    updateUI();
    btn.textContent = origText;
    setTimeout(() => { btn.style.background = origBg; btn.style.borderColor = origBorder; }, 500);
    btn.disabled = false;
  } catch(e) {
    logLocal(action.toUpperCase(), `‚úó Network error: ${e.message}`, 'error');
    btn.style.background = 'rgba(233,69,96,0.25)';
    btn.style.borderColor = 'var(--danger)';
    btn.textContent = origText;
    setTimeout(() => { btn.style.background = origBg; btn.style.borderColor = origBorder; }, 800);
    btn.disabled = false;
  }
}

async function sendJoint(id, angle) {
  if (!armSynced) return;
  logLocal('SET_JOINT', `J${id} -> ${angle.toFixed(1)}¬∞`, 'info');
  try {
    const resp = await fetch('/api/command/set-joint', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id, angle}) });
    const data = await resp.json();
    if (!data.ok) logLocal('SET_JOINT', `‚úó ${data.error || 'failed'}`, 'error');
  } catch(e) { logLocal('SET_JOINT', `‚úó ${e.message}`, 'error'); }
}

async function sendGripper(pos) {
  if (!armSynced) return;
  logLocal('SET_GRIPPER', `${pos.toFixed(1)} mm`, 'info');
  try {
    const resp = await fetch('/api/command/set-gripper', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({position:pos}) });
    const data = await resp.json();
    if (!data.ok) logLocal('SET_GRIPPER', `‚úó ${data.error || 'failed'}`, 'error');
  } catch(e) { logLocal('SET_GRIPPER', `‚úó ${e.message}`, 'error'); }
}

async function runTask(name, body={}) {
  logLocal('TASK', `Starting task: ${name}`, 'info');
  try {
    const resp = await fetch(`/api/task/${name}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const data = await resp.json();
    if (data.ok) logLocal('TASK', `${name}: ${data.points} pts, ${data.duration_s}s`, 'info');
    else logLocal('TASK', `${name}: ${data.error || 'failed'}`, 'error');
  } catch(e) { logLocal('TASK', `${name}: ${e.message}`, 'error'); }
}

// =====================================================//  BUTTON WIRING
// =====================================================
document.getElementById('btnPowerOn').addEventListener('click', function() { cmdBtn(this, 'power-on'); });
document.getElementById('btnPowerOff').addEventListener('click', function() { cmdBtn(this, 'power-off'); });
document.getElementById('btnEnable').addEventListener('click', function() { cmdBtn(this, 'enable'); });
document.getElementById('btnDisable').addEventListener('click', function() { cmdBtn(this, 'disable'); });
document.getElementById('btnTaskHome').addEventListener('click', function() { btnFetch(this, '/api/task/home'); });
document.getElementById('btnTaskReady').addEventListener('click', function() { btnFetch(this, '/api/task/ready'); });
document.getElementById('btnTaskWave').addEventListener('click', function() { btnFetch(this, '/api/task/wave'); });
document.getElementById('btnTaskStop').addEventListener('click', function() { btnFetch(this, '/api/task/stop'); });
document.getElementById('btnResetEnable').addEventListener('click', function() { cmdBtn(this, 'reset-enable'); });
document.getElementById('btnHardResetEnable').addEventListener('click', function() {
  if (confirm('‚ö† HARD RESET will send all joints to 0¬∞ simultaneously.\nOnly use when arm is already near home position!\n\nContinue?')) {
    cmdBtn(this, 'hard-reset-enable');
  }
});
document.getElementById('btnEnableHere').addEventListener('click', function() { cmdBtn(this, 'enable-here'); });
document.getElementById('btnSafeHome').addEventListener('click', function() { cmdBtn(this, 'safe-home'); });
document.getElementById('btnEstop').addEventListener('click', function() { cmdBtn(this, 'stop'); });

document.getElementById('btnRawSend').addEventListener('click', async () => {
  const raw = document.getElementById('rawInput').value.trim();
  if (!raw) return;
  logLocal('RAW', `Sending: ${raw}`, 'warning');
  try {
    const parsed = JSON.parse(raw);
    const action = parsed.action || 'set-joint';
    delete parsed.action;
    const resp = await fetch(`/api/command/${action}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(parsed) });
    const data = await resp.json();
    logLocal('RAW', `Response: ${JSON.stringify(data).slice(0,120)}`, data.ok ? 'info' : 'error');
  } catch(e) { logLocal('RAW', `Error: ${e.message}`, 'error'); }
});
document.getElementById('rawInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('btnRawSend').click(); });

// =====================================================//  TEXT COMMAND
// =====================================================
function textCmdFill(el) {
  document.getElementById('textCmdInput').value = el.textContent;
  document.getElementById('textCmdInput').focus();
}

document.getElementById('btnTextCmd').addEventListener('click', async () => {
  const input = document.getElementById('textCmdInput');
  const text = input.value.trim();
  if (!text) return;
  const feedback = document.getElementById('textCmdFeedback');
  feedback.className = 'text-cmd-feedback'; feedback.style.display = 'none';
  logLocal('TEXT_CMD', `Sending: "${text}"`, 'info');
  try {
    const resp = await fetch('/api/command/text', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text}) });
    const data = await resp.json();
    if (data.ok) {
      const desc = data.description || data.action || 'OK';
      const extra = data.points ? ` (${data.points} pts, ${data.duration_s}s)` : '';
      feedback.textContent = `${desc}${extra}`; feedback.className = 'text-cmd-feedback ok';
      logLocal('TEXT_CMD', `${desc}${extra}`, 'info'); input.value = '';
    } else {
      feedback.textContent = data.error || 'Unknown error'; feedback.className = 'text-cmd-feedback err';
      logLocal('TEXT_CMD', `Error: ${data.error}`, 'error');
    }
    if (data.state) { armState = { ...armState, ...data.state }; vizDirty = true; }
    updateUI();
  } catch(e) { feedback.textContent = `Network error: ${e.message}`; feedback.className = 'text-cmd-feedback err'; }
  setTimeout(() => { feedback.className = 'text-cmd-feedback'; feedback.style.display = 'none'; }, 5000);
});
document.getElementById('textCmdInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('btnTextCmd').click(); });

// =====================================================//  WEBSOCKET
// =====================================================
function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws/state`);
  ws.onopen = () => { updateConn(true); logLocal('WS', 'Connected', 'info'); };
  ws.onclose = () => { updateConn(false); setTimeout(connectWS, 2000); };
  ws.onerror = () => ws.close();
  ws.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      if (data.type === 'ack') { logLocal('ACK', `${data.action}: ${data.ok ? 'OK' : 'FAIL'}`, data.ok ? 'info' : 'error'); return; }
      if (data.type === 'collision') { showCollisionAlert(data); logLocal('COLLISION', `‚ö† J${data.joint} stalled`, 'error'); return; }
      const newJoints = data.joints || [0,0,0,0,0,0];
      const allZero = newJoints.every(v => Math.abs(v) < 0.01);
      const hadReal = lastGoodJoints.some(v => Math.abs(v) > 0.1);
      if (allZero && hadReal && armSynced) { data.joints = lastGoodJoints.slice(); jointSource = 'cached'; }
      else { lastGoodJoints = newJoints.slice(); jointSource = 'ws'; }
      const jointsDiff = newJoints.some((v, i) => Math.abs(v - vizJoints[i]) > 0.05);
      const otherChanged = data.power !== armState.power || data.enabled !== armState.enabled || data.error !== armState.error;
      armState = data; lastStateTs = Date.now(); wsUpdateCount++;
      if (jointsDiff || otherChanged || !armSynced) vizDirty = true;
      if (!armSynced) { armSynced = true; logLocal('SYNC', 'First arm state received', 'info'); }
      // Feed live state to 3D simulator ghost arm
      if (typeof window._simWsHook === 'function') window._simWsHook(data);
    } catch(err) {}
  };
}

function updateConn(on) {
  document.getElementById('connDot').className = 'conn-dot ' + (on ? 'on' : 'off');
  document.getElementById('connLabel').textContent = on ? 'CONNECTED' : 'DISCONNECTED';
}

// =====================================================//  UI UPDATE
// =====================================================
function updateUI() {
  const bp = document.getElementById('badgePower');
  bp.textContent = armState.power ? 'PWR ON' : 'PWR OFF';
  bp.className = 'badge' + (armState.power ? ' active' : '');
  const be = document.getElementById('badgeEnabled');
  be.textContent = armState.enabled ? 'ENABLED' : 'DISABLED';
  be.className = 'badge' + (armState.enabled ? ' active' : '');
  const berr = document.getElementById('badgeError');
  if (armState.error) { berr.textContent = 'ERR ' + armState.error; berr.className = 'badge error'; }
  else { berr.textContent = 'NO ERR'; berr.className = 'badge'; }

  const simBadge = document.getElementById('simBadge');
  if (armState.sim_mode !== undefined) {
    simBadge.style.display = 'inline';
    if (armState.sim_mode) { simBadge.textContent = '‚ö° SIM'; simBadge.style.background = '#f59e0b'; simBadge.style.color = '#000'; }
    else { simBadge.textContent = 'üî¥ LIVE'; simBadge.style.background = '#ef4444'; simBadge.style.color = '#fff'; }
  }

  if (lastStateTs > 0) {
    const age = Date.now() - lastStateTs;
    const q = document.getElementById('connQuality');
    if (age < 500) q.textContent = '‚óè live';
    else if (age < 2000) q.textContent = `‚óè ${(age/1000).toFixed(1)}s ago`;
    else q.textContent = `‚ö† ${(age/1000).toFixed(0)}s stale`;
    q.style.color = age < 500 ? 'var(--success)' : age < 2000 ? 'var(--warning)' : 'var(--danger)';
  }

  document.getElementById('btnPowerOn').disabled = armState.power;
  document.getElementById('btnPowerOn').className = 'btn' + (armState.power ? ' on' : '');
  document.getElementById('btnPowerOff').disabled = !armState.power;
  document.getElementById('btnEnable').disabled = !armState.power || armState.enabled;
  document.getElementById('btnEnable').className = 'btn' + (armState.enabled ? ' on' : '');
  document.getElementById('btnDisable').disabled = !armState.enabled;
  document.getElementById('btnEstop').className = armState.enabled ? 'estop flash' : 'estop';

  updatingFromState = true;
  const joints = armState.joints || [0,0,0,0,0,0];
  for (let i = 0; i < 6; i++) {
    if (userDragging !== i) {
      const val = joints[i] || 0;
      const slider = document.getElementById(`js${i}`);
      if (Math.abs(parseFloat(slider.value) - val) > 0.25) slider.value = val;
      const label = document.getElementById(`jv${i}`);
      const txt = val.toFixed(1) + '¬∞';
      if (label.textContent !== txt) label.textContent = txt;
    }
  }
  if (userDragging !== 6) {
    const gv = armState.gripper || 0;
    if (Math.abs(parseFloat(gripSlider.value) - gv) > 0.25) gripSlider.value = gv;
    const gLabel = document.getElementById('gripperValue');
    const gTxt = gv.toFixed(1) + ' mm';
    if (gLabel.textContent !== gTxt) gLabel.textContent = gTxt;
  }
  updatingFromState = false;
  renderLog();
}

let lastLogHash = '';
function renderLog() {
  const serverEntries = (armState.log || []).map(e => ({ ts_str: e.ts_str, action: e.action, details: e.details, level: e.level, src: 's' }));
  const all = [...serverEntries, ...localLog.map(e => ({ ...e, src: 'c' }))];
  all.sort((a, b) => a.ts_str.localeCompare(b.ts_str));
  const last40 = all.slice(-40);
  const hash = last40.map(e => e.ts_str + e.action).join('|');
  if (hash === lastLogHash) return;
  lastLogHash = hash;
  const el = document.getElementById('logScroll');
  el.innerHTML = last40.map(e => `<div class="log-entry ${e.level}"><span class="ts">${esc(e.ts_str)}</span><span class="act">${esc(e.action)}</span><span class="detail">${esc(e.details)}</span></div>`).join('');
  el.scrollTop = el.scrollHeight;
}

// =====================================================//  ARM VISUALIZATION (Canvas FK) ‚Äî preserved from V1
// =====================================================
const canvas = document.getElementById('armCanvas');
const ctx = canvas.getContext('2d');

function drawArm() {
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);
  const rawJoints = armState.joints || [0,0,0,0,0,0];
  for (let i = 0; i < 6; i++) {
    const diff = rawJoints[i] - vizJoints[i];
    if (Math.abs(diff) > 0.05) vizJoints[i] += diff * 0.4;
    else vizJoints[i] = rawJoints[i];
  }
  const joints = vizJoints;
  const deg2rad = Math.PI / 180;
  const scale = Math.min(W, H) / 900;
  const baseX = W * 0.35, baseY = H * 0.85;

  // Grid
  ctx.strokeStyle = 'rgba(42,74,124,0.12)'; ctx.lineWidth = 1;
  for (let y = 0; y < H; y += 50) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }
  for (let x = 0; x < W; x += 50) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }

  // Base
  ctx.fillStyle = '#1a2744'; ctx.strokeStyle = '#2a4a7c'; ctx.lineWidth = 1;
  const bw = 60 * scale, bh = 15 * scale;
  ctx.fillRect(baseX - bw, baseY, bw * 2, bh); ctx.strokeRect(baseX - bw, baseY, bw * 2, bh);

  const fkPos = fkPositions(joints);
  let pts;
  if (USE_3D_PROJECTION && CAM_PARAMS) {
    const projected = fkPos.map(p => projectPoint3D(p, CAM_PARAMS));
    const camW = 1920, camH = 1080;
    pts = projected.map(p => { if (!p) return { x: baseX, y: baseY }; return { x: p[0] * (W / camW), y: p[1] * (H / camH) }; });
  } else {
    const j0rad = (joints[0] || 0) * deg2rad;
    const cosJ0 = Math.cos(j0rad), sinJ0 = Math.sin(j0rad);
    const mToPixel = 700 * scale;
    pts = fkPos.map(p => { const radial = p[0] * cosJ0 + p[1] * sinJ0; return { x: baseX + radial * mToPixel, y: baseY - p[2] * mToPixel }; });
  }

  // Links
  const linkColors = ['#2a4a7c', '#4a90d9', '#3a7abd', '#2a6aad'];
  const linkWidths = [10, 8, 6, 4];
  ctx.lineCap = 'round';
  for (let i = 0; i < pts.length - 1; i++) {
    ctx.strokeStyle = linkColors[i] || '#4a90d9'; ctx.lineWidth = linkWidths[i] * scale * 1.2;
    ctx.beginPath(); ctx.moveTo(pts[i].x, pts[i].y); ctx.lineTo(pts[i+1].x, pts[i+1].y); ctx.stroke();
  }

  // Joints
  for (let i = 0; i < pts.length; i++) {
    const r = (i === 0 ? 10 : i === pts.length - 1 ? 5 : 7) * scale;
    ctx.beginPath(); ctx.arc(pts[i].x, pts[i].y, r + 3 * scale, 0, Math.PI * 2); ctx.fillStyle = 'rgba(15,52,96,0.3)'; ctx.fill();
    ctx.beginPath(); ctx.arc(pts[i].x, pts[i].y, r, 0, Math.PI * 2); ctx.fillStyle = '#16213e'; ctx.fill(); ctx.strokeStyle = '#4a90d9'; ctx.lineWidth = 2 * scale; ctx.stroke();
  }

  const rollColor = '#e8a838', pitchColor = '#4a90d9';
  function drawRotationIndicator(cx, cy, radius, angleDeg, label) {
    const a = angleDeg * deg2rad, r = radius * scale;
    ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.strokeStyle = 'rgba(232,168,56,0.15)'; ctx.lineWidth = 3 * scale; ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, -Math.PI / 2, -Math.PI / 2 + a, a < 0); ctx.closePath();
    ctx.fillStyle = Math.abs(angleDeg) > 100 ? 'rgba(233,69,96,0.2)' : 'rgba(232,168,56,0.15)'; ctx.fill();
    ctx.beginPath(); ctx.arc(cx, cy, r, -Math.PI / 2, -Math.PI / 2 + a, a < 0);
    ctx.strokeStyle = Math.abs(angleDeg) > 100 ? '#e94560' : rollColor; ctx.lineWidth = 3.5 * scale; ctx.stroke();
    const ex = cx + Math.cos(-Math.PI / 2 + a) * r, ey = cy + Math.sin(-Math.PI / 2 + a) * r;
    ctx.beginPath(); ctx.arc(ex, ey, 4 * scale, 0, Math.PI * 2); ctx.fillStyle = Math.abs(angleDeg) > 100 ? '#e94560' : rollColor; ctx.fill();
    ctx.font = `bold ${10 * scale}px JetBrains Mono, monospace`; ctx.fillStyle = rollColor;
    ctx.fillText(`${label} ${angleDeg.toFixed(1)}¬∞`, cx + (r + 6 * scale), cy + (4 * scale));
  }

  // J0 top-down mini
  const j0Angle = joints[0] || 0;
  const j0cx = W - 50 * scale, j0cy = 50 * scale, j0r = 30 * scale;
  ctx.beginPath(); ctx.arc(j0cx, j0cy, j0r + 2 * scale, 0, Math.PI * 2); ctx.fillStyle = 'rgba(26,39,68,0.6)'; ctx.fill();
  ctx.strokeStyle = 'rgba(232,168,56,0.3)'; ctx.lineWidth = 1.5 * scale; ctx.stroke();
  const j0a = j0Angle * deg2rad;
  ctx.beginPath(); ctx.moveTo(j0cx, j0cy); ctx.arc(j0cx, j0cy, j0r, -Math.PI / 2, -Math.PI / 2 + j0a, j0a < 0); ctx.closePath();
  ctx.fillStyle = Math.abs(j0Angle) > 100 ? 'rgba(233,69,96,0.2)' : 'rgba(232,168,56,0.15)'; ctx.fill();
  ctx.beginPath(); ctx.moveTo(j0cx, j0cy); ctx.lineTo(j0cx + Math.sin(j0a) * j0r * 0.85, j0cy - Math.cos(j0a) * j0r * 0.85);
  ctx.strokeStyle = Math.abs(j0Angle) > 100 ? '#e94560' : rollColor; ctx.lineWidth = 3 * scale; ctx.stroke();
  ctx.beginPath(); ctx.arc(j0cx, j0cy, 3 * scale, 0, Math.PI * 2); ctx.fillStyle = rollColor; ctx.fill();
  ctx.font = `bold ${10 * scale}px JetBrains Mono, monospace`; ctx.fillStyle = rollColor; ctx.textAlign = 'center';
  ctx.fillText(`J0 ${j0Angle.toFixed(1)}¬∞`, j0cx, j0cy + j0r + 14 * scale); ctx.textAlign = 'left';

  drawRotationIndicator(pts[2].x, pts[2].y, 22, joints[3] || 0, 'J3');
  drawRotationIndicator(pts[3].x, pts[3].y, 18, joints[5] || 0, 'J5');

  // Pitch labels
  ctx.font = `bold ${10 * scale}px JetBrains Mono, monospace`; ctx.fillStyle = pitchColor;
  ctx.fillText(`J1 ${(joints[1]||0).toFixed(1)}¬∞`, pts[1].x - 55 * scale, pts[1].y - 12 * scale);
  ctx.fillText(`J2 ${(joints[2]||0).toFixed(1)}¬∞`, pts[2].x + 12 * scale, pts[2].y - 12 * scale);
  ctx.fillText(`J4 ${(joints[4]||0).toFixed(1)}¬∞`, pts[3].x + 12 * scale, pts[3].y - 12 * scale);

  // Gripper
  const tip = pts[pts.length - 1], prevPt = pts[pts.length - 2];
  const gAngle = Math.atan2(tip.y - prevPt.y, tip.x - prevPt.x);
  const gripMM = armState.gripper != null ? armState.gripper : 0;
  const gripRatio = Math.min(gripMM / 65, 1);
  const gOpen = gripRatio * 12 * scale, fingerLen = 20 * scale, fingerWid = 4 * scale;
  const gR = Math.round(233 - gripRatio * 150), gG = Math.round(120 + gripRatio * 95), gB = Math.round(56 + gripRatio * 50);
  const gripCol = `rgb(${gR},${gG},${gB})`;
  for (const side of [-1, 1]) {
    const perpX = Math.cos(gAngle + Math.PI / 2) * side * gOpen, perpY = Math.sin(gAngle + Math.PI / 2) * side * gOpen;
    const fx1=tip.x+perpX, fy1=tip.y+perpY, fx2=fx1+Math.cos(gAngle)*fingerLen, fy2=fy1+Math.sin(gAngle)*fingerLen;
    ctx.beginPath(); ctx.moveTo(fx1, fy1); ctx.lineTo(fx2, fy2);
    ctx.strokeStyle = gripCol; ctx.lineWidth = fingerWid; ctx.lineCap = 'round'; ctx.stroke();
  }
  ctx.font = `bold ${10 * scale}px JetBrains Mono, monospace`; ctx.fillStyle = gripCol;
  ctx.fillText(`Grip ${gripMM.toFixed(1)}mm`, tip.x + 20 * scale, tip.y + 18 * scale);

  // Title
  ctx.font = `${10 * scale}px JetBrains Mono, monospace`; ctx.fillStyle = 'rgba(136,146,164,0.5)';
  ctx.fillText('D1 Arm ‚Äî DH FK', 8, 16 * scale);
  ctx.font = `${8 * scale}px JetBrains Mono, monospace`; ctx.fillStyle = 'rgba(136,146,164,0.4)';
  ctx.fillText(`src:${jointSource} ws#${wsUpdateCount} [${joints.map(v=>v.toFixed(1)).join(', ')}]`, 8, H - 8 * scale);
}

// =====================================================//  ANIMATION & RESIZE
// =====================================================
function animLoop() {
  if (vizDirty) { vizDirty = false; updateUI(); drawArm(); }
  animFrameId = requestAnimationFrame(animLoop);
}

function resizeCanvas() {
  const cont = canvas.parentElement;
  canvas.width = Math.max(cont.clientWidth - 16, 300);
  canvas.height = Math.max(cont.clientHeight - 16, 250);
  vizDirty = true;
}
window.addEventListener('resize', resizeCanvas);

// =====================================================//  CAMERA STREAMING (MJPEG + WebSocket + Fallback)
// =====================================================
const CAM_PORT = 8081, CAM_HOST = location.hostname;
let camMode = 'mjpeg';
const camWsConnections = {}, camOverlays = {};
let camSnapshotTimers = {}, camMjpegErrors = {};

function getMjpegUrl(camId) { return `http://${CAM_HOST}:${CAM_PORT}/cam/${camId}`; }
function getSnapUrl(camId) { return `http://${CAM_HOST}:${CAM_PORT}/snap/${camId}`; }

function initCameraStreams() {
  for (let i = 0; i < 3; i++) { camMjpegErrors[i] = 0; if (camMode === 'mjpeg') startMjpegStream(i); else startWsStream(i); }
}

function startMjpegStream(camId) {
  const img = document.getElementById(`camImg${camId}`), cv = document.getElementById(`camCanvas${camId}`);
  img.style.display = ''; cv.style.display = 'none';
  stopWsStream(camId); stopSnapshotPolling(camId);
  img.src = getMjpegUrl(camId);
  const badge = document.getElementById(`camMode${camId}`); if (badge) badge.textContent = 'MJPEG';
  img.onerror = () => {
    camMjpegErrors[camId] = (camMjpegErrors[camId] || 0) + 1;
    if (camMjpegErrors[camId] >= 3) { if (badge) badge.textContent = 'POLL'; startSnapshotPolling(camId); }
    else setTimeout(() => { img.src = getMjpegUrl(camId) + '?retry=' + Date.now(); }, 2000);
  };
  img.onload = () => { camMjpegErrors[camId] = 0; };
}

function startSnapshotPolling(camId) {
  stopSnapshotPolling(camId);
  const img = document.getElementById(`camImg${camId}`);
  camSnapshotTimers[camId] = setInterval(() => { img.src = getSnapUrl(camId) + '?t=' + Date.now(); }, 200);
}
function stopSnapshotPolling(camId) { if (camSnapshotTimers[camId]) { clearInterval(camSnapshotTimers[camId]); delete camSnapshotTimers[camId]; } }

function startWsStream(camId) {
  const img = document.getElementById(`camImg${camId}`), cv = document.getElementById(`camCanvas${camId}`);
  img.style.display = 'none'; cv.style.display = '';
  stopSnapshotPolling(camId); stopWsStream(camId);
  const cvCtx = cv.getContext('2d');
  const badge = document.getElementById(`camMode${camId}`);
  if (badge) { badge.textContent = 'WS'; badge.style.background = '#0a3d20'; badge.style.color = 'var(--success)'; }
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsConn = new WebSocket(`${proto}//${location.host}/ws/cam/${camId}?overlay=true&fps=15`);
  wsConn.binaryType = 'blob'; let rendering = false;
  wsConn.onmessage = (e) => {
    if (typeof e.data === 'string') { try { const msg = JSON.parse(e.data); if (msg.type === 'overlays') camOverlays[camId] = msg.overlays || []; } catch(_){} return; }
    if (rendering) return; rendering = true;
    createImageBitmap(e.data).then(bmp => { cv.width = bmp.width; cv.height = bmp.height; cvCtx.drawImage(bmp, 0, 0); drawCamOverlays(cvCtx, camId); bmp.close(); rendering = false; }).catch(() => { rendering = false; });
  };
  wsConn.onclose = () => { if (badge) { badge.textContent = 'WS ‚úó'; badge.style.background = '#3d0a0a'; badge.style.color = 'var(--danger)'; } delete camWsConnections[camId]; if (camMode === 'ws') setTimeout(() => startWsStream(camId), 2000); };
  wsConn.onerror = () => wsConn.close();
  camWsConnections[camId] = wsConn;
}
function stopWsStream(camId) { if (camWsConnections[camId]) { try { camWsConnections[camId].close(); } catch(_){} delete camWsConnections[camId]; } }

function drawCamOverlays(ctx2, camId) {
  const overlays = camOverlays[camId] || [];
  for (const o of overlays) {
    ctx2.strokeStyle = o.color || '#00ff00'; ctx2.lineWidth = 1;
    if (o.type === 'crosshair') { const sz = o.size || 20; ctx2.beginPath(); ctx2.moveTo(o.x-sz,o.y); ctx2.lineTo(o.x+sz,o.y); ctx2.moveTo(o.x,o.y-sz); ctx2.lineTo(o.x,o.y+sz); ctx2.stroke(); ctx2.beginPath(); ctx2.arc(o.x,o.y,sz/3,0,Math.PI*2); ctx2.stroke(); }
    else if (o.type === 'rect') { ctx2.strokeRect(o.x,o.y,o.w,o.h); if(o.label){ctx2.fillStyle=o.color||'#00ff00';ctx2.font='14px monospace';ctx2.fillText(o.label,o.x,o.y-4);} }
    else if (o.type === 'circle') { ctx2.beginPath(); ctx2.arc(o.x,o.y,o.r,0,Math.PI*2); ctx2.stroke(); }
  }
}

function switchCameraMode(mode) {
  camMode = mode;
  const info = document.getElementById('camModeInfo'), btn = document.getElementById('btnCamModeToggle');
  if (mode === 'ws') { info.textContent = 'WebSocket + Canvas (CV overlays)'; btn.textContent = 'üîÑ MJPEG MODE'; btn.style.borderColor = 'var(--success)'; btn.style.color = 'var(--success)'; }
  else { info.textContent = 'MJPEG streaming (low latency)'; btn.textContent = 'üîÑ WS MODE'; btn.style.borderColor = ''; btn.style.color = ''; }
  for (let i = 0; i < 3; i++) { if (mode === 'mjpeg') startMjpegStream(i); else startWsStream(i); }
}

document.getElementById('btnCamModeToggle').addEventListener('click', () => switchCameraMode(camMode === 'mjpeg' ? 'ws' : 'mjpeg'));
initCameraStreams();

document.getElementById('btnCamToggle').addEventListener('click', () => {
  const feeds = document.getElementById('cameraFeeds'), btn = document.getElementById('btnCamToggle');
  const hidden = feeds.classList.toggle('hidden');
  btn.textContent = hidden ? 'üëÅ SHOW' : 'üëÅ HIDE';
  if (hidden) { for (let i = 0; i < 3; i++) { stopWsStream(i); stopSnapshotPolling(i); const img = document.getElementById(`camImg${i}`); img.dataset.src = img.src; img.src = ''; } }
  else { for (let i = 0; i < 3; i++) { if (camMode === 'mjpeg') startMjpegStream(i); else startWsStream(i); } }
  setTimeout(resizeCanvas, 50);
});

// =====================================================//  CAMERA SETTINGS
// =====================================================
const PERSPECTIVES = ['overhead', 'side', 'front', 'arm-mounted', 'custom'];

document.getElementById('btnCamSettings').addEventListener('click', () => {
  const panel = document.getElementById('cameraSettings');
  panel.style.display = panel.style.display !== 'none' ? 'none' : 'block';
  if (panel.style.display !== 'none') loadCameraConfig();
});

async function loadCameraConfig() {
  try {
    const resp = await fetch('/api/cameras/config'); const config = await resp.json();
    const container = document.getElementById('camSettingsRows'); container.innerHTML = '';
    for (let i = 0; i < 3; i++) {
      const cfg = config[String(i)] || { label: `Camera ${i}`, perspective: 'custom' };
      const row = document.createElement('div'); row.style.cssText = 'display:flex;gap:6px;align-items:center;margin-bottom:4px;';
      row.innerHTML = `<span style="font-family:var(--mono);font-size:10px;color:var(--text-dim);width:30px">C${i}</span><input type="text" class="cam-cfg-label" data-cam="${i}" value="${cfg.label}" style="flex:1;font-family:var(--mono);font-size:11px;padding:4px 6px;background:#0d1525;border:1px solid var(--card-border);border-radius:3px;color:var(--text)"><select class="cam-cfg-persp" data-cam="${i}" style="font-family:var(--mono);font-size:11px;padding:4px;background:#0d1525;border:1px solid var(--card-border);border-radius:3px;color:var(--text)">${PERSPECTIVES.map(p => `<option value="${p}" ${p === cfg.perspective ? 'selected' : ''}>${p}</option>`).join('')}</select>`;
      container.appendChild(row);
      const labelEl = document.getElementById(`camLabel${i}`); if (labelEl) labelEl.textContent = cfg.label;
    }
  } catch (e) {}
}

document.getElementById('btnSaveCamConfig').addEventListener('click', async () => {
  const labels = document.querySelectorAll('.cam-cfg-label'), persps = document.querySelectorAll('.cam-cfg-persp');
  for (let i = 0; i < labels.length; i++) {
    const camId = parseInt(labels[i].dataset.cam), label = labels[i].value.trim() || `Camera ${camId}`, perspective = persps[i].value;
    try { await fetch('/api/cameras/config', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({camera_id:camId,label,perspective}) }); const labelEl = document.getElementById(`camLabel${camId}`); if (labelEl) labelEl.textContent = label; } catch(e) {}
  }
  document.getElementById('cameraSettings').style.display = 'none';
});
loadCameraConfig();

// =====================================================//  DEBUG TELEMETRY
// =====================================================
let debugOn = false, debugInterval = null, wsLastMsgTs = 0, wsRxIntervalMs = 0;

function hookWsDebug() {
  if (!ws) return;
  const orig = ws.onmessage;
  ws.onmessage = (e) => { const now = Date.now(); if (wsLastMsgTs > 0) wsRxIntervalMs = now - wsLastMsgTs; wsLastMsgTs = now; orig(e); };
}

document.getElementById('btnCalibrateViz').addEventListener('click', async () => {
  const btn = document.getElementById('btnCalibrateViz');
  if (!confirm('Move arm through ~20 poses to calibrate viz. Continue?')) return;
  btn.disabled = true; btn.textContent = 'üìê CALIBRATING...';
  try {
    const data = await apiPost('/api/viz/calibrate');
    if (data.ok) {
      if (data.camera_params) { CAM_PARAMS = data.camera_params.cam1 || data.camera_params.cam0 || null; if (CAM_PARAMS) USE_3D_PROJECTION = true; }
      showResult('vizCalibResult', `Done! ${data.n_observations} obs, residual: ${data.residual}`);
    } else showResult('vizCalibResult', 'Failed: ' + (data.error || 'unknown'));
  } catch(e) { showResult('vizCalibResult', 'Error: ' + e.message); }
  btn.disabled = false; btn.textContent = 'üìê CALIBRATE VIZ';
});

document.getElementById('btnDebug').addEventListener('click', async () => {
  debugOn = !debugOn;
  const btn = document.getElementById('btnDebug'), panel = document.getElementById('debugPanel');
  btn.className = 'btn' + (debugOn ? ' on' : ''); btn.textContent = debugOn ? 'DISABLE' : 'ENABLE';
  panel.style.display = debugOn ? 'block' : 'none';
  try { await fetch(`/api/debug/${debugOn ? 'enable' : 'disable'}`, { method: 'POST' }); } catch(e) {}
  if (debugOn) { hookWsDebug(); debugInterval = setInterval(pollDebug, 1000); pollDebug(); }
  else { if (debugInterval) { clearInterval(debugInterval); debugInterval = null; } }
});

async function pollDebug() {
  if (!debugOn) return;
  try {
    const [statsResp, telResp] = await Promise.allSettled([fetch('/api/debug/stats'), fetch('/api/debug/telemetry?limit=30')]);
    if (statsResp.status === 'fulfilled' && statsResp.value.ok) updateDebugStats(await statsResp.value.json());
    if (telResp.status === 'fulfilled' && telResp.value.ok) { const tel = await telResp.value.json(); updateDebugPipeline(tel.events || tel); renderDebugEvents(tel.events || tel); }
  } catch(e) {}
  document.getElementById('dsWsRxInt').textContent = wsRxIntervalMs > 0 ? wsRxIntervalMs + 'ms' : 'N/A';
  const uiStage = document.querySelector('.pipe-stage[data-stage="UI"]'); if (uiStage) uiStage.className = 'pipe-stage active';
}

function updateDebugStats(s) {
  const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v ?? 'N/A'; };
  set('dsTxRate', s.dds_tx_rate != null ? s.dds_tx_rate + '/s' : 'N/A');
  set('dsRxRate', s.dds_rx_rate != null ? s.dds_rx_rate + '/s' : 'N/A');
  set('dsRxAge', s.dds_last_rx_age_ms != null ? s.dds_last_rx_age_ms + 'ms' : 'N/A');
  set('dsC0Fps', s.cam0_fps != null ? s.cam0_fps.toFixed(1) : 'N/A');
  set('dsC1Fps', s.cam1_fps != null ? s.cam1_fps.toFixed(1) : 'N/A');
  set('dsMotion', s.motion_score != null ? s.motion_score.toFixed(2) : 'N/A');
  set('dsWsSend', s.ws_send_rate != null ? s.ws_send_rate + '/s' : 'N/A');
  set('dsWsLat', s.ws_latency_ms != null ? s.ws_latency_ms + 'ms' : 'N/A');
  set('dsLatCmdAck', s.latency_cmd_ack_ms != null ? s.latency_cmd_ack_ms + 'ms' : 'N/A');
  set('dsLatAckExec', s.latency_ack_exec_ms != null ? s.latency_ack_exec_ms + 'ms' : 'N/A');
  set('dsLatE2e', s.latency_e2e_ms != null ? s.latency_e2e_ms + 'ms' : 'N/A');
}

function updateDebugPipeline(events) {
  const now = Date.now(), recentTypes = new Set(), errorTypes = new Set();
  if (Array.isArray(events)) events.forEach(ev => { const age = ev.timestamp ? now - new Date(ev.timestamp).getTime() : 9999; if (age < 3000) { if (ev.event_type === 'ERROR') errorTypes.add('ERROR'); else recentTypes.add(ev.event_type); } });
  document.querySelectorAll('.pipe-stage').forEach(el => { const stage = el.dataset.stage; if (stage === 'UI') return; if (errorTypes.has(stage)) el.className = 'pipe-stage error'; else if (recentTypes.has(stage)) el.className = 'pipe-stage active'; else el.className = 'pipe-stage'; });
}

function renderDebugEvents(events) {
  const container = document.getElementById('debugEvents');
  if (!Array.isArray(events) || !events.length) { container.innerHTML = '<div style="color:#555">No events</div>'; return; }
  container.innerHTML = events.map(ev => {
    const ts = ev.timestamp ? new Date(ev.timestamp).toTimeString().slice(0,8) : '??:??:??';
    const cid = ev.correlation_id ? ev.correlation_id.slice(0,8) : '';
    const payload = ev.payload ? JSON.stringify(ev.payload).slice(0,80) : '';
    return `<div class="debug-evt"><span class="de-ts">${esc(ts)}</span><span class="de-type de-${ev.event_type||'CMD_SENT'}">${esc(ev.event_type||'?')}</span><span class="de-cid">${esc(cid)}</span><span class="de-pay">${esc(payload)}</span></div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

// =====================================================//  NEW PANEL API HANDLERS
// =====================================================
// --- Visual Servo ---
async function vsStart(mode) {
  const resultId = mode === 'overhead' ? 'vsOverheadResult' : 'vsApproachResult';
  let url, body;
  if (mode === 'overhead') {
    const target = document.getElementById('vsOhTarget').value.trim() || 'redbull';
    const cam = parseInt(document.getElementById('vsOhCam').value);
    url = '/api/servo/visual-servo';
    body = { target: target, camera_id: cam };
  } else {
    const target = document.getElementById('vsApTarget').value.trim() || 'red bull can';
    const maxSteps = parseInt(document.getElementById('vsApMaxSteps').value) || 25;
    url = '/api/servo/approach';
    body = { target: target, max_steps: maxSteps };
  }
  const data = await apiPost(url, body);
  showResult(resultId, data);
  vsStatus(mode);
}
async function vsStop(mode) {
  const url = mode === 'overhead' ? '/api/servo/visual-servo/stop' : '/api/servo/stop';
  const resultId = mode === 'overhead' ? 'vsOverheadResult' : 'vsApproachResult';
  const data = await apiPost(url);
  showResult(resultId, data);
  vsStatus(mode);
}
async function vsStatus(mode) {
  const url = mode === 'overhead' ? '/api/servo/visual-servo/status' : '/api/servo/status';
  const data = await apiCall(url);
  const el = document.getElementById(mode === 'overhead' ? 'vsOverheadStatus' : 'vsApproachStatus');
  const running = data.running || data.state === 'RUNNING';
  el.textContent = running ? 'RUNNING' : 'STOPPED';
  el.className = 'status-indicator ' + (running ? 'running' : 'stopped');
}

// --- Multi-view Pick ---
async function mvpStart() {
  const target = document.getElementById('mvpTarget').value.trim();
  const data = await apiPost('/api/multiview/pick/start', target ? { target } : {});
  showResult('mvpResult', data); mvpRefresh();
}
async function mvpStop() { const data = await apiPost('/api/multiview/pick/stop'); showResult('mvpResult', data); mvpRefresh(); }
async function mvpRefresh() {
  const data = await apiCall('/api/multiview/pick/status');
  const el = document.getElementById('mvpStatus');
  el.textContent = data.status || data.phase || 'IDLE';
  el.className = 'status-indicator ' + (data.active ? 'running' : 'stopped');
  // Update phase chips
  const phases = ['detect','plan','approach','servo','grasp','retreat'];
  const currentIdx = phases.indexOf(data.phase);
  document.querySelectorAll('#mvpPhases .phase-chip').forEach((chip, i) => {
    chip.className = 'phase-chip' + (i < currentIdx ? ' done' : i === currentIdx ? ' active' : '');
  });
}

// --- Pick Planner ---
async function ppDetect() { const target = document.getElementById('ppDetectTarget').value || 'redbull'; showResult('ppDetectResult', await apiPost('/api/pick/detect', {target})); }
async function ppPlan() { const target = document.getElementById('ppTarget').value || 'redbull'; showResult('ppPlanResult', await apiPost('/api/pick/plan', {target})); }
async function ppFromPos() { const x = parseFloat(document.getElementById('ppPosX').value); const y = parseFloat(document.getElementById('ppPosY').value); const z = parseFloat(document.getElementById('ppPosZ').value); const label = document.getElementById('ppTarget').value || 'redbull'; if (isNaN(x)||isNaN(y)||isNaN(z)) { showResult('ppPlanResult','Enter valid X, Y, Z positions in mm'); return; } showResult('ppPlanResult', await apiPost('/api/pick/from-position', {x_mm:x, y_mm:y, z_mm:z, label})); }
async function ppCalibrate() { showResult('ppCalibResult', await apiPost('/api/pick/calibrate-camera-arm')); }

// --- VLA ---
async function vlaRefreshStatus() {
  const data = await apiCall('/api/vla/status');
  const el = document.getElementById('vlaStatus');
  if (!data.available) {
    el.textContent = 'UNAVAILABLE';
    el.className = 'status-indicator stopped';
    return;
  }
  const state = data.state || 'UNKNOWN';
  el.textContent = state.toUpperCase();
  const running = ['observing','planning','executing','verifying'].includes(state);
  const done = state === 'completed';
  el.className = 'status-indicator ' + (running ? 'running' : done ? 'running' : 'stopped');
  if (data.current_task) el.textContent += ': ' + data.current_task;
}
async function vlaAct() {
  const task = document.getElementById('vlaPrompt').value;
  if (!task.trim()) { showResult('vlaActResult', {ok:false, error:'Enter a task prompt'}); return; }
  showResult('vlaActResult', await apiPost('/api/vla/act', {task}));
}
let _vlaCamPoller = null;
function vlaPreviewCams() {
  const wrap = document.getElementById('vlaCamPreview');
  if (wrap.style.display !== 'none') { wrap.style.display = 'none'; clearInterval(_vlaCamPoller); _vlaCamPoller = null; return; }
  wrap.style.display = 'block';
  const snapBase = `http://${CAM_HOST}:${CAM_PORT}`;
  function refresh() {
    const t = Date.now();
    document.getElementById('vlaCam0Img').src = snapBase + '/snap/0?t=' + t;
    document.getElementById('vlaCam1Img').src = snapBase + '/snap/1?t=' + t;
  }
  refresh();
  _vlaCamPoller = setInterval(refresh, 1000);
}
async function vlaDemoStart() { const task = document.getElementById('vlaDemoTask').value; showResult('vlaDemoResult', await apiPost('/api/vla/collect', {action:'start', task})); }
async function vlaDemoStop() { showResult('vlaDemoResult', await apiPost('/api/vla/collect', {action:'stop', success:true})); }
async function vlaDemoList() { showResult('vlaDemoResult', await apiCall('/api/vla/demos')); }

// --- Workspace Calibration ---
let wsCalibStreaming = false;
function wsCalibStartStreams() {
  if (wsCalibStreaming) return;
  wsCalibStreaming = true;
  for (let i = 0; i < 3; i++) {
    const img = document.getElementById(`wsCalibImg${i}`);
    if (img) img.src = getMjpegUrl(i);
  }
}
function wsCalibStopStreams() {
  if (!wsCalibStreaming) return;
  wsCalibStreaming = false;
  for (let i = 0; i < 3; i++) {
    const img = document.getElementById(`wsCalibImg${i}`);
    if (img) img.src = '';
  }
}
async function wsCalibScale() {
  const sq = parseFloat(document.getElementById('wsCalibSquareMm').value) || 25;
  showResult('wsCalibResult', await apiPost('/api/bifocal/calibrate-scale', {square_size_mm: sq}));
}
async function wsCalibPreview() {
  // Grab fresh snapshots from all cameras and display them
  for (let i = 0; i < 3; i++) {
    const img = document.getElementById(`wsCalibImg${i}`);
    if (img) img.src = getSnapUrl(i) + '?t=' + Date.now();
  }
  showResult('wsCalibResult', {ok: true, message: 'Camera snapshots refreshed'});
}

// --- 3D Scan ---
async function scan3dStart() { showResult('scan3dResult', await apiPost('/api/scan/start')); scan3dRefresh(); }
async function scan3dStop() { showResult('scan3dResult', await apiPost('/api/scan/stop')); scan3dRefresh(); }
async function scan3dRefresh() { const data = await apiCall('/api/scan/status'); const el = document.getElementById('scan3dStatus'); el.textContent = data.phase || 'idle'; el.className = 'status-indicator ' + (data.running ? 'running' : 'stopped'); }
async function scan3dList() { showResult('scan3dListResult', await apiCall('/api/scan/list')); }

// --- Calibration Health & Simplified Workflow ---
let _calibHealthData = null;
async function calibCheckHealth() {
  const data = await apiCall('/api/calibration/health');
  _calibHealthData = data;
  const container = document.getElementById('calibHealthItems');
  const scoreEl = document.getElementById('calibHealthScore');
  const summaryEl = document.getElementById('calibHealthSummary');
  if (!container) return;
  container.innerHTML = '';
  // Render each subsystem status
  const items = [
    { label: 'Overhead Camera', ok: data.intrinsics?.cam0?.ok, detail: data.intrinsics?.cam0?.ok ? `RMS ${data.intrinsics.cam0.rms}px` : 'Not calibrated', step: 1 },
    { label: 'Arm Camera', ok: data.intrinsics?.cam1?.ok, detail: data.intrinsics?.cam1?.ok ? `RMS ${data.intrinsics.cam1.rms}px` : 'Not calibrated', step: 1 },
    { label: 'Side Camera', ok: data.intrinsics?.cam2?.ok, detail: data.intrinsics?.cam2?.ok ? `RMS ${data.intrinsics.cam2.rms}px` : 'Not calibrated', step: 1 },
    { label: 'Joint Mapping', ok: data.joint_mapping?.ok, detail: data.joint_mapping?.ok ? 'Calibrated' : 'Not calibrated', step: 2 },
    { label: 'Camera Extrinsics', ok: data.extrinsics?.ok, detail: data.extrinsics?.ok ? 'Calibrated' : 'Not calibrated', step: 3 },
  ];
  items.forEach(item => {
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px 10px;background:#1a1a2e;border-radius:6px;border-left:3px solid ' + (item.ok ? '#4CAF50' : '#f44336') + ';';
    div.innerHTML = `<span style="font-size:16px;">${item.ok ? '\u2705' : '\u274C'}</span><div><div style="font-size:12px;font-weight:bold;">${item.label}</div><div style="font-size:11px;color:#888;">${item.detail}</div></div>`;
    container.appendChild(div);
  });
  // Score
  scoreEl.textContent = `${data.score}/${data.total}`;
  scoreEl.style.color = data.score === data.total ? '#4CAF50' : data.score > 0 ? '#FF9800' : '#f44336';
  summaryEl.textContent = data.summary;
  // Update step icons
  const step1ok = data.intrinsics?.cam0?.ok && data.intrinsics?.cam1?.ok && data.intrinsics?.cam2?.ok;
  const step2ok = data.joint_mapping?.ok;
  const step3ok = data.extrinsics?.ok;
  _calibUpdateStep(1, step1ok);
  _calibUpdateStep(2, step2ok);
  _calibUpdateStep(3, step3ok);
}
function _calibUpdateStep(n, ok) {
  const icon = document.getElementById(`calibStep${n}Icon`);
  const step = document.getElementById(`calibStep${n}`);
  const btn = document.getElementById(`btnCalibStep${n}`);
  if (!icon || !step) return;
  if (ok) {
    icon.textContent = '\u2705';
    step.style.borderLeft = '3px solid #4CAF50';
    if (btn) { btn.textContent = 'Redo'; btn.className = 'btn'; }
  } else {
    icon.textContent = String(n);
    step.style.borderLeft = '3px solid transparent';
    if (btn) { btn.textContent = 'Run'; btn.className = 'btn primary'; }
  }
}
async function calibRunIntrinsics() {
  // Run intrinsics for all cameras with default params
  const btn = document.getElementById('btnCalibStep1');
  btn.disabled = true; btn.textContent = 'Running...';
  const progress = document.getElementById('calibProgress');
  const statusEl = document.getElementById('calibProgressStatus');
  const bar = document.getElementById('calibProgressBar');
  progress.style.display = 'block';
  statusEl.textContent = 'CALIBRATING CAMERAS...';
  bar.style.width = '0%';
  try {
    const r = await apiPost('/api/calibration/intrinsics/all', {
      board_width: 8, board_height: 5, square_mm: 19.0, num_frames: 10
    });
    if (r.error) {
      showResult('calibStepResult', r);
      progress.style.display = 'none';
      btn.disabled = false; btn.textContent = 'Run';
      return;
    }
    // Poll intrinsics status
    const poll = setInterval(async () => {
      const st = await apiCall('/api/calibration/intrinsics/status');
      statusEl.textContent = `INTRINSICS ‚Äî cam${st.camera_id} ‚Äî ${st.frames_captured}/${st.frames_total} frames`;
      const pct = st.frames_total > 0 ? Math.round((st.frames_captured / st.frames_total) * 100) : 0;
      bar.style.width = pct + '%'; bar.textContent = pct + '%';
      if (st.state === 'done' || st.state === 'error') {
        clearInterval(poll);
        progress.style.display = 'none';
        btn.disabled = false;
        if (st.state === 'done') {
          showResult('calibStepResult', { message: 'Camera intrinsics calibrated successfully' });
        } else {
          showResult('calibStepResult', { error: st.error_message || 'Intrinsic calibration failed' });
        }
        calibCheckHealth();
      }
    }, 500);
  } catch (e) {
    progress.style.display = 'none';
    btn.disabled = false; btn.textContent = 'Run';
    showResult('calibStepResult', { error: e.message });
  }
}
function calibStopCurrent() {
  // Stop whatever is currently running
  apiPost('/api/calibration/charuco/stop');
  apiPost('/api/calibration/joint-mapping/stop');
  document.getElementById('calibProgress').style.display = 'none';
}
// Auto-check health when calibration panel is shown
const _origNavClick = document.querySelectorAll ? null : null; // placeholder
document.addEventListener('click', (e) => {
  const navItem = e.target.closest('[data-panel="calibration"]');
  if (navItem) setTimeout(calibCheckHealth, 100);
});
// Also check on page load if calibration panel is visible
setTimeout(() => { if (document.getElementById('panel-calibration')?.style.display !== 'none') calibCheckHealth(); }, 1000);

// --- Calibration Dashboard ---
async function calibStartRun(type) { showResult('calibRunResult', await apiPost(`/api/calibration/${type}/start`)); }
async function calibStopRun() { showResult('calibRunResult', await apiPost('/api/calibration/abort')); }
async function calibListResults() { showResult('calibResultsBox', await apiCall('/api/calibration/results')); }
async function calibViewReport() { showResult('calibResultsBox', await apiCall('/api/calibration/report/latest/json')); }
async function calibViewFrames() { const sid = document.getElementById('calibFrameSession').value; showResult('calibResultsBox', await apiCall(`/api/calibration/frames/${sid}`)); }
async function calibViewExtrinsics() { showResult('calibExtrinsicsResult', await apiCall('/api/calibration/extrinsics')); }

// --- ChArUco Calibration (new pipeline) ---
let _charucoPoller = null;
async function charucoStart() {
  const el = document.getElementById('charucoStatus');
  el.textContent = 'STARTING...'; el.className = 'status-indicator running';
  // Show unified progress
  const progress = document.getElementById('calibProgress');
  const statusEl = document.getElementById('calibProgressStatus');
  const bar = document.getElementById('calibProgressBar');
  if (progress) { progress.style.display = 'block'; statusEl.textContent = 'STARTING EXTRINSICS...'; bar.style.width = '0%'; }
  const data = await apiPost('/api/calibration/charuco/start');
  if (data.ok) {
    _charucoPoller = setInterval(charucoPoll, 2000);
  } else {
    el.textContent = 'ERROR'; el.className = 'status-indicator stopped';
    if (progress) progress.style.display = 'none';
    showResult('charucoResult', data);
  }
}
async function charucoStop() {
  await apiPost('/api/calibration/charuco/stop');
  if (_charucoPoller) { clearInterval(_charucoPoller); _charucoPoller = null; }
  document.getElementById('charucoStatus').textContent = 'STOPPED';
  document.getElementById('charucoStatus').className = 'status-indicator stopped';
}
async function charucoPoll() {
  const data = await apiCall('/api/calibration/charuco/status');
  const el = document.getElementById('charucoStatus');
  el.textContent = (data.status || 'unknown').toUpperCase() + (data.progress ? ` (${data.progress}/${data.total})` : '');
  el.className = 'status-indicator ' + (data.status === 'complete' ? 'running' : data.status === 'error' ? 'stopped' : 'running');
  // Update unified progress bar
  const progress = document.getElementById('calibProgress');
  const statusEl = document.getElementById('calibProgressStatus');
  const bar = document.getElementById('calibProgressBar');
  if (progress && progress.style.display !== 'none') {
    const pct = data.total > 0 ? Math.round((data.progress / data.total) * 100) : 0;
    statusEl.textContent = `EXTRINSICS ‚Äî pose ${data.progress || 0}/${data.total || 25}`;
    bar.style.width = pct + '%'; bar.textContent = pct + '%';
  }
  if (data.status === 'complete' || data.status === 'error') {
    if (_charucoPoller) { clearInterval(_charucoPoller); _charucoPoller = null; }
    if (progress) progress.style.display = 'none';
    if (data.status === 'complete') {
      const result = await apiCall('/api/calibration/charuco/result');
      showResult('charucoResult', result);
      showResult('calibStepResult', { message: 'Camera extrinsics calibrated successfully' });
      calibCheckHealth();
    } else {
      showResult('charucoResult', { error: data.error });
      showResult('calibStepResult', { error: data.error || 'Extrinsics calibration failed' });
    }
  }
}
async function calibCompare() {
  showResult('calibCompareResult', await apiCall('/api/calibration/compare'));
}
// --- Intrinsic Calibration ---
let _icalPollTimer = null;
function _icalParams() {
  return {
    camera_id: parseInt(document.getElementById('icalCamId').value),
    board_width: parseInt(document.getElementById('icalBoardW').value),
    board_height: parseInt(document.getElementById('icalBoardH').value),
    square_mm: parseFloat(document.getElementById('icalSquareMm').value),
    num_frames: parseInt(document.getElementById('icalNumFrames').value),
  };
}
function _icalPoll() {
  if (_icalPollTimer) clearInterval(_icalPollTimer);
  _icalPollTimer = setInterval(async () => {
    const st = await apiCall('/api/calibration/intrinsics/status');
    const el = document.getElementById('icalStatus');
    const rb = document.getElementById('icalResult');
    el.textContent = `${st.state.toUpperCase()} ‚Äî cam${st.camera_id} | frames: ${st.frames_captured}/${st.frames_total} | corners: ${st.corners_found}`;
    el.className = 'status-indicator ' + (st.state === 'done' ? 'active' : st.state === 'error' ? 'danger' : 'running');
    if (st.state === 'done' || st.state === 'error') {
      clearInterval(_icalPollTimer);
      _icalPollTimer = null;
      if (st.state === 'done' && st.result) {
        const r = st.result;
        const cm = r.camera_matrix;
        const fov = r.fov_deg;
        const rmsClass = r.rms_reprojection_px < 0.5 ? 'üü¢' : r.rms_reprojection_px < 1.0 ? 'üü°' : 'üî¥';
        const fxfyRatio = cm.fx / cm.fy;
        const ratioClass = Math.abs(fxfyRatio - 1) < 0.05 ? 'üü¢' : Math.abs(fxfyRatio - 1) < 0.10 ? 'üü°' : 'üî¥';
        let html = `<b>cam${r.camera || st.camera_id}</b> ${rmsClass} RMS: ${r.rms_reprojection_px}px<br>`;
        html += `fx=${cm.fx} fy=${cm.fy} cx=${cm.cx} cy=${cm.cy} ${ratioClass} ratio=${fxfyRatio.toFixed(3)}<br>`;
        html += `FOV: H=${fov.horizontal}¬∞ V=${fov.vertical}¬∞ D=${fov.diagonal}¬∞<br>`;
        html += `Frames: ${r.num_detected}/${r.num_frames} detected`;
        if (r.warnings && r.warnings.length) html += '<br>‚ö†Ô∏è ' + r.warnings.join('<br>‚ö†Ô∏è ');
        rb.innerHTML = html;
        rb.style.display = 'block';
      } else if (st.state === 'error') {
        rb.innerHTML = `<span style="color:var(--danger)">‚ùå ${st.error_message}</span>`;
        rb.style.display = 'block';
      }
    }
  }, 500);
}
async function icalStart() {
  const r = await apiPost('/api/calibration/intrinsics/start', _icalParams());
  if (r.error) { showResult('icalResult', r); return; }
  document.getElementById('icalStatus').textContent = 'STARTING...';
  _icalPoll();
}
async function icalStartAll() {
  const p = _icalParams();
  delete p.camera_id;
  const r = await apiPost('/api/calibration/intrinsics/all', p);
  if (r.error) { showResult('icalResult', r); return; }
  document.getElementById('icalStatus').textContent = 'STARTING ALL...';
  _icalPoll();
}
async function icalValidate() {
  const camId = document.getElementById('icalCamId').value;
  const r = await apiPost(`/api/calibration/intrinsics/validate/${camId}`);
  const rb = document.getElementById('icalResult');
  if (r.valid) {
    const q = r.quality === 'good' ? 'üü¢' : r.quality === 'fair' ? 'üü°' : 'üî¥';
    rb.innerHTML = `${q} Validation: ${r.quality} ‚Äî reproj: ${r.mean_reprojection_px}px, ${r.corners_detected} corners`;
  } else {
    rb.innerHTML = `üî¥ Validation failed: ${r.error}`;
  }
  rb.style.display = 'block';
}

// --- Joint Mapping Calibration ---
let _jmPollTimer = null;
async function jmStart() {
  const r = await apiPost('/api/calibration/joint-mapping/start');
  if (!r.ok) { alert(r.error || 'Failed to start'); return; }
  document.getElementById('jmStatus').textContent = 'RUNNING...';
  document.getElementById('jmStatus').className = 'status-indicator running';
  document.getElementById('jmProgress').style.display = 'block';
  document.getElementById('jmResultsTable').style.display = 'table';
  document.getElementById('jmResultsBody').innerHTML = '';
  document.getElementById('jmApplySection').style.display = 'none';
  // Show unified progress
  const progress = document.getElementById('calibProgress');
  const statusEl = document.getElementById('calibProgressStatus');
  const bar = document.getElementById('calibProgressBar');
  if (progress) { progress.style.display = 'block'; statusEl.textContent = 'JOINT MAPPING...'; bar.style.width = '0%'; }
  if (_jmPollTimer) clearInterval(_jmPollTimer);
  _jmPollTimer = setInterval(jmPoll, 1000);
}
async function jmStop() {
  await apiPost('/api/calibration/joint-mapping/stop');
  if (_jmPollTimer) { clearInterval(_jmPollTimer); _jmPollTimer = null; }
}
async function jmPoll() {
  const st = await apiCall('/api/calibration/joint-mapping/status');
  const el = document.getElementById('jmStatus');
  const bar = document.getElementById('jmProgressBar');
  const pct = st.total_joints > 0 ? Math.round(((st.current_joint + 1) / st.total_joints) * 100) : 0;
  bar.style.width = pct + '%';
  bar.textContent = `${st.current_joint + 1}/${st.total_joints}`;
  el.textContent = st.state.toUpperCase() + (st.current_joint >= 0 ? ` ‚Äî testing DDS joint ${st.current_joint}` : '');
  el.className = 'status-indicator ' + (st.state === 'complete' ? 'active' : st.state === 'error' ? 'danger' : st.state === 'running' ? 'running' : 'stopped');
  // Update results table
  const tbody = document.getElementById('jmResultsBody');
  tbody.innerHTML = '';
  for (const r of st.results || []) {
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #333';
    tr.innerHTML = `<td style="padding:4px;">angle${r.dds_index}</td>
      <td style="padding:4px;">${r.skipped ? '‚è≠ skip' : (r.moved ? '‚úÖ yes' : '‚ùå no')}</td>
      <td style="padding:4px;">${r.diff_score.toFixed(0)}</td>
      <td style="padding:4px;">${r.diff_region}</td>
      <td style="padding:4px;">${r.suggested_label}${r.skip_reason ? ' (' + r.skip_reason + ')' : ''}</td>`;
    tbody.appendChild(tr);
  }
  // Update unified progress
  const uProgress = document.getElementById('calibProgress');
  const uStatus = document.getElementById('calibProgressStatus');
  const uBar = document.getElementById('calibProgressBar');
  if (uProgress && uProgress.style.display !== 'none') {
    uStatus.textContent = `JOINT MAPPING ‚Äî joint ${st.current_joint + 1}/${st.total_joints}`;
    uBar.style.width = pct + '%'; uBar.textContent = pct + '%';
  }
  if (st.state === 'complete' || st.state === 'error' || st.state === 'aborted') {
    clearInterval(_jmPollTimer); _jmPollTimer = null;
    if (uProgress) uProgress.style.display = 'none';
    if (st.state === 'complete') {
      jmShowApply(st.results);
      showResult('calibStepResult', { message: 'Joint mapping complete ‚Äî review mapping below' });
      calibCheckHealth();
    }
    if (st.error) el.textContent += ` ‚Äî ${st.error}`;
  }
}
function jmShowApply(results) {
  const sec = document.getElementById('jmApplySection');
  sec.style.display = 'block';
  const editors = document.getElementById('jmMappingEditors');
  editors.innerHTML = '';
  for (let ui = 0; ui < 6; ui++) {
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;gap:4px;align-items:center;';
    div.innerHTML = `<label style="width:30px;">J${ui}‚Üí</label><select id="jmMap${ui}" style="flex:1;">` +
      [0,1,2,3,4,5].map(d => `<option value="${d}" ${d===ui?'selected':''}>DDS ${d}${results[d] ? ' ('+results[d].suggested_label+')' : ''}</option>`).join('') + '</select>';
    editors.appendChild(div);
  }
}
async function jmApply() {
  const mapping = {}, labels = {};
  for (let ui = 0; ui < 6; ui++) {
    mapping[ui] = parseInt(document.getElementById('jmMap' + ui).value);
    labels[ui] = `J${ui}`;
  }
  const r = await apiPost('/api/calibration/joint-mapping/apply', { mapping, labels });
  const rb = document.getElementById('jmApplyResult');
  rb.innerHTML = r.ok ? '‚úÖ Mapping saved!' : `‚ùå ${r.error}`;
  rb.style.display = 'block';
}

// --- Diagnostics ---
async function diagFeedback() { showResult('diagFeedbackResult', await apiCall('/api/debug/feedback')); }
async function diagSmoother() { showResult('diagSmootherResult', await apiCall('/api/debug/smoother')); }
async function diagGpu() { const data = await apiCall('/api/gpu/status'); showResult('diagGpuResult', data); showResult('settingsGpuResult', data); }

// --- Object Locator ---
async function locateObject() {
  const target = document.getElementById('locateTarget').value;
  const cam = document.getElementById('locateCam').value;
  const data = await apiPost('/api/locate', { target, camera_id: parseInt(cam) });
  showResult('locateResult', data);
  if (data.ok && data.image_url) { const img = document.getElementById('locatePreview'); img.src = data.image_url; img.style.display = 'block'; }
}

// --- Scene Analysis ---
async function sceneAnalyze() {
  const cam = document.getElementById('sceneCam').value;
  const prompt = document.getElementById('scenePrompt').value;
  showResult('sceneResult', await apiPost('/api/vision/analyze', { camera_id: parseInt(cam), prompt }));
}

// --- Claw Prediction ---
async function clawPredToggle(on) { const data = await apiPost('/api/claw-prediction/toggle', {enabled:on}); const el = document.getElementById('clawPredStatus'); el.textContent = on ? 'ON' : 'OFF'; el.className = 'status-indicator ' + (on ? 'running' : 'stopped'); }
async function clawPredSaveHSV() {
  const body = { h_low: +document.getElementById('cpHL').value, h_high: +document.getElementById('cpHH').value, s_low: +document.getElementById('cpSL').value, s_high: +document.getElementById('cpSH').value, v_low: +document.getElementById('cpVL').value, v_high: +document.getElementById('cpVH').value };
  await apiPost('/api/claw-prediction/hsv', body);
}
async function clawPredGetROI() { showResult('cpRoiResult', await apiCall('/api/claw-prediction/roi')); }

// --- Safety & Limits ---
const JOINT_INFO = [
  { name: 'J0', label: 'Base Yaw', hw: 135, tip: 'Base rotation. Hardware limit ¬±135¬∞. Controls left/right sweep.' },
  { name: 'J1', label: 'Shoulder Pitch', hw: 85, tip: 'Shoulder up/down. Hardware ¬±85¬∞. Wider = more reach but more torque on motor.' },
  { name: 'J2', label: 'Elbow Pitch', hw: 85, tip: 'Elbow bend. Hardware ¬±85¬∞. Combined with J1, determines reach extension.' },
  { name: 'J3', label: 'Elbow Roll', hw: 135, tip: 'Forearm rotation. Hardware ¬±135¬∞.' },
  { name: 'J4', label: 'Wrist Pitch', hw: 85, tip: 'Wrist up/down. Hardware ¬±85¬∞. Wider = more dexterous tool angles.' },
  { name: 'J5', label: 'Wrist Roll', hw: 135, tip: 'Wrist rotation. Hardware ¬±135¬∞.' },
];
let _limitsDefaults = null;

function showLimitsResult(msg, isErr) {
  const el = document.getElementById('limitsResult');
  el.style.display = 'block';
  el.style.background = isErr ? '#3a1a1a' : '#1a3a1a';
  el.textContent = typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2);
  setTimeout(() => el.style.display = 'none', 4000);
}

async function limitsLoad() {
  try {
    const resp = await fetch('/api/config/limits');
    const d = await resp.json();
    _limitsDefaults = d.defaults;
    const tbody = document.getElementById('jointLimitsBody');
    tbody.innerHTML = '';
    const limits = d.joint_limits_deg;
    for (let i = 0; i < 6; i++) {
      const ji = JOINT_INFO[i];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:4px" class="setting-tooltip" data-tooltip="${ji.tip}. Default: ¬±${_limitsDefaults.joint_limits_deg[i][1]}¬∞">${ji.name} ‚Äî ${ji.label}</td>
        <td style="padding:4px"><input type="number" id="lim_j${i}_min" value="${limits[i][0]}" step="1" style="width:60px;background:var(--bg-darker);color:var(--text-primary);border:1px solid var(--card-border);padding:2px 4px;border-radius:4px"></td>
        <td style="padding:4px"><input type="number" id="lim_j${i}_max" value="${limits[i][1]}" step="1" style="width:60px;background:var(--bg-darker);color:var(--text-primary);border:1px solid var(--card-border);padding:2px 4px;border-radius:4px"></td>
        <td style="padding:4px;font-size:11px;color:var(--text-secondary)">HW: ¬±${ji.hw}¬∞</td>`;
      tbody.appendChild(tr);
    }
    document.getElementById('lim_torqueLimit').value = d.torque_proxy_limit;
    document.getElementById('lim_torqueJ2').value = d.torque_j2_factor;
    document.getElementById('lim_torqueEnabled').checked = d.torque_proxy_enabled;
    document.getElementById('lim_stallDelay').value = d.stall_check_delay_s;
    document.getElementById('lim_stallThresh').value = d.stall_threshold_deg;
    document.getElementById('lim_stallEnabled').checked = d.stall_detection_enabled;
    document.getElementById('limitsContainer').style.display = 'block';
    showLimitsResult('Loaded', false);
  } catch (e) { showLimitsResult('Load failed: ' + e, true); }
}

function _gatherLimitsPayload() {
  const jl = [];
  for (let i = 0; i < 6; i++) {
    jl.push([parseFloat(document.getElementById(`lim_j${i}_min`).value),
             parseFloat(document.getElementById(`lim_j${i}_max`).value)]);
  }
  return {
    joint_limits_deg: jl,
    torque_proxy_limit: parseFloat(document.getElementById('lim_torqueLimit').value),
    torque_j2_factor: parseFloat(document.getElementById('lim_torqueJ2').value),
    torque_proxy_enabled: document.getElementById('lim_torqueEnabled').checked,
    stall_check_delay_s: parseFloat(document.getElementById('lim_stallDelay').value),
    stall_threshold_deg: parseFloat(document.getElementById('lim_stallThresh').value),
    stall_detection_enabled: document.getElementById('lim_stallEnabled').checked,
  };
}

async function limitsSave() {
  try {
    const payload = _gatherLimitsPayload();
    payload.persist = true;
    const resp = await fetch('/api/config/limits', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
    const d = await resp.json();
    if (d.ok) showLimitsResult('Saved ‚úì', false);
    else showLimitsResult(d.error || 'Save failed', true);
  } catch (e) { showLimitsResult('Save failed: ' + e, true); }
}

async function limitsApply() {
  try {
    const payload = _gatherLimitsPayload();
    payload.persist = false;
    const resp = await fetch('/api/config/limits', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
    const d = await resp.json();
    if (d.ok) showLimitsResult('Applied (not saved to disk) ‚úì', false);
    else showLimitsResult(d.error || 'Apply failed', true);
  } catch (e) { showLimitsResult('Apply failed: ' + e, true); }
}

async function limitsReset() {
  if (!confirm('Reset all safety limits to defaults?')) return;
  if (!_limitsDefaults) { showLimitsResult('Load config first', true); return; }
  try {
    const payload = {
      joint_limits_deg: _limitsDefaults.joint_limits_deg,
      torque_proxy_limit: _limitsDefaults.torque_proxy_limit,
      torque_j2_factor: _limitsDefaults.torque_j2_factor,
      torque_proxy_enabled: _limitsDefaults.torque_proxy_enabled,
      stall_check_delay_s: _limitsDefaults.stall_check_delay_s,
      stall_threshold_deg: _limitsDefaults.stall_threshold_deg,
      stall_detection_enabled: _limitsDefaults.stall_detection_enabled,
      persist: true,
    };
    const resp = await fetch('/api/config/limits', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
    const d = await resp.json();
    if (d.ok) { limitsLoad(); showLimitsResult('Reset to defaults ‚úì', false); }
    else showLimitsResult(d.error || 'Reset failed', true);
  } catch (e) { showLimitsResult('Reset failed: ' + e, true); }
}

// --- Comprehensive Safety Panel ---
const SAFETY_JOINT_INFO = [
  { name:'J0', label:'Base Yaw', hw:135 },
  { name:'J1', label:'Shoulder Pitch', hw:85 },
  { name:'J2', label:'Elbow Pitch', hw:85 },
  { name:'J3', label:'Elbow Roll', hw:135 },
  { name:'J4', label:'Wrist Pitch', hw:85 },
  { name:'J5', label:'Wrist Roll', hw:135 },
];
let _safetyData = null;

function showSafetyResult(msg, isErr) {
  const el = document.getElementById('safetyResult');
  el.style.display = 'block';
  el.style.background = isErr ? '#3a1a1a' : '#1a3a1a';
  el.textContent = typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2);
  setTimeout(() => el.style.display = 'none', 4000);
}

function _riskColor(val, lo, hi) {
  // lo = conservative boundary, hi = aggressive boundary
  if (val <= lo) return 'green';
  if (val >= hi) return 'red';
  return 'yellow';
}

function _setBadge(id, color, text) {
  const el = document.getElementById(id);
  if (!el) return;
  el.className = 'safety-badge ' + color;
  el.textContent = text || (color === 'green' ? 'Safe' : color === 'yellow' ? 'Moderate' : 'Aggressive');
}

function _populateSafetyUI(s) {
  _safetyData = s;
  const container = document.getElementById('safetyContainer');
  container.style.display = 'block';

  // E-Stop
  document.getElementById('safetyEstopCard').style.display = s.emergency_stop.active ? 'block' : 'none';

  // Joint Position Limits
  const jBody = document.getElementById('safetyJointBody');
  jBody.innerHTML = '';
  const jl = s.joint_position_limits.limits_deg;
  const hwl = s.joint_position_limits.hardware_limits_deg;
  let jplWorst = 'green';
  for (let i = 0; i < 6; i++) {
    const ji = SAFETY_JOINT_INFO[i];
    const range = jl[i][1] - jl[i][0];
    const hwRange = hwl[i][1] - hwl[i][0];
    const ratio = range / hwRange;
    const color = ratio < 0.75 ? 'green' : ratio < 0.95 ? 'yellow' : 'red';
    if (color === 'red') jplWorst = 'red';
    else if (color === 'yellow' && jplWorst !== 'red') jplWorst = 'yellow';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:4px">${ji.name} ‚Äî ${ji.label}</td>
      <td style="padding:4px;text-align:center"><input type="number" id="sf_j${i}_min" value="${jl[i][0]}" step="5" class="safety-input" style="width:60px"></td>
      <td style="padding:4px;text-align:center"><input type="number" id="sf_j${i}_max" value="${jl[i][1]}" step="5" class="safety-input" style="width:60px"></td>
      <td style="padding:4px;text-align:center;font-size:11px;color:var(--text-secondary)">¬±${ji.hw}¬∞</td>
      <td style="padding:4px;text-align:center"><span class="safety-risk ${color}"></span></td>`;
    jBody.appendChild(tr);
  }
  _setBadge('badge-jpl', jplWorst);

  // Torque Proxy
  document.getElementById('sf_tp_limit').value = s.torque_proxy.limit;
  document.getElementById('sf_tp_j2').value = s.torque_proxy.j2_factor;
  document.getElementById('sf_tp_enabled').checked = s.torque_proxy.enabled;
  _setBadge('badge-tp', s.torque_proxy.enabled ? (s.torque_proxy.limit <= 120 ? 'green' : s.torque_proxy.limit <= 180 ? 'yellow' : 'red') : 'red', s.torque_proxy.enabled ? undefined : 'Disabled');

  // Stall Detection
  document.getElementById('sf_sd_delay').value = s.stall_detection.delay_s;
  document.getElementById('sf_sd_thresh').value = s.stall_detection.threshold_deg;
  document.getElementById('sf_sd_enabled').checked = s.stall_detection.enabled;
  _setBadge('badge-sd', s.stall_detection.enabled ? 'green' : 'red', s.stall_detection.enabled ? 'Active' : 'Disabled');

  // Collision Detection
  document.getElementById('sf_cd_error').value = s.collision_detection.position_error_deg;
  document.getElementById('sf_cd_dur').value = s.collision_detection.stall_duration_s;
  document.getElementById('sf_cd_cool').value = s.collision_detection.cooldown_s;
  document.getElementById('sf_cd_enabled').checked = s.collision_detection.enabled;
  _setBadge('badge-cd', s.collision_detection.enabled ? 'green' : 'yellow', s.collision_detection.enabled ? 'Active' : 'Disabled');

  // Command Smoother
  document.getElementById('sf_cs_alpha').value = s.command_smoother.alpha;
  document.getElementById('sf_cs_step').value = s.command_smoother.max_step_deg;
  document.getElementById('sf_cs_grip').value = s.command_smoother.max_gripper_step_mm;
  document.getElementById('sf_cs_stale').value = s.command_smoother.feedback_staleness_s;
  _setBadge('badge-cs', s.command_smoother.alpha <= 0.3 ? 'green' : s.command_smoother.alpha <= 0.5 ? 'yellow' : 'red');

  // Velocity Limits (read-only display)
  const vBody = document.getElementById('safetyVelBody');
  vBody.innerHTML = '';
  const vr = s.velocity_limits.max_rad_s;
  const vd = s.velocity_limits.max_deg_s;
  for (let i = 0; i < Math.min(vr.length, 7); i++) {
    const tr = document.createElement('tr');
    const label = i < 6 ? SAFETY_JOINT_INFO[i].name + ' ‚Äî ' + SAFETY_JOINT_INFO[i].label : 'J6 ‚Äî Gripper';
    tr.innerHTML = `<td style="padding:4px">${label}</td>
      <td style="padding:4px;text-align:center">${vr[i].toFixed(1)}</td>
      <td style="padding:4px;text-align:center">${i < vd.length ? vd[i].toFixed(0) : (vr[i]*57.296).toFixed(0)}</td>`;
    vBody.appendChild(tr);
  }
  _setBadge('badge-vl', 'green', 'Read-only');

  // Torque Limits (read-only display)
  const tBody = document.getElementById('safetyTorqueBody');
  tBody.innerHTML = '';
  const tm = s.torque_limits.max_nm;
  for (let i = 0; i < tm.length; i++) {
    const tr = document.createElement('tr');
    const label = i < 6 ? SAFETY_JOINT_INFO[i].name + ' ‚Äî ' + SAFETY_JOINT_INFO[i].label : 'J6 ‚Äî Gripper';
    tr.innerHTML = `<td style="padding:4px">${label}</td><td style="padding:4px;text-align:center">${tm[i].toFixed(1)}</td>`;
    tBody.appendChild(tr);
  }
  _setBadge('badge-tl', 'green', 'Read-only');

  // Workspace
  document.getElementById('sf_wb_radius').value = s.workspace_bounds.max_radius_mm;
  _setBadge('badge-wb', s.workspace_bounds.max_radius_mm <= 480 ? 'green' : s.workspace_bounds.max_radius_mm <= 560 ? 'yellow' : 'red');

  // Ramp
  document.getElementById('sf_rc_thresh').value = s.ramp_control.threshold_deg;
  document.getElementById('sf_rc_step').value = s.ramp_control.step_deg;
  document.getElementById('sf_rc_delay').value = s.ramp_control.delay_s;
  _setBadge('badge-rc', s.ramp_control.step_deg <= 7 ? 'green' : s.ramp_control.step_deg <= 12 ? 'yellow' : 'red');

  // Emergency Stop / Recovery
  document.getElementById('sf_es_auto').checked = s.emergency_stop.auto_recovery_enabled;
  document.getElementById('sf_es_delay').value = s.emergency_stop.auto_recovery_delay_s;
  _setBadge('badge-es', s.emergency_stop.active ? 'red' : 'green', s.emergency_stop.active ? 'E-STOP!' : 'OK');
}

function _gatherSafetyPayload() {
  const jl = [];
  for (let i = 0; i < 6; i++) {
    jl.push([parseFloat(document.getElementById(`sf_j${i}_min`).value),
             parseFloat(document.getElementById(`sf_j${i}_max`).value)]);
  }
  return {
    joint_position_limits: { limits_deg: jl },
    torque_proxy: {
      limit: parseFloat(document.getElementById('sf_tp_limit').value),
      j2_factor: parseFloat(document.getElementById('sf_tp_j2').value),
      enabled: document.getElementById('sf_tp_enabled').checked,
    },
    stall_detection: {
      delay_s: parseFloat(document.getElementById('sf_sd_delay').value),
      threshold_deg: parseFloat(document.getElementById('sf_sd_thresh').value),
      enabled: document.getElementById('sf_sd_enabled').checked,
    },
    collision_detection: {
      position_error_deg: parseFloat(document.getElementById('sf_cd_error').value),
      stall_duration_s: parseFloat(document.getElementById('sf_cd_dur').value),
      cooldown_s: parseFloat(document.getElementById('sf_cd_cool').value),
      enabled: document.getElementById('sf_cd_enabled').checked,
    },
    command_smoother: {
      alpha: parseFloat(document.getElementById('sf_cs_alpha').value),
      max_step_deg: parseFloat(document.getElementById('sf_cs_step').value),
      max_gripper_step_mm: parseFloat(document.getElementById('sf_cs_grip').value),
      feedback_staleness_s: parseFloat(document.getElementById('sf_cs_stale').value),
    },
    workspace_bounds: {
      max_radius_mm: parseFloat(document.getElementById('sf_wb_radius').value),
    },
    ramp_control: {
      threshold_deg: parseFloat(document.getElementById('sf_rc_thresh').value),
      step_deg: parseFloat(document.getElementById('sf_rc_step').value),
      delay_s: parseFloat(document.getElementById('sf_rc_delay').value),
    },
    emergency_stop: {
      auto_recovery_enabled: document.getElementById('sf_es_auto').checked,
      auto_recovery_delay_s: parseFloat(document.getElementById('sf_es_delay').value),
    },
  };
}

async function safetyLoad() {
  try {
    const resp = await fetch('/api/config/safety/all');
    const d = await resp.json();
    if (d.ok) { _populateSafetyUI(d.settings); showSafetyResult('Loaded ‚úì', false); }
    else showSafetyResult(d.error || 'Load failed', true);
  } catch (e) { showSafetyResult('Load failed: ' + e, true); }
}

async function safetySave() {
  try {
    const payload = _gatherSafetyPayload();
    const resp = await fetch('/api/config/safety/all', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    const d = await resp.json();
    if (d.ok) { _populateSafetyUI(d.settings); showSafetyResult('Saved ‚úì', false); }
    else showSafetyResult(d.error || 'Save failed', true);
  } catch (e) { showSafetyResult('Save failed: ' + e, true); }
}

async function safetyPreset(name) {
  if (name !== 'normal' || confirm('Apply preset? This will overwrite current settings.')) {
    try {
      const resp = await fetch('/api/config/safety/preset', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({preset:name}) });
      const d = await resp.json();
      if (d.ok) { _populateSafetyUI(d.settings); showSafetyResult(`Preset "${name}" applied ‚úì`, false); }
      else showSafetyResult(d.error || 'Preset failed', true);
    } catch (e) { showSafetyResult('Preset failed: ' + e, true); }
  }
}

// --- Settings ---
async function simToggle() {
  const msg = armState.sim_mode ? 'Switch to LIVE mode?' : 'Switch to SIM mode?';
  if (!confirm(msg)) return;
  const data = await apiPost('/api/sim/toggle');
  if (data.ok) { armState.sim_mode = data.sim_mode; updateUI(); }
  simRefresh();
}
async function simRefresh() {
  const data = await apiCall('/api/sim/status');
  const el = document.getElementById('simStatus');
  el.textContent = data.sim_mode ? 'SIMULATOR' : 'LIVE'; el.className = 'status-indicator ' + (data.sim_mode ? 'running' : 'stopped');
}

// =====================================================//  Camera Orientation
// =====================================================
let _camOrientConfig = {};

async function camOrientLoad() {
  try {
    const data = await apiCall('/api/cameras/orientation');
    _camOrientConfig = data;
    camOrientRender();
  } catch (e) { console.error('Failed to load camera orientation:', e); }
}

function camOrientRender() {
  const container = document.getElementById('camOrientContainer');
  if (!container) return;
  container.innerHTML = '';
  const colors = { 0: '#00ffff', 1: '#ff4444', 2: '#44ff44' };

  for (const [id, cfg] of Object.entries(_camOrientConfig)) {
    const pos = cfg.position || { x: 0, y: 0, z: 0 };
    const rot = cfg.rotation || { rx: 0, ry: 0, rz: 0 };
    const fov = cfg.fov || 60;
    const color = colors[id] || '#ffffff';

    const div = document.createElement('div');
    div.style.cssText = 'border:1px solid var(--card-border);border-radius:6px;padding:8px;margin-bottom:8px;border-left:3px solid ' + color;
    div.innerHTML = `
      <div style="font-family:var(--mono);font-size:11px;font-weight:bold;color:${color};margin-bottom:6px">${cfg.label || 'Camera ' + id} (cam${id})${cfg.perspective === 'arm-mounted' ? ' ü¶æ EE-relative' : ''}</div>
      <div style="font-size:10px;color:var(--text-dim);margin-bottom:4px">Position (m, Z-up frame)</div>
      ${_camSlider(id, 'px', 'X', pos.x, -2, 2, 0.01)}
      ${_camSlider(id, 'py', 'Y', pos.y, -2, 2, 0.01)}
      ${_camSlider(id, 'pz', 'Z', pos.z, -2, 2, 0.01)}
      <div style="font-size:10px;color:var(--text-dim);margin:4px 0">Rotation (degrees)</div>
      ${_camSlider(id, 'rx', 'RX', rot.rx, -180, 180, 1)}
      ${_camSlider(id, 'ry', 'RY', rot.ry, -180, 180, 1)}
      ${_camSlider(id, 'rz', 'RZ', rot.rz, -180, 180, 1)}
      <div style="font-size:10px;color:var(--text-dim);margin:4px 0">FOV</div>
      ${_camSlider(id, 'fov', 'FOV', fov, 30, 120, 1)}
    `;
    container.appendChild(div);
  }

  // Bind slider events
  container.querySelectorAll('input[type="range"]').forEach(el => {
    el.addEventListener('input', camOrientSliderChanged);
  });
}

function _camSlider(camId, field, label, value, min, max, step) {
  return `<div class="sim-joint-row">
    <span class="sjl" style="width:24px">${label}</span>
    <input type="range" data-cam="${camId}" data-field="${field}" min="${min}" max="${max}" step="${step}" value="${value}" style="flex:1;-webkit-appearance:none;appearance:none;height:4px;background:#1a2744;border-radius:2px;outline:none">
    <span class="sjv" style="width:55px" id="camVal_${camId}_${field}">${Number(value).toFixed(field === 'fov' ? 0 : 2)}</span>
  </div>`;
}

function camOrientSliderChanged(e) {
  const camId = e.target.dataset.cam;
  const field = e.target.dataset.field;
  const val = parseFloat(e.target.value);
  const valEl = document.getElementById(`camVal_${camId}_${field}`);
  if (valEl) valEl.textContent = field === 'fov' ? val.toFixed(0) : val.toFixed(2);

  // Update local config
  const cfg = _camOrientConfig[camId];
  if (!cfg) return;
  if (!cfg.position) cfg.position = { x: 0, y: 0, z: 0 };
  if (!cfg.rotation) cfg.rotation = { rx: 0, ry: 0, rz: 0 };

  if (field === 'px') cfg.position.x = val;
  else if (field === 'py') cfg.position.y = val;
  else if (field === 'pz') cfg.position.z = val;
  else if (field === 'rx') cfg.rotation.rx = val;
  else if (field === 'ry') cfg.rotation.ry = val;
  else if (field === 'rz') cfg.rotation.rz = val;
  else if (field === 'fov') cfg.fov = val;

  // Update 3D sim in real-time
  if (window._sim) {
    window._sim.updateSingleCamera(camId, cfg);
  }
}

async function camOrientSaveAll() {
  for (const [id, cfg] of Object.entries(_camOrientConfig)) {
    await apiPost('/api/cameras/orientation', {
      camera_id: parseInt(id),
      position: cfg.position,
      rotation: cfg.rotation,
      fov: cfg.fov,
    });
  }
  alert('Camera orientations saved!');
}

async function camOrientLoadCalib() {
  // Try to load extrinsics for cam0
  try {
    const data = await apiCall('/api/cameras/extrinsics/0');
    if (data.ok && data.extrinsics) {
      const ext = data.extrinsics;
      if (ext.camera_position_world_m) {
        const p = ext.camera_position_world_m;
        if (!_camOrientConfig['0']) _camOrientConfig['0'] = { label: 'Overhead', perspective: 'overhead' };
        _camOrientConfig['0'].position = { x: p[0], y: p[1], z: p[2] };
        camOrientRender();
        // Update 3D sim
        if (window._sim) window._sim.updateSingleCamera('0', _camOrientConfig['0']);
        alert('Loaded cam0 position from calibration extrinsics');
      }
    }
  } catch (e) {
    alert('Failed to load calibration: ' + e.message);
  }
}

// =====================================================//  INIT
// =====================================================
connectWS();
setTimeout(() => { resizeCanvas(); animLoop(); }, 50);

// SIM badge click
document.getElementById('simBadge').addEventListener('click', simToggle);

// Collision Alert
function showCollisionAlert(data) {
  const el = document.getElementById('collisionAlert');
  document.getElementById('collisionInfo').textContent = `Joint ${data.joint} commanded to ${data.commanded}¬∞ but stuck at ${data.actual}¬∞`;
  document.getElementById('collisionAnalysis').textContent = data.analysis || '';
  const imgContainer = document.getElementById('collisionImages'); imgContainer.innerHTML = '';
  if (data.images) data.images.forEach(src => { const img = document.createElement('img'); img.src = src; imgContainer.appendChild(img); });
  el.classList.add('visible');
}
function dismissCollision() { document.getElementById('collisionAlert').classList.remove('visible'); }

// Calibration status poller
(function(){
  let calibInterval = null;
  function fetchCalibStatus(){
    fetch('/api/arm3d/status').then(r=>r.json()).then(d=>{
      const cc=document.getElementById('calibCams'),cl=document.getElementById('calibLoaded'),cq=document.getElementById('calibQuality');
      if(cc) cc.textContent='Cameras: '+(d.cameras_connected!=null?d.cameras_connected:'--');
      if(cl) cl.textContent='Calibration: '+(d.calibration_loaded?'‚úÖ Loaded':'‚ùå Not loaded');
      if(cq) cq.textContent='Tracking: '+(d.tracking_quality||d.source||'--');
    }).catch(()=>{});
  }
  // Poll when control panel visible
  setInterval(()=>{ if(_activePanel==='control'){fetchCalibStatus();} }, 5000);
  fetchCalibStatus();
})();

// LLM/CV Calibration UI
(function(){
  const btnStart=document.getElementById('btnStartCalib'),btnStop=document.getElementById('btnStopCalib'),progress=document.getElementById('calibProgress'),calibCur=document.getElementById('calibCurrent'),calibTot=document.getElementById('calibTotal'),progressBar=document.getElementById('calibProgressBar'),resultsDiv=document.getElementById('calibResults');
  let pollTimer=null;
  if(btnStart) btnStart.addEventListener('click',async()=>{
    if(!confirm('Start LLM/CV calibration? The arm will move through ~20 poses.')) return;
    btnStart.disabled=true;btnStop.disabled=false;progress.style.display='block';resultsDiv.style.display='none';
    try{const d=await apiPost('/api/calibration/start');if(d.ok)startPolling(d.session_id);else{alert('Failed: '+(d.error||''));btnStart.disabled=false;btnStop.disabled=true;}}catch(e){alert('Error: '+e);btnStart.disabled=false;btnStop.disabled=true;}
  });
  if(btnStop) btnStop.addEventListener('click',async()=>{await fetch('/api/calibration/abort',{method:'POST'});stopPolling();btnStart.disabled=false;btnStop.disabled=true;});
  function startPolling(sid){pollTimer=setInterval(async()=>{try{const d=await apiCall('/api/calibration/status');calibCur.textContent=d.current_pose||0;calibTot.textContent=d.total_poses||20;progressBar.style.width=((d.current_pose||0)/(d.total_poses||20)*100)+'%';if(d.status==='complete'||d.status==='failed'){stopPolling();btnStart.disabled=false;btnStop.disabled=true;if(d.status==='complete'&&sid)showCalibResults(sid);}}catch(e){}},1000);}
  function stopPolling(){if(pollTimer){clearInterval(pollTimer);pollTimer=null;}}
  async function showCalibResults(sid){try{const d=await apiCall('/api/calibration/report/'+sid+'/json');resultsDiv.style.display='block';let txt=`Recommendation: ${d.recommendation||'?'}\nPoses: ${d.total_poses}`;if(d.joints)d.joints.forEach(j=>{txt+=`\n${j.name}: CV ${(j.cv_detection_rate*100).toFixed(0)}% LLM ${(j.llm_detection_rate*100).toFixed(0)}%`;});resultsDiv.textContent=txt;}catch(e){resultsDiv.style.display='block';resultsDiv.textContent='Could not load report';}}
})();

// Performance monitoring
(function(){window.addEventListener('load',()=>{console.log(`[perf] Page loaded in ${performance.now().toFixed(0)}ms`);});})();

// =====================================================//  PICK CONFIG UI
// =====================================================let _pickCfg = null, _pickDefaults = null;

const PICK_CFG_LABELS = {
  detection: 'üîç Detection',
  reach: 'ü¶æ Arm Reach',
  pick: 'üì¶ Multi-view Pick',
  servo: 'üéØ Visual Servo',
  gripper: 'ü§è Gripper',
  safety: 'üõ°Ô∏è Safety',
  tracker: 'üì° Tracker',
  side_height: 'üìê Side Height',
  arm_camera: 'üì∑ Arm Camera',
  contact: 'üëÜ Contact Detection',
};

async function pickCfgLoad() {
  try {
    const r = await fetch('/api/config/pick');
    const d = await r.json();
    _pickCfg = d.config;
    _pickDefaults = d.defaults;
    const diff = d.diff || {};
    renderPickCfg(_pickCfg, _pickDefaults, diff);
    document.getElementById('pickCfgContainer').style.display = '';
  } catch(e) { alert('Failed to load pick config: ' + e); }
}

function renderPickCfg(cfg, defaults, diff) {
  const container = document.getElementById('pickCfgSections');
  container.innerHTML = '';
  for (const [section, values] of Object.entries(cfg)) {
    const card = document.createElement('div');
    card.className = 'panel-card';
    card.style.marginBottom = '12px';
    const title = PICK_CFG_LABELS[section] || section;
    card.innerHTML = `<h3 style="margin:0 0 8px">${title}</h3>`;
    const defSection = defaults[section] || {};
    const diffSection = diff[section] || {};
    renderCfgFields(card, section, '', values, defSection, diffSection);
    container.appendChild(card);
  }
}

function renderCfgFields(parent, section, prefix, obj, defObj, diffObj) {
  for (const [key, val] of Object.entries(obj)) {
    const fullKey = prefix ? prefix + '.' + key : key;
    const defVal = defObj ? defObj[key] : undefined;
    const isDiff = diffObj && key in diffObj;

    if (val !== null && typeof val === 'object' && !Array.isArray(val) && !('lower' in val && 'upper' in val)) {
      // Nested object (not HSV range) ‚Äî recurse
      const sub = document.createElement('div');
      sub.style.cssText = 'margin-left:12px;border-left:2px solid var(--card-border);padding-left:8px;margin-bottom:4px';
      sub.innerHTML = `<div style="font-weight:600;font-size:11px;color:var(--text-muted);margin-bottom:4px">${key}</div>`;
      renderCfgFields(sub, section, fullKey, val, defVal || {}, diffObj && typeof diffObj[key] === 'object' ? diffObj[key] : {});
      parent.appendChild(sub);
    } else if (Array.isArray(val) && val.length > 0 && typeof val[0] === 'object' && 'lower' in val[0]) {
      // HSV range array
      const row = document.createElement('div');
      row.style.cssText = 'margin-bottom:6px';
      row.innerHTML = `<label style="font-size:11px;display:block;margin-bottom:2px;${isDiff?'color:#e67e22;font-weight:600':''}">${key} (HSV ranges)</label>`;
      val.forEach((range, i) => {
        const rDiv = document.createElement('div');
        rDiv.style.cssText = 'display:flex;gap:4px;align-items:center;margin-bottom:2px;font-size:10px';
        rDiv.innerHTML = `
          <span>L:</span>
          <input type="text" data-section="${section}" data-path="${fullKey}[${i}].lower" value="${JSON.stringify(range.lower)}" style="width:100px;font-size:10px;padding:2px 4px" class="pick-cfg-input">
          <span>U:</span>
          <input type="text" data-section="${section}" data-path="${fullKey}[${i}].upper" value="${JSON.stringify(range.upper)}" style="width:100px;font-size:10px;padding:2px 4px" class="pick-cfg-input">
          <span class="hsv-preview" style="width:20px;height:16px;border:1px solid #666;display:inline-block"></span>`;
        row.appendChild(rDiv);
        // Update preview
        setTimeout(() => updateHsvPreview(rDiv), 0);
      });
      parent.appendChild(row);
    } else if (typeof val === 'object' && val !== null && 'lower' in val && 'upper' in val) {
      // Single HSV range
      const row = document.createElement('div');
      row.style.cssText = 'margin-bottom:6px;font-size:10px';
      row.innerHTML = `
        <label style="font-size:11px;${isDiff?'color:#e67e22;font-weight:600':''}">${key}</label>
        <div style="display:flex;gap:4px;align-items:center">
          <span>L:</span>
          <input type="text" data-section="${section}" data-path="${fullKey}.lower" value="${JSON.stringify(val.lower)}" style="width:100px;font-size:10px;padding:2px 4px" class="pick-cfg-input">
          <span>U:</span>
          <input type="text" data-section="${section}" data-path="${fullKey}.upper" value="${JSON.stringify(val.upper)}" style="width:100px;font-size:10px;padding:2px 4px" class="pick-cfg-input">
        </div>`;
      parent.appendChild(row);
    } else if (typeof val === 'number') {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:6px;margin-bottom:4px';
      const step = Number.isInteger(val) ? 1 : 0.1;
      row.innerHTML = `
        <label style="flex:1;font-size:11px;${isDiff?'color:#e67e22;font-weight:600':''}" title="Default: ${defVal}">${key}</label>
        <input type="number" step="${step}" data-section="${section}" data-path="${fullKey}" value="${val}" style="width:80px;font-size:11px;padding:2px 4px" class="pick-cfg-input">`;
      parent.appendChild(row);
    } else if (Array.isArray(val)) {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:6px;margin-bottom:4px';
      row.innerHTML = `
        <label style="flex:1;font-size:11px;${isDiff?'color:#e67e22;font-weight:600':''}">${key}</label>
        <input type="text" data-section="${section}" data-path="${fullKey}" value="${JSON.stringify(val)}" style="width:120px;font-size:10px;padding:2px 4px" class="pick-cfg-input">`;
      parent.appendChild(row);
    }
  }
}

function updateHsvPreview(container) {
  const inputs = container.querySelectorAll('input');
  const preview = container.querySelector('.hsv-preview');
  if (!preview || inputs.length < 2) return;
  try {
    const lower = JSON.parse(inputs[0].value);
    const h = lower[0] * 2; // OpenCV H is 0-180, CSS uses 0-360
    const s = lower[1] / 255 * 100;
    const l = lower[2] / 255 * 50 + 25;
    preview.style.background = `hsl(${h}, ${s}%, ${l}%)`;
  } catch(e) {}
}

async function pickCfgSave() {
  if (!_pickCfg) { alert('Load config first'); return; }
  const inputs = document.querySelectorAll('.pick-cfg-input');
  const update = {};

  inputs.forEach(inp => {
    const section = inp.dataset.section;
    const path = inp.dataset.path;
    if (!section || !path) return;
    let val;
    try {
      val = inp.type === 'number' ? parseFloat(inp.value) : JSON.parse(inp.value);
    } catch(e) {
      val = inp.value;
    }
    setNestedValue(update, section, path, val);
  });

  try {
    const r = await fetch('/api/config/pick', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(update)
    });
    const d = await r.json();
    if (d.ok) {
      _pickCfg = d.config;
      alert('Pick config saved!');
      pickCfgLoad(); // Reload to show diff
    } else {
      alert('Save failed');
    }
  } catch(e) { alert('Save error: ' + e); }
}

function setNestedValue(obj, section, path, value) {
  if (!obj[section]) obj[section] = {};
  // Handle array index paths like "redbull_hsv_ranges[0].lower"
  const arrMatch = path.match(/^(.+)\[(\d+)\]\.(.+)$/);
  if (arrMatch) {
    const [, arrKey, idx, field] = arrMatch;
    if (!obj[section][arrKey]) obj[section][arrKey] = [];
    const i = parseInt(idx);
    if (!obj[section][arrKey][i]) obj[section][arrKey][i] = {};
    obj[section][arrKey][i][field] = value;
    return;
  }
  // Handle dotted paths like "neon_tape_hsv.lower"
  const dotMatch = path.match(/^(.+)\.(.+)$/);
  if (dotMatch) {
    const [, parent, field] = dotMatch;
    if (!obj[section][parent]) obj[section][parent] = {};
    obj[section][parent][field] = value;
    return;
  }
  obj[section][path] = value;
}

async function pickCfgReset() {
  if (!confirm('Reset ALL pick config values to defaults?')) return;
  try {
    const r = await fetch('/api/config/pick/reset', {method: 'POST'});
    const d = await r.json();
    if (d.ok) { _pickCfg = d.config; pickCfgLoad(); alert('Config reset to defaults'); }
  } catch(e) { alert('Reset error: ' + e); }
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="js/arm3d.js?v=2"></script>
<script src="ws-manager.js"></script>
<script defer src="ascii-video.js"></script>
<script defer src="factory3d.js"></script>
<script defer src="realworld3d.js"></script>
<script defer src="js/arm3d-overlay.js"></script>
<script>
// =====================================================
//  Object Detection Panel Functions
// =====================================================
let _objPanelEnabled = false;
let _objPanelObjects = [];

async function objPanelToggle() {
  try {
    const resp = await fetch('/api/objects/toggle', { method: 'POST' });
    const data = await resp.json();
    if (data.ok) {
      _objPanelEnabled = data.enabled;
      _objPanelUpdateUI();
    }
  } catch (e) { console.error('objPanelToggle:', e); }
}

async function objPanelRunDetect() {
  if (!_objPanelEnabled) return;
  const detectBtn = document.getElementById('objPanelDetect');
  if (detectBtn) { detectBtn.textContent = 'DETECTING...'; detectBtn.disabled = true; }
  try {
    // Run detection + get annotated snapshot (this runs detection internally)
    const snapResp = await fetch('/api/objects/detect/snapshot', { method: 'POST' });

    // Show annotated camera image
    if (snapResp.ok) {
      const blob = await snapResp.blob();
      const img = document.getElementById('objDetectCamImg');
      const placeholder = document.getElementById('objDetectCamPlaceholder');
      if (img) {
        img.src = URL.createObjectURL(blob);
        img.style.display = 'block';
      }
      if (placeholder) placeholder.style.display = 'none';
    }

    // Now fetch the object list (detection already finished above)
    const listResp = await fetch('/api/objects/list');
    if (listResp.ok) {
      const data = await listResp.json();
      _objPanelObjects = data.objects || [];
      _objPanelRenderList(_objPanelObjects);
      _objPanelDrawWorkspace(_objPanelObjects);
    }
  } catch (e) {
    console.error('objPanelRunDetect:', e);
  } finally {
    if (detectBtn) { detectBtn.textContent = 'DETECT NOW'; detectBtn.disabled = !_objPanelEnabled; }
  }
}

async function objPanelClear() {
  try {
    await fetch('/api/objects/clear', { method: 'POST' });
    _objPanelObjects = [];
    _objPanelRenderList([]);
    _objPanelDrawWorkspace([]);
    // Reset camera view
    const img = document.getElementById('objDetectCamImg');
    const placeholder = document.getElementById('objDetectCamPlaceholder');
    if (img) img.style.display = 'none';
    if (placeholder) placeholder.style.display = 'block';
  } catch (e) { console.error('objPanelClear:', e); }
}

async function objPanelSyncToSim() {
  // Sync current detected objects to the 3D simulator
  try {
    const resp = await fetch('/api/objects/list');
    const data = await resp.json();
    const objects = data.objects || [];
    if (window._sim) {
      window._sim.updateDetectedObjects(objects);
      window._sim.toggleDetectedObjects(true);
    }
    // Switch to the simulator panel
    const simNav = document.querySelector('[data-panel=simulator]');
    if (simNav) showPanel(simNav);
  } catch (e) { console.error('objPanelSyncToSim:', e); }
}

function _objPanelUpdateUI() {
  const statusEl = document.getElementById('objDetectPanelStatus');
  const enableBtn = document.getElementById('objPanelEnable');
  const detectBtn = document.getElementById('objPanelDetect');
  if (statusEl) {
    statusEl.textContent = _objPanelEnabled ? 'ACTIVE' : 'OFF';
    statusEl.className = 'status-indicator ' + (_objPanelEnabled ? 'running' : 'stopped');
  }
  if (enableBtn) {
    enableBtn.textContent = _objPanelEnabled ? 'DISABLE' : 'ENABLE';
    enableBtn.className = _objPanelEnabled ? 'btn danger' : 'btn primary';
  }
  if (detectBtn) detectBtn.disabled = !_objPanelEnabled;
}

function _objPanelRenderList(objects) {
  const totalEl = document.getElementById('objPanelTotal');
  const reachEl = document.getElementById('objPanelReachable');
  const listEl = document.getElementById('objPanelList');
  if (totalEl) totalEl.textContent = objects.length;
  const reachable = objects.filter(o => o.within_reach);
  if (reachEl) reachEl.textContent = reachable.length;
  if (listEl) {
    if (objects.length === 0) {
      listEl.textContent = 'No objects detected';
    } else {
      listEl.innerHTML = objects.map(o => {
        const reach = o.within_reach
          ? '<span style="color:var(--success);font-weight:bold">REACHABLE</span>'
          : '<span style="color:var(--warning)">Out of reach</span>';
        return `<div style="margin-bottom:6px;padding:4px;border-left:3px solid ${o.within_reach ? 'var(--success)' : 'var(--warning)'}">` +
          `<span style="color:${o.color_hex}">\u25A0</span> <strong>${o.label}</strong> ‚Äî ${reach}<br>` +
          `Pos: (${o.x_mm}, ${o.y_mm}, ${o.z_mm}) mm<br>` +
          `Size: ${o.width_mm}x${o.depth_mm}x${o.height_mm} mm<br>` +
          `Distance: ${o.distance_mm} mm | Conf: ${(o.confidence * 100).toFixed(0)}%</div>`;
      }).join('');
    }
  }
}

/**
 * Draw a 2D top-down workspace map on canvas showing:
 * - Grid lines
 * - Arm reach circle (550mm)
 * - Arm base at center
 * - Detected objects as colored dots with labels
 */
function _objPanelDrawWorkspace(objects) {
  const canvas = document.getElementById('objDetectWorkspaceCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  if (!ctx) return;

  const W = canvas.width;
  const H = canvas.height;
  const cx = W / 2;
  const cy = H / 2;

  // Workspace bounds: -400 to +400 mm, canvas maps to this
  const WS_RANGE = 800; // mm total
  const REACH_MM = 550;
  const scale = W / WS_RANGE; // px per mm

  // Clear
  ctx.fillStyle = '#0a0f1a';
  ctx.fillRect(0, 0, W, H);

  // Grid lines every 100mm
  ctx.strokeStyle = '#1a2235';
  ctx.lineWidth = 0.5;
  for (let mm = -400; mm <= 400; mm += 100) {
    const px = cx + mm * scale;
    ctx.beginPath(); ctx.moveTo(px, 0); ctx.lineTo(px, H); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0, px); ctx.lineTo(W, px); ctx.stroke();
  }

  // Axis lines
  ctx.strokeStyle = '#2a3a55';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, H); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(W, cy); ctx.stroke();

  // Arm reach circle
  const reachPx = REACH_MM * scale;
  ctx.strokeStyle = '#44ff88';
  ctx.lineWidth = 1.5;
  ctx.globalAlpha = 0.4;
  ctx.beginPath();
  ctx.arc(cx, cy, reachPx, 0, Math.PI * 2);
  ctx.stroke();

  // Fill reach area very faintly
  ctx.fillStyle = '#44ff88';
  ctx.globalAlpha = 0.03;
  ctx.beginPath();
  ctx.arc(cx, cy, reachPx, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalAlpha = 1.0;

  // Reach label
  ctx.fillStyle = '#44ff88';
  ctx.globalAlpha = 0.5;
  ctx.font = '10px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('550mm reach', cx, cy - reachPx - 4);
  ctx.globalAlpha = 1.0;

  // Arm base marker
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.arc(cx, cy, 4, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#aaa';
  ctx.font = '10px monospace';
  ctx.textAlign = 'center';
  ctx.fillText('ARM BASE', cx, cy + 14);

  // Draw each detected object
  for (const obj of objects) {
    // Convert mm to canvas px
    // x_mm: positive = right, y_mm: positive = forward (up in top-down view)
    const objPx = cx + obj.x_mm * scale;
    const objPy = cy - obj.y_mm * scale; // invert Y for screen coords

    const color = obj.within_reach ? '#44ff88' : '#ff8844';
    const objColor = obj.color_hex || '#ff8800';

    // Distance line from base to object
    ctx.strokeStyle = color;
    ctx.lineWidth = 0.5;
    ctx.globalAlpha = 0.3;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(objPx, objPy);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.globalAlpha = 1.0;

    // Object circle (size based on object dimensions)
    const objRadius = Math.max(6, Math.max(obj.width_mm || 20, obj.depth_mm || 20) * scale * 0.5);

    // Filled circle with object's actual color
    ctx.fillStyle = objColor;
    ctx.globalAlpha = 0.6;
    ctx.beginPath();
    ctx.arc(objPx, objPy, objRadius, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1.0;

    // Outline
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(objPx, objPy, objRadius, 0, Math.PI * 2);
    ctx.stroke();

    // Label
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 10px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(obj.label.toUpperCase(), objPx, objPy - objRadius - 8);

    // Position + distance
    ctx.fillStyle = '#aaa';
    ctx.font = '9px monospace';
    ctx.fillText(`${obj.distance_mm}mm`, objPx, objPy - objRadius - 0);

    // Reach tag
    ctx.fillStyle = color;
    ctx.font = '8px monospace';
    ctx.fillText(obj.within_reach ? 'REACH' : 'FAR', objPx, objPy + objRadius + 10);
  }

  // Legend
  if (objects.length > 0) {
    ctx.textAlign = 'left';
    ctx.fillStyle = '#aaa';
    ctx.font = '10px monospace';
    ctx.fillText(`${objects.length} objects detected`, 8, H - 8);
  }
}

// Draw initial empty workspace on load
requestAnimationFrame(() => _objPanelDrawWorkspace([]));

// Check status on page load
fetch('/api/objects/status').then(r => r.json()).then(data => {
  if (data.available) {
    _objPanelEnabled = data.enabled;
    _objPanelUpdateUI();
  }
}).catch(() => {});
</script>
<script src="js/simulator3d.js?v=2"></script>
<script>
// =====================================================
//  3D Simulator Integration
// =====================================================
(function() {
  'use strict';

  let sim = null;
  let simInitialized = false;
  let simFpsFrames = 0;
  let simFpsLast = performance.now();

  function initSimulator() {
    if (simInitialized) return;
    const container = document.getElementById('simViewport');
    if (!container || typeof D1ArmSimulator === 'undefined') return;

    sim = new D1ArmSimulator(container);
    window._sim = sim;
    simInitialized = true;

    // Build joint sliders
    const sliderContainer = document.getElementById('simJointSliders');
    const names = ['J0', 'J1', 'J2', 'J3', 'J4', 'J5'];
    for (let i = 0; i < 6; i++) {
      const [lo, hi] = SIM_JOINT_LIMITS[i];
      const row = document.createElement('div');
      row.className = 'sim-joint-row';
      row.innerHTML = `<span class="sjl">${names[i]}</span>` +
        `<input type="range" id="simSlider${i}" min="${lo}" max="${hi}" step="0.5" value="0">` +
        `<span class="sjv" id="simVal${i}">0.0</span>`;
      sliderContainer.appendChild(row);

      const slider = row.querySelector('input');
      slider.addEventListener('input', function() {
        const v = parseFloat(this.value);
        sim.setSimJoint(i, v);
        document.getElementById('simVal' + i).textContent = v.toFixed(1);
        updateSimEEInfo();
      });
    }

    // Gripper slider
    document.getElementById('simGripperSlider').addEventListener('input', function() {
      const v = parseFloat(this.value);
      sim.setSimGripper(v);
      document.getElementById('simGripperValue').textContent = v.toFixed(1);
    });

    // Joints changed callback ‚Äî update sliders when programmatic change
    sim.onJointsChanged = function(joints, gripper) {
      for (let i = 0; i < 6; i++) {
        const sl = document.getElementById('simSlider' + i);
        const vl = document.getElementById('simVal' + i);
        if (sl) sl.value = joints[i];
        if (vl) vl.textContent = joints[i].toFixed(1);
      }
      const gs = document.getElementById('simGripperSlider');
      const gv = document.getElementById('simGripperValue');
      if (gs) gs.value = gripper;
      if (gv) gv.textContent = gripper.toFixed(1);
      updateSimEEInfo();
    };

    // Mode toggle
    document.querySelectorAll('input[name="simMode"]').forEach(radio => {
      radio.addEventListener('change', function() {
        sim.mode = this.value;
        if (this.value === 'simulate' && sim.followLive) {
          toggleFollowMode(false);
        }
        updateSimModeUI();
      });
    });

    // Quick actions
    document.getElementById('simBtnHome').addEventListener('click', () => {
      sim.resetToHome();
    });
    document.getElementById('simBtnSync').addEventListener('click', () => {
      // Sync from the live arm state coming through WebSocket
      if (typeof armState !== 'undefined' && armState.joints) {
        sim.setLiveState(armState.joints, armState.gripper || 0);
        sim.syncFromLive();
      }
    });
    document.getElementById('simBtnFollow').addEventListener('click', () => {
      toggleFollowMode(!sim.followLive);
    });
    document.getElementById('simBtnClearTrail').addEventListener('click', () => {
      sim.clearTrail();
    });

    // Display toggles
    setupVizToggle('simTogGrid', (on) => sim.toggleGrid(on));
    setupVizToggle('simTogAxes', (on) => sim.toggleAxes(on));
    setupVizToggle('simTogEnv', (on) => sim.toggleEnvelope(on));
    setupVizToggle('simTogGhost', (on) => sim.toggleGhost(on));
    setupVizToggle('simTogTrail', (on) => sim.toggleTrail(on));
    setupVizToggle('simTogObjects', (on) => sim.toggleDetectedObjects(on));

    // Object detection buttons
    document.getElementById('simObjToggle').addEventListener('click', toggleObjectDetection);
    document.getElementById('simObjDetect').addEventListener('click', runObjectDetection);
    document.getElementById('simObjClear').addEventListener('click', clearDetectedObjects);
    setupVizToggle('simTogCams', (on) => sim.toggleCameras(on));

    // Execute button
    document.getElementById('simBtnExecute').addEventListener('click', executeSimPose);

    updateSimModeUI();
  }

  function setupVizToggle(id, callback) {
    const btn = document.getElementById(id);
    if (!btn) return;
    btn.addEventListener('click', () => {
      btn.classList.toggle('on');
      callback(btn.classList.contains('on'));
    });
  }

  function toggleFollowMode(on) {
    if (!sim) return;
    sim.followLive = on;
    const btn = document.getElementById('simBtnFollow');
    if (btn) {
      if (on) {
        btn.classList.add('on');
        btn.style.background = '#0a3d20';
        btn.style.borderColor = 'var(--success)';
        btn.style.color = 'var(--success)';
      } else {
        btn.classList.remove('on');
        btn.style.background = '';
        btn.style.borderColor = '';
        btn.style.color = '';
      }
    }
    // Enable/disable sim sliders
    for (let i = 0; i < 6; i++) {
      const sl = document.getElementById('simSlider' + i);
      if (sl) {
        sl.disabled = on;
        sl.style.opacity = on ? '0.4' : '1';
      }
    }
    const gs = document.getElementById('simGripperSlider');
    if (gs) {
      gs.disabled = on;
      gs.style.opacity = on ? '0.4' : '1';
    }
    // If turning on, do an immediate sync
    if (on && typeof armState !== 'undefined' && armState.joints) {
      sim.setLiveState(armState.joints, armState.gripper || 0);
    }
    updateSimModeUI();
  }

  function updateSimModeUI() {
    if (!sim) return;
    const overlay = document.getElementById('simOverlayMode');
    const executeBtn = document.getElementById('simBtnExecute');
    const executeBar = executeBtn ? executeBtn.parentElement : null;
    if (sim.mode === 'physical') {
      overlay.textContent = 'PHYSICAL ‚Äî FOLLOW';
      overlay.className = 'sim-overlay-mode physical';
      executeBtn.className = 'btn-execute phys-mode';
      executeBtn.textContent = 'EXECUTE ON ARM';
      // In physical mode, auto-enable follow and hide execute bar
      if (!sim.followLive) toggleFollowMode(true);
      if (executeBar) executeBar.style.display = 'none';
    } else {
      overlay.textContent = sim.followLive ? 'SIMULATE ‚Äî FOLLOWING' : 'SIMULATE';
      overlay.className = 'sim-overlay-mode simulate';
      executeBtn.className = 'btn-execute sim-mode';
      executeBtn.textContent = 'Send to Arm';
      if (executeBar) executeBar.style.display = '';
    }
  }

  function updateSimEEInfo() {
    if (!sim) return;
    const info = sim.getEEInfo();
    const posEl = document.getElementById('simEEPos');
    const reachEl = document.getElementById('simEEReach');
    if (posEl) posEl.textContent = `x:${info.x}  y:${info.y}  z:${info.z}`;
    if (reachEl) reachEl.textContent = info.reach + ' m';
  }

  async function executeSimPose() {
    if (!sim) return;
    const joints = sim.simJoints.slice();
    const gripper = sim.simGripper;

    if (sim.mode === 'physical') {
      // Confirm before sending to real hardware
      if (!confirm('Send simulated pose to physical arm?\n\nJoints: [' +
        joints.map(v => v.toFixed(1)).join(', ') + ']\nGripper: ' + gripper.toFixed(1) + ' mm')) {
        return;
      }
    }

    try {
      // Send joints to arm via API
      const resp = await fetch('/api/command/set-all-joints', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ angles: joints }),
      });
      const data = await resp.json();
      if (!data.ok) {
        console.warn('[sim] set-all-joints failed:', data.error || data);
      }

      // Send gripper
      const gResp = await fetch('/api/command/set-gripper', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ position: gripper }),
      });
      await gResp.json();

      // Log
      if (typeof logLocal === 'function') {
        logLocal('SIM_EXEC', `Joints=[${joints.map(v=>v.toFixed(1)).join(',')}] G=${gripper.toFixed(1)}`, 'info');
      }
    } catch (e) {
      console.error('[sim] execute error:', e);
      if (typeof logLocal === 'function') {
        logLocal('SIM_EXEC', 'Failed: ' + e.message, 'error');
      }
    }
  }

  // FPS counter
  function updateSimFps() {
    if (!sim || !sim.active) return;
    simFpsFrames++;
    const now = performance.now();
    if (now - simFpsLast >= 1000) {
      const fps = Math.round(simFpsFrames * 1000 / (now - simFpsLast));
      const el = document.getElementById('simFpsDisplay');
      if (el) el.textContent = fps + ' fps';
      simFpsFrames = 0;
      simFpsLast = now;
    }
    requestAnimationFrame(updateSimFps);
  }

  // ----------------------------------------------------------
  //  Object Detection Integration
  // ----------------------------------------------------------

  let objDetectEnabled = false;
  let objAutoDetectInterval = null;

  async function toggleObjectDetection() {
    try {
      const resp = await fetch('/api/objects/toggle', { method: 'POST' });
      const data = await resp.json();
      if (data.ok) {
        objDetectEnabled = data.enabled;
        updateObjDetectUI();
        // Auto-detect periodically when enabled
        if (objDetectEnabled) {
          // Enable the "Objects" viz toggle
          const togBtn = document.getElementById('simTogObjects');
          if (togBtn && !togBtn.classList.contains('on')) {
            togBtn.classList.add('on');
            if (sim) sim.toggleDetectedObjects(true);
          }
          startAutoDetect();
        } else {
          stopAutoDetect();
        }
      }
    } catch (e) {
      console.error('[sim] toggle object detection failed:', e);
    }
  }

  async function runObjectDetection() {
    if (!objDetectEnabled) return;
    try {
      const resp = await fetch('/api/objects/detect', { method: 'POST' });
      const data = await resp.json();
      if (data.ok) {
        // Fetch the object list and update simulator
        await refreshDetectedObjects();
      }
    } catch (e) {
      console.error('[sim] object detection failed:', e);
    }
  }

  async function refreshDetectedObjects() {
    try {
      const resp = await fetch('/api/objects/list');
      const data = await resp.json();
      if (data.objects && sim) {
        sim.updateDetectedObjects(data.objects);
        updateObjListUI(data.objects);
      }
    } catch (e) {
      // silent
    }
  }

  async function clearDetectedObjects() {
    try {
      await fetch('/api/objects/clear', { method: 'POST' });
      if (sim) sim.clearDetectedObjects();
      updateObjListUI([]);
    } catch (e) {
      console.error('[sim] clear objects failed:', e);
    }
  }

  function startAutoDetect() {
    stopAutoDetect();
    // Run detection every 2 seconds when enabled
    objAutoDetectInterval = setInterval(async () => {
      if (!objDetectEnabled || !sim || !sim.active) return;
      try {
        await fetch('/api/objects/detect', { method: 'POST' });
        await refreshDetectedObjects();
      } catch (e) { /* silent */ }
    }, 2000);
  }

  function stopAutoDetect() {
    if (objAutoDetectInterval) {
      clearInterval(objAutoDetectInterval);
      objAutoDetectInterval = null;
    }
  }

  function updateObjDetectUI() {
    const toggleBtn = document.getElementById('simObjToggle');
    const detectBtn = document.getElementById('simObjDetect');
    const label = document.getElementById('simObjEnabledLabel');
    if (toggleBtn) {
      toggleBtn.textContent = objDetectEnabled ? 'Disable' : 'Enable';
      toggleBtn.className = objDetectEnabled ? 'btn on' : 'btn';
    }
    if (detectBtn) {
      detectBtn.disabled = !objDetectEnabled;
    }
    if (label) {
      label.textContent = objDetectEnabled ? 'ON' : 'OFF';
      label.style.color = objDetectEnabled ? 'var(--success)' : 'var(--text-dim)';
    }
  }

  function updateObjListUI(objects) {
    const countEl = document.getElementById('simObjCount');
    const reachEl = document.getElementById('simObjReachable');
    const listEl = document.getElementById('simObjList');

    if (countEl) countEl.textContent = objects.length;
    const reachable = objects.filter(o => o.within_reach);
    if (reachEl) reachEl.textContent = reachable.length;

    if (listEl) {
      if (objects.length === 0) {
        listEl.innerHTML = '<span style="color:#556">No objects detected</span>';
      } else {
        listEl.innerHTML = objects.map(o => {
          const reachTag = o.within_reach
            ? '<span style="color:var(--success)">[REACH]</span>'
            : '<span style="color:var(--warning)">[FAR]</span>';
          const displayLabel = o.category ? `${o.label} <span style="color:#888;font-size:8px">[${o.category}]</span>` : o.label;
          const confBadge = o.llm_confidence > 0 ? ` <span style="color:#6af;font-size:8px">${Math.round(o.llm_confidence*100)}%</span>` : '';
          return `<div style="padding:1px 0">${reachTag} <span style="color:${o.color_hex}">\u25A0</span> ${displayLabel}${confBadge} ‚Äî ${o.distance_mm}mm</div>`;
        }).join('');
      }
    }
  }

  // Feed live arm state to ghost on each WS update
  function simUpdateFromWS() {
    if (!sim || !sim.active) return;
    if (typeof armState !== 'undefined' && armState.joints) {
      sim.setLiveState(armState.joints, armState.gripper || 0);
    }
    updateSimEEInfo();

    // Update detected objects from WebSocket state if available
    if (typeof armState !== 'undefined' && armState.detected_objects) {
      sim.updateDetectedObjects(armState.detected_objects);
      updateObjListUI(armState.detected_objects);
    }

    // Update overlay info
    const overlay = document.getElementById('simOverlayInfo');
    if (overlay && armState) {
      const mode = armState.sim_mode ? 'SIM' : 'LIVE';
      const conn = armState.connected ? 'Connected' : 'Disconnected';
      const objCount = armState.detected_objects ? armState.detected_objects.length : 0;
      const objText = objCount > 0 ? ` | Obj: ${objCount}` : '';
      overlay.textContent = `D1 Arm Simulator | Server: ${mode} | ${conn}${objText}`;
    }
  }

  // ----------------------------------------------------------
  //  Camera Positioning Controls
  // ----------------------------------------------------------

  let camPosCurrentId = 0;

  function initCameraPositioning() {
    const select = document.getElementById('camPosSelect');
    if (!select) return;

    select.addEventListener('change', () => {
      camPosCurrentId = parseInt(select.value);
      camPosLoadCurrent();
    });

    // Position sliders
    ['X', 'Y', 'Z'].forEach(axis => {
      const slider = document.getElementById('camPos' + axis);
      if (slider) {
        slider.addEventListener('input', function() {
          document.getElementById('camPos' + axis + 'Val').textContent = parseFloat(this.value).toFixed(2);
          camPosApplyLive();
        });
      }
    });

    // Rotation sliders
    ['Rx', 'Ry', 'Rz'].forEach(axis => {
      const slider = document.getElementById('camRot' + axis);
      if (slider) {
        slider.addEventListener('input', function() {
          document.getElementById('camRot' + axis + 'Val').textContent = this.value;
          camPosApplyLive();
        });
      }
    });

    // FOV slider
    const fovSlider = document.getElementById('camPosFov');
    if (fovSlider) {
      fovSlider.addEventListener('input', function() {
        document.getElementById('camPosFovVal').textContent = this.value;
        camPosApplyLive();
      });
    }

    // Buttons
    document.getElementById('camPosLookAt').addEventListener('click', () => {
      if (!sim) return;
      const newRot = sim.lookCameraAt(camPosCurrentId);
      if (newRot) {
        document.getElementById('camRotRx').value = newRot.rx;
        document.getElementById('camRotRxVal').textContent = Math.round(newRot.rx);
        document.getElementById('camRotRy').value = newRot.ry;
        document.getElementById('camRotRyVal').textContent = Math.round(newRot.ry);
        document.getElementById('camRotRz').value = newRot.rz;
        document.getElementById('camRotRzVal').textContent = Math.round(newRot.rz);
        camPosUpdateDistInfo();
      }
    });

    document.getElementById('camPosSave').addEventListener('click', camPosSave);
    document.getElementById('camPosReset').addEventListener('click', camPosLoadFromServer);

    // Load initial camera
    setTimeout(camPosLoadCurrent, 500);
  }

  function camPosLoadCurrent() {
    if (!sim) return;
    const cfg = sim.getCameraConfig(camPosCurrentId);
    if (!cfg) return;

    document.getElementById('camPosX').value = cfg.position.x;
    document.getElementById('camPosXVal').textContent = cfg.position.x.toFixed(2);
    document.getElementById('camPosY').value = cfg.position.y;
    document.getElementById('camPosYVal').textContent = cfg.position.y.toFixed(2);
    document.getElementById('camPosZ').value = cfg.position.z;
    document.getElementById('camPosZVal').textContent = cfg.position.z.toFixed(2);

    document.getElementById('camRotRx').value = cfg.rotation.rx;
    document.getElementById('camRotRxVal').textContent = Math.round(cfg.rotation.rx);
    document.getElementById('camRotRy').value = cfg.rotation.ry;
    document.getElementById('camRotRyVal').textContent = Math.round(cfg.rotation.ry);
    document.getElementById('camRotRz').value = cfg.rotation.rz;
    document.getElementById('camRotRzVal').textContent = Math.round(cfg.rotation.rz);

    document.getElementById('camPosFov').value = cfg.fov;
    document.getElementById('camPosFovVal').textContent = cfg.fov;

    camPosUpdateDistInfo();
  }

  function camPosApplyLive() {
    if (!sim) return;
    const cfg = {
      position: {
        x: parseFloat(document.getElementById('camPosX').value),
        y: parseFloat(document.getElementById('camPosY').value),
        z: parseFloat(document.getElementById('camPosZ').value),
      },
      rotation: {
        rx: parseFloat(document.getElementById('camRotRx').value),
        ry: parseFloat(document.getElementById('camRotRy').value),
        rz: parseFloat(document.getElementById('camRotRz').value),
      },
      fov: parseFloat(document.getElementById('camPosFov').value),
    };
    sim.updateSingleCamera(camPosCurrentId, cfg);
    camPosUpdateDistInfo();
  }

  function camPosUpdateDistInfo() {
    if (!sim) return;
    const distBase = sim.getCameraDistanceToBase(camPosCurrentId);
    const distEE = sim.getCameraDistanceToEE(camPosCurrentId);
    const el = document.getElementById('camPosDistInfo');
    if (el && distBase != null) {
      el.textContent = `Dist to base: ${distBase.toFixed(3)}m | Dist to EE: ${(distEE || 0).toFixed(3)}m`;
    }
  }

  async function camPosSave() {
    const pos = {
      x: parseFloat(document.getElementById('camPosX').value),
      y: parseFloat(document.getElementById('camPosY').value),
      z: parseFloat(document.getElementById('camPosZ').value),
    };
    const rot = {
      rx: parseFloat(document.getElementById('camRotRx').value),
      ry: parseFloat(document.getElementById('camRotRy').value),
      rz: parseFloat(document.getElementById('camRotRz').value),
    };
    const fov = parseFloat(document.getElementById('camPosFov').value);

    try {
      const resp = await fetch('/api/cameras/orientation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          camera_id: camPosCurrentId,
          position: pos,
          rotation: rot,
          fov: fov,
        }),
      });
      const data = await resp.json();
      if (data.ok) {
        if (typeof logLocal === 'function') {
          logLocal('CAM_POS', `Camera ${camPosCurrentId} position saved`, 'info');
        }
      }
    } catch (e) {
      console.error('[cam-pos] save failed:', e);
    }
  }

  async function camPosLoadFromServer() {
    try {
      const resp = await fetch('/api/cameras/orientation');
      const config = await resp.json();
      if (sim) {
        sim.updateCameras(config);
        camPosLoadCurrent();
      }
    } catch (e) {
      console.error('[cam-pos] load failed:', e);
    }
  }

  // ----------------------------------------------------------
  //  Gemini Camera Assessment (BETA)
  // ----------------------------------------------------------

  let geminiAssessing = false;

  function initGeminiAssess() {
    const btn = document.getElementById('geminiAssessBtn');
    if (btn) {
      btn.addEventListener('click', runGeminiAssessment);
    }
  }

  async function runGeminiAssessment() {
    if (!sim || geminiAssessing) return;
    geminiAssessing = true;

    const btn = document.getElementById('geminiAssessBtn');
    const statusEl = document.getElementById('geminiAssessStatus');
    const previewsEl = document.getElementById('geminiAssessPreviews');
    const resultEl = document.getElementById('geminiAssessResult');

    btn.disabled = true;
    btn.textContent = 'Capturing...';
    statusEl.style.display = 'block';
    statusEl.textContent = 'Rendering scene from all 3 camera viewpoints...';
    statusEl.style.color = 'var(--primary)';
    resultEl.style.display = 'none';

    try {
      // Step 1: Capture LIVE snapshots from all 3 cameras
      statusEl.textContent = 'Capturing live camera feeds...';
      const camIds = [0, 1, 2];
      const views = {};
      const images = {};
      await Promise.all(camIds.map(async (id) => {
        try {
          const resp = await fetch('/snap/' + id);
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const blob = await resp.blob();
          const dataUrl = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
          views[id] = dataUrl;
          images[id] = dataUrl.split(',')[1];
        } catch (e) {
          console.warn('[gemini-assess] cam' + id + ' snap failed:', e);
        }
      }));

      // Show previews
      previewsEl.style.display = 'block';
      for (const [id, dataUrl] of Object.entries(views)) {
        const img = document.getElementById('geminiPreview' + id);
        if (img && dataUrl) img.src = dataUrl;
      }

      // Step 2: Get current arm state and camera configs for context
      const armJoints = sim.simJoints.slice();
      const camConfigs = sim.getAllCameraConfigs();
      const eeInfo = sim.getEEInfo();

      statusEl.textContent = 'Sending to Gemini for assessment...';
      btn.textContent = 'Assessing...';

      // Step 4: Send to backend
      const resp = await fetch('/api/cameras/gemini-assess', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          images: images,
          joint_angles: armJoints,
          ee_position: eeInfo,
          camera_configs: camConfigs,
        }),
      });

      const data = await resp.json();

      if (data.ok) {
        statusEl.textContent = `Assessment complete (${data.inference_time_ms || 0}ms)`;
        statusEl.style.color = 'var(--success)';

        // Display result
        resultEl.style.display = 'block';
        resultEl.innerHTML = formatGeminiAssessment(data.assessment);
      } else {
        statusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
        statusEl.style.color = 'var(--error)';
        resultEl.style.display = 'block';
        resultEl.innerHTML = `<div style="color:var(--error)">${data.error || 'Assessment failed'}</div>`;
      }
    } catch (e) {
      statusEl.textContent = 'Error: ' + e.message;
      statusEl.style.color = 'var(--error)';
      console.error('[gemini-assess] error:', e);
    } finally {
      geminiAssessing = false;
      btn.disabled = false;
      btn.textContent = 'Assess Camera Positions';
    }
  }

  function formatGeminiAssessment(assessment) {
    if (!assessment) return '<div style="color:var(--text-dim)">No assessment data</div>';

    let html = '';

    // Overall summary
    if (assessment.summary) {
      html += `<div style="font-weight:600;color:var(--primary);margin-bottom:6px;">Summary</div>`;
      html += `<div style="color:#ccc;line-height:1.5;margin-bottom:8px;">${escapeHtml(assessment.summary)}</div>`;
    }

    // Per-camera assessments
    if (assessment.cameras) {
      for (const [id, cam] of Object.entries(assessment.cameras)) {
        const color = id === '0' ? '#00ffff' : id === '1' ? '#ff4444' : '#44ff44';
        html += `<div style="border-left:3px solid ${color};padding-left:6px;margin-bottom:6px;">`;
        html += `<div style="font-weight:600;color:${color};font-size:10px;">Camera ${id}: ${cam.label || ''}</div>`;
        if (cam.estimated_position) {
          html += `<div style="color:#aaa;font-size:9px;">Est. position: ${cam.estimated_position}</div>`;
        }
        if (cam.relative_to_arm) {
          html += `<div style="color:#ccc;font-size:9px;line-height:1.4;">${escapeHtml(cam.relative_to_arm)}</div>`;
        }
        if (cam.view_quality) {
          html += `<div style="color:#8af;font-size:9px;">View quality: ${cam.view_quality}</div>`;
        }
        html += `</div>`;
      }
    }

    // Recommendations
    if (assessment.recommendations) {
      html += `<div style="font-weight:600;color:var(--warning);margin-top:6px;margin-bottom:4px;font-size:10px;">Recommendations</div>`;
      html += `<div style="color:#ccc;font-size:9px;line-height:1.5;">${escapeHtml(assessment.recommendations)}</div>`;
    }

    // Raw reasoning fallback
    if (!assessment.cameras && assessment.raw) {
      html += `<div style="color:#ccc;line-height:1.5;white-space:pre-wrap;font-size:9px;">${escapeHtml(assessment.raw)}</div>`;
    }

    return html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Public activate/deactivate
  window.sim_activate = function() {
    initSimulator();
    if (sim) {
      sim.activate();
      simFpsFrames = 0;
      simFpsLast = performance.now();
      updateSimFps();
      simUpdateFromWS();
      initCameraPositioning();
      initGeminiAssess();
      // Check object detector status on activate
      fetch('/api/objects/status').then(r => r.json()).then(data => {
        if (data.available) {
          objDetectEnabled = data.enabled;
          updateObjDetectUI();
          if (objDetectEnabled) {
            startAutoDetect();
            refreshDetectedObjects();
          }
        }
      }).catch(() => {});
    }
  };

  window.sim_deactivate = function() {
    stopAutoDetect();
    if (sim) sim.deactivate();
  };

  // Hook into WebSocket state updates
  const _origOnWsMessage = window._simWsHook;
  window._simWsHook = function(state) {
    if (sim && sim.active) simUpdateFromWS();
  };
})();
</script>
</body>
</html>