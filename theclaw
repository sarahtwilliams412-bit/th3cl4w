#!/usr/bin/env bash
# ═══════════════════════════════════════════════════════════
#  theclaw — Unified startup, control, and update script
# ═══════════════════════════════════════════════════════════
#
# Usage:
#   theclaw start [--sim]          Start all services (legacy watchdog mode)
#   theclaw start --micro [--sim]  Start microservices architecture
#   theclaw stop                   Stop everything
#   theclaw restart [--sim]        Stop then start
#   theclaw status                 Show what's running
#   theclaw logs [service]         Tail logs (server|cam|loc|map|ascii or microservice name)
#   theclaw update                 Pull latest, install deps, restart
#   theclaw coldstart [opts]       Full arm power-on sequence (network, DDS, enable, home)
#   theclaw health                 Quick health check (all ports responding?)
#
# Modes:
#   Legacy (default): watchdog.sh manages 5 servers on ports 8080-8084
#   Microservices:    th3cl4w-ctl.sh manages 12 services on ports 8080-8091
#
# Environment:
#   THECLAW_MODE=legacy|micro      Override mode (default: legacy)
#   SIMULATE=true                  Run in simulation mode (no real arm)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# ── Colors ──────────────────────────────────────────────────
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
CYAN='\033[0;36m'; DIM='\033[2m'; BOLD='\033[1m'; NC='\033[0m'

# ── Config ──────────────────────────────────────────────────
MODE="${THECLAW_MODE:-legacy}"
API="http://localhost:8080"
WATCHDOG_LOG="/tmp/watchdog.log"
VENV_DIR=""  # Set if using a venv

# Legacy ports
LEGACY_PORTS=(8080 8081 8082 8083 8084)
LEGACY_NAMES=("server" "camera" "location" "map" "ascii")

# Microservice ports (from th3cl4w-ctl.sh)
MICRO_PORTS=(8080 8081 8082 8083 8084 8085 8086 8087 8088 8089 8090 8091)
MICRO_NAMES=("gateway" "camera" "world_model" "local_model" "object_id" "kinematics" "mapping" "positioning" "tasker" "simulation" "control_plane" "telemetry")

# ── Helpers ─────────────────────────────────────────────────
info()  { echo -e "${GREEN}▸${NC} $*"; }
warn()  { echo -e "${YELLOW}▸${NC} $*"; }
error() { echo -e "${RED}▸${NC} $*"; }
header(){ echo -e "\n${CYAN}${BOLD}$*${NC}"; }
dim()   { echo -e "${DIM}  $*${NC}"; }

port_pid() {
    # Get PID listening on a port — match :PORT followed by space
    ss -tlnp 2>/dev/null | grep -E ":${1}\s" | grep -oP 'pid=\K[0-9]+' | head -1 || true
}

port_alive() {
    ss -tlnp 2>/dev/null | grep -qE ":${1}\s" 2>/dev/null
    return $?
}

api_ok() {
    curl -sf -o /dev/null -w "%{http_code}" "$1" 2>/dev/null | grep -q "200"
}

kill_port() {
    local port=$1
    if port_alive "$port"; then
        fuser -k "$port/tcp" 2>/dev/null || true
        sleep 0.3
        if port_alive "$port"; then
            fuser -k -9 "$port/tcp" 2>/dev/null || true
            sleep 0.3
        fi
    fi
}

# ── Status ──────────────────────────────────────────────────
cmd_status() {
    header "═══ th3cl4w Status ═══"
    echo

    # Detect what's running
    local any_legacy=false any_micro=false
    if pgrep -f "watchdog\.sh" >/dev/null 2>&1; then
        any_legacy=true
    fi
    # Check for microservice processes
    if pgrep -f "services\.(control_plane|gateway)" >/dev/null 2>&1; then
        any_micro=true
    fi

    if $any_legacy; then
        echo -e "  Mode: ${GREEN}Legacy (watchdog)${NC}"
    elif $any_micro; then
        echo -e "  Mode: ${GREEN}Microservices${NC}"
    else
        echo -e "  Mode: ${RED}Nothing running${NC}"
    fi

    # Watchdog status
    local wd_count
    wd_count=$(pgrep -c -f "watchdog\.sh" 2>/dev/null || echo 0)
    if [ "$wd_count" -gt 0 ]; then
        echo -e "  Watchdog: ${GREEN}running${NC} (${wd_count} process$([ "$wd_count" -gt 1 ] && echo "es"))"
    fi
    echo

    # Port table
    printf "  ${DIM}%-16s %-6s %-10s %-8s${NC}\n" "SERVICE" "PORT" "STATUS" "PID"
    printf "  ${DIM}%-16s %-6s %-10s %-8s${NC}\n" "───────" "────" "──────" "───"

    local ports names
    if $any_micro; then
        ports=("${MICRO_PORTS[@]}")
        names=("${MICRO_NAMES[@]}")
    else
        ports=("${LEGACY_PORTS[@]}")
        names=("${LEGACY_NAMES[@]}")
    fi

    local running=0 total=${#ports[@]}
    for i in "${!ports[@]}"; do
        local port=${ports[$i]} name=${names[$i]}
        local pid
        pid=$(port_pid "$port" || true)
        if [ -n "$pid" ]; then
            printf "  %-16s %-6s ${GREEN}%-10s${NC} %-8s\n" "$name" "$port" "running" "$pid"
            ((running++)) || true
        else
            printf "  %-16s %-6s ${RED}%-10s${NC} %-8s\n" "$name" "$port" "stopped" "-"
        fi
    done

    echo
    if [ "$running" -eq "$total" ]; then
        echo -e "  ${GREEN}${BOLD}All $total services running ✓${NC}"
    elif [ "$running" -gt 0 ]; then
        echo -e "  ${YELLOW}${running}/${total} services running${NC}"
    else
        echo -e "  ${RED}No services running${NC}"
    fi

    # API health
    if api_ok "$API/api/state"; then
        local state
        state=$(curl -sf "$API/api/state" 2>/dev/null || echo '{}')
        local connected enabled
        connected=$(echo "$state" | python3.12 -c "import json,sys; print(json.load(sys.stdin).get('connected', False))" 2>/dev/null || echo "?")
        enabled=$(echo "$state" | python3.12 -c "import json,sys; print(json.load(sys.stdin).get('enabled', False))" 2>/dev/null || echo "?")
        echo -e "  DDS: $([ "$connected" = "True" ] && echo "${GREEN}connected${NC}" || echo "${RED}disconnected${NC}")"
        echo -e "  Arm: $([ "$enabled" = "True" ] && echo "${GREEN}enabled${NC}" || echo "${YELLOW}disabled${NC}")"
    fi

    # Log sizes
    echo
    echo -e "  ${DIM}Logs:${NC}"
    for f in /tmp/th3cl4w-*.log /tmp/server.log /tmp/watchdog.log; do
        [ -f "$f" ] && printf "    %-30s %s\n" "$(basename "$f")" "$(du -sh "$f" 2>/dev/null | cut -f1)"
    done
    echo
}

# ── Start ───────────────────────────────────────────────────
cmd_start() {
    local use_micro=false sim=false
    for arg in "$@"; do
        case "$arg" in
            --micro) use_micro=true ;;
            --sim)   sim=true ;;
        esac
    done

    if $use_micro; then
        cmd_start_micro "$sim"
    else
        cmd_start_legacy "$sim"
    fi
}

cmd_start_legacy() {
    local sim=$1
    header "Starting th3cl4w (legacy mode)"

    # Check if already running
    if port_alive 8080; then
        warn "Server already running on :8080"
        cmd_status
        return 0
    fi

    # Clean stale processes
    info "Cleaning up stale processes..."
    for port in "${LEGACY_PORTS[@]}"; do
        kill_port "$port"
    done
    pkill -f "watchdog\.sh" 2>/dev/null || true
    sleep 1

    # Truncate large logs
    for f in /tmp/th3cl4w-*.log /tmp/server.log /tmp/watchdog.log; do
        if [ -f "$f" ] && [ "$(stat -c%s "$f" 2>/dev/null || echo 0)" -gt 10485760 ]; then
            info "Rotating $f (>10MB)"
            tail -1000 "$f" > "${f}.tmp" && mv "${f}.tmp" "$f"
        fi
    done

    # Start watchdog
    info "Starting watchdog..."
    if $sim; then
        export SIMULATE=true
        info "Simulation mode enabled"
    fi

    setsid bash web/watchdog.sh >> "$WATCHDOG_LOG" 2>&1 &
    disown
    local wd_pid=$!
    info "Watchdog PID: $wd_pid"

    # Wait for main server
    info "Waiting for server..."
    for i in $(seq 1 30); do
        if api_ok "$API/api/state"; then
            echo
            info "Server ready! ✓"
            echo -e "  ${CYAN}UI: http://localhost:8080${NC}"
            echo -e "  ${CYAN}Cameras: http://localhost:8081${NC}"
            return 0
        fi
        printf "."
        sleep 1
    done
    echo
    error "Server didn't start in 30s"
    error "Check: tail -50 $WATCHDOG_LOG"
    return 1
}

cmd_start_micro() {
    local sim=$1
    header "Starting th3cl4w (microservices mode)"

    if [ ! -f "th3cl4w-ctl.sh" ]; then
        error "th3cl4w-ctl.sh not found — microservices not available"
        return 1
    fi

    if $sim; then
        export SIMULATE=true
    fi

    bash th3cl4w-ctl.sh start all
}

# ── Stop ────────────────────────────────────────────────────
cmd_stop() {
    header "Stopping th3cl4w"

    # Kill watchdog first (prevents respawning)
    local wd_pids
    wd_pids=$(pgrep -f "watchdog\.sh" 2>/dev/null || true)
    if [ -n "$wd_pids" ]; then
        info "Killing watchdog..."
        echo "$wd_pids" | xargs kill 2>/dev/null || true
        sleep 1
        echo "$wd_pids" | xargs kill -9 2>/dev/null || true
    fi

    # Kill all server processes
    info "Killing servers..."
    pkill -f "python3.*web/server\.py" 2>/dev/null || true
    pkill -f "python3.*camera_server\.py" 2>/dev/null || true
    pkill -f "python3.*location_server\.py" 2>/dev/null || true
    pkill -f "python3.*map_server\.py" 2>/dev/null || true
    pkill -f "python3.*ascii_server\.py" 2>/dev/null || true

    # Kill microservice processes if any
    pkill -f "python3.*-m services\." 2>/dev/null || true

    # Free all ports
    for port in "${LEGACY_PORTS[@]}" "${MICRO_PORTS[@]}"; do
        kill_port "$port" 2>/dev/null
    done

    sleep 1

    # Verify
    local still_running=false
    for port in 8080 8081 8082 8083 8084; do
        if port_alive "$port"; then
            warn "Port $port still occupied — force killing"
            fuser -k -9 "$port/tcp" 2>/dev/null || true
            still_running=true
        fi
    done

    if $still_running; then
        sleep 1
    fi

    info "All services stopped ✓"
}

# ── Restart ─────────────────────────────────────────────────
cmd_restart() {
    cmd_stop
    sleep 2
    cmd_start "$@"
}

# ── Logs ────────────────────────────────────────────────────
cmd_logs() {
    local target="${1:-all}"

    case "$target" in
        server|main)   tail -f /tmp/server.log 2>/dev/null || error "No server log" ;;
        cam|camera)    tail -f /tmp/th3cl4w-cam.log 2>/dev/null || error "No camera log" ;;
        loc|location)  tail -f /tmp/th3cl4w-loc.log 2>/dev/null || error "No location log" ;;
        map)           tail -f /tmp/th3cl4w-map.log 2>/dev/null || error "No map log" ;;
        ascii)         tail -f /tmp/th3cl4w-ascii.log 2>/dev/null || error "No ascii log" ;;
        watchdog)      tail -f /tmp/watchdog.log 2>/dev/null || error "No watchdog log" ;;
        all)
            info "Tailing all logs (Ctrl+C to stop)..."
            tail -f /tmp/server.log /tmp/th3cl4w-*.log /tmp/watchdog.log 2>/dev/null
            ;;
        *)
            # Try microservice log
            if [ -f "logs/${target}.log" ]; then
                tail -f "logs/${target}.log"
            else
                error "Unknown log target: $target"
                echo "  Available: server cam loc map ascii watchdog all"
                echo "  Or microservice name (e.g., control_plane)"
            fi
            ;;
    esac
}

# ── Update ──────────────────────────────────────────────────
cmd_update() {
    header "Updating th3cl4w"

    # Save current state
    local was_running=false
    if port_alive 8080; then
        was_running=true
    fi

    # Git pull
    info "Pulling latest..."
    local before after
    before=$(git rev-parse HEAD)
    git pull --ff-only 2>&1 | while read -r line; do dim "$line"; done
    after=$(git rev-parse HEAD)

    if [ "$before" = "$after" ]; then
        info "Already up to date (${before:0:7})"
    else
        local count
        count=$(git rev-list --count "$before..$after")
        info "Updated: ${before:0:7} → ${after:0:7} ($count commits)"
        echo
        dim "Recent changes:"
        git log --oneline "$before..$after" | head -10 | while read -r line; do dim "  $line"; done
    fi

    # Install/update deps
    info "Checking dependencies..."
    if [ -f "requirements.txt" ]; then
        pip install -q -r requirements.txt 2>&1 | grep -v "already satisfied" | while read -r line; do dim "$line"; done || true
    fi

    # Reinstall package in dev mode
    if [ -f "pyproject.toml" ]; then
        pip install -q -e . 2>&1 | grep -v "already satisfied" | while read -r line; do dim "$line"; done || true
    fi

    # Restart if was running
    if $was_running; then
        echo
        info "Restarting services..."
        cmd_restart
    else
        echo
        info "Update complete (services were not running)"
    fi
}

# ── Cold Start ──────────────────────────────────────────────
cmd_coldstart() {
    if [ -f "scripts/startup.sh" ]; then
        bash scripts/startup.sh "$@"
    else
        error "scripts/startup.sh not found"
        return 1
    fi
}

# ── Health ──────────────────────────────────────────────────
cmd_health() {
    local ok=true

    for i in "${!LEGACY_PORTS[@]}"; do
        local port=${LEGACY_PORTS[$i]} name=${LEGACY_NAMES[$i]}
        if port_alive "$port"; then
            printf "  ${GREEN}✓${NC} %-12s :%-5s\n" "$name" "$port"
        else
            printf "  ${RED}✗${NC} %-12s :%-5s\n" "$name" "$port"
            ok=false
        fi
    done

    # API check
    if api_ok "$API/api/state"; then
        printf "  ${GREEN}✓${NC} API responding\n"
    else
        printf "  ${RED}✗${NC} API not responding\n"
        ok=false
    fi

    # Log size check
    for f in /tmp/th3cl4w-*.log; do
        if [ -f "$f" ]; then
            local size
            size=$(stat -c%s "$f" 2>/dev/null || echo 0)
            if [ "$size" -gt 10485760 ]; then
                printf "  ${YELLOW}⚠${NC} %s is %s (>10MB)\n" "$(basename "$f")" "$(du -sh "$f" | cut -f1)"
                ok=false
            fi
        fi
    done

    # Zombie watchdog check
    local wd_count
    wd_count=$(pgrep -c -f "watchdog\.sh" 2>/dev/null || echo 0)
    if [ "$wd_count" -gt 5 ]; then
        printf "  ${YELLOW}⚠${NC} %d watchdog processes (expected ≤5)\n" "$wd_count"
        ok=false
    fi

    echo
    if $ok; then
        echo -e "  ${GREEN}${BOLD}Healthy ✓${NC}"
    else
        echo -e "  ${YELLOW}${BOLD}Issues found${NC}"
    fi
}

# ── Main ────────────────────────────────────────────────────
case "${1:-help}" in
    start)      shift; cmd_start "$@" ;;
    stop)       cmd_stop ;;
    restart)    shift; cmd_restart "$@" ;;
    status|st)  cmd_status ;;
    logs|log)   shift; cmd_logs "${1:-all}" ;;
    update|up)  cmd_update ;;
    coldstart)  shift; cmd_coldstart "$@" ;;
    health|hc)  cmd_health ;;
    help|--help|-h|*)
        echo -e "${CYAN}${BOLD}theclaw${NC} — th3cl4w service manager"
        echo
        echo "Usage: theclaw <command> [options]"
        echo
        echo "Commands:"
        echo "  start [--sim] [--micro]   Start services (default: legacy watchdog)"
        echo "  stop                      Stop all services"
        echo "  restart [--sim]           Restart services"
        echo "  status                    Show service status"
        echo "  logs [target]             Tail logs (server|cam|loc|map|ascii|watchdog|all)"
        echo "  update                    Git pull, install deps, restart if running"
        echo "  coldstart [opts]          Full arm startup (network → DDS → enable → home)"
        echo "  health                    Quick health check"
        echo
        echo "Options:"
        echo "  --sim                     Simulation mode (no real arm)"
        echo "  --micro                   Use microservices architecture"
        echo
        echo "Aliases: status=st, update=up, health=hc, logs=log"
        ;;
esac
