#!/usr/bin/env bash
# theclaw — start, stop, update
set -euo pipefail
cd "$(dirname "${BASH_SOURCE[0]}")"

G='\033[0;32m'; R='\033[0;31m'; Y='\033[1;33m'; C='\033[0;36m'; B='\033[1m'; N='\033[0m'

API="http://localhost:8080"
PORTS=(8080 8081 8082 8083 8084)

port_alive() { ss -tlnp 2>/dev/null | grep -qE ":${1}\s"; }

kill_port() {
    port_alive "$1" && { fuser -k "$1/tcp" 2>/dev/null || true; sleep 0.3; }
    port_alive "$1" && { fuser -k -9 "$1/tcp" 2>/dev/null || true; sleep 0.3; }
}

cmd_start() {
    if port_alive 8080; then
        echo -e "${Y}Already running${N}"
        return 0
    fi

    # Clean stale
    for p in "${PORTS[@]}"; do kill_port "$p"; done
    pkill -f "watchdog\.sh" 2>/dev/null || true
    sleep 1

    # Rotate big logs
    for f in /tmp/th3cl4w-*.log /tmp/server.log /tmp/watchdog.log; do
        [ -f "$f" ] && [ "$(stat -c%s "$f" 2>/dev/null || echo 0)" -gt 10485760 ] && \
            tail -1000 "$f" > "${f}.tmp" && mv "${f}.tmp" "$f"
    done

    echo -e "${C}Starting...${N}"
    setsid bash web/watchdog.sh >> /tmp/watchdog.log 2>&1 &
    disown

    for i in $(seq 1 30); do
        if curl -sf -o /dev/null "$API/api/state" 2>/dev/null; then
            echo -e "${G}${B}Running ✓${N}  http://localhost:8080"
            return 0
        fi
        printf "."
        sleep 1
    done
    echo -e "\n${R}Failed to start — check /tmp/watchdog.log${N}"
    return 1
}

cmd_stop() {
    echo -e "${C}Stopping...${N}"
    pkill -f "watchdog\.sh" 2>/dev/null || true
    sleep 1
    pkill -9 -f "watchdog\.sh" 2>/dev/null || true
    pkill -f "python3.*web/(server|camera_server|location_server|map_server|ascii_server)\.py" 2>/dev/null || true
    sleep 1
    for p in "${PORTS[@]}"; do kill_port "$p"; done
    echo -e "${G}Stopped ✓${N}"
}

cmd_update() {
    local was_running=false
    port_alive 8080 && was_running=true

    echo -e "${C}Pulling...${N}"
    local before after
    before=$(git rev-parse HEAD)
    git pull --ff-only
    after=$(git rev-parse HEAD)

    if [ "$before" = "$after" ]; then
        echo -e "${G}Already up to date${N}"
    else
        echo -e "${G}Updated: ${before:0:7} → ${after:0:7}${N}"
        git log --oneline "$before..$after" | head -5
    fi

    pip install -q -r requirements.txt 2>/dev/null || true
    [ -f pyproject.toml ] && pip install -q -e . 2>/dev/null || true

    if $was_running; then
        cmd_stop
        sleep 2
        cmd_start
    fi
}

case "${1:-help}" in
    start)   cmd_start ;;
    stop)    cmd_stop ;;
    update)  cmd_update ;;
    *)
        echo "theclaw — start/stop/update"
        echo "  theclaw start    Start all services"
        echo "  theclaw stop     Stop all services"
        echo "  theclaw update   Pull + restart"
        ;;
esac
