# Session 2 — 2026-02-08 15:42-16:25 PST — Calibration + Visual Servo

## Calibration Runs
- **Run 1** (cal_1770594529): Failed at pose 4/20 — J1 5.3° off, tolerance too tight (2°/15s)
- **Run 2** (cal_1770594647): **20/20 poses completed**, 80 frames saved. But 0% detection on both CV+LLM
  - CV bug: `segment()` → should be `segment_arm()` in pipeline.py
  - LLM bug: GEMINI_API_KEY not available — `.bashrc` exits early for non-interactive shells
- **Run 3** (cal_1770595013): Failed pose 3 — still using old 2°/15s tolerance (server didn't restart properly)
- **Run 4** (cal_1770595119): Failed pose 10 — httpx ReadTimeout (5s too short for set-joint)
- **Run 5** (cal_1770595358): Failed pose 10 — still ReadTimeout (stale .pyc files)
- **Run 6** (cal_1770595553): Failed pose 9 — ReadTimeout still (needed broader exception catch)
- **Run 7** (cal_1770595726): Stopped by user — too many retries, use existing data instead

## Fixes Applied
1. `segment()` → `segment_arm()` in pipeline.py
2. `.bashrc` GEMINI_API_KEY: `eval "$(grep '^export ' ~/.bashrc)"` in watchdog
3. Tolerance: 2° → 6°, timeout: 15s → 30s
4. httpx timeout: 5s → 30s with 3 retries
5. Failed poses skip instead of crash (`except Exception`)
6. Cleared all `__pycache__` (stale bytecode was main restart issue)

## Offline Re-detection
- Ran CV+LLM detection on saved frames from cal_1770594647 (no arm movement)
- **LLM: 100% detection** (all 5 joints on all 20 poses), 46K tokens, $0.006
- **CV: 0%** — segment_arm still returning nothing (needs background reference)
- Results at `calibration_results/cal_1770594647_redetect/`

## Camera Extrinsics Solved
- EPnP + Levenberg-Marquardt refinement
- **157px mean reprojection error** (100 correspondences from 20 poses)
- Camera 0 position: (-0.51, 0.28, 0.53)m from arm base
- Saved: `calibration_results/camera0_extrinsics.json`

## New Code Built
1. **`src/vision/camera_model.py`** — CameraModel class: world_to_pixel, pixel_to_ray, pixel_to_world_at_z
2. **`/api/locate`** — back-project pixel→3D, optional LLM vision to find objects
3. **`/api/camera/status`** — calibration status endpoint
4. **`src/control/visual_servo.py`** — Visual servo controller with LLM-guided approach
5. **`/api/servo/approach|status|stop`** — servo API endpoints

## Red Bull Can Locate
- Gemini found can at pixel ~(395, 710) in cam0
- Back-projected to ~(539-574, 120-136, 80)mm at table height
- This is within the 550mm arm reach

## Visual Servo Results
- **Run 1** (old code, no averaging): 20 steps, did not converge (286px), J0 oscillating from LLM noise
- **Run 2** (averaged readings + verification): **Converged to 42px in 5 steps** but only horizontal alignment — arm still too high (started from home pose, never lowered)

## Manual Approach Attempts
- Tried various J0/J1/J2/J4 combinations to reach the can
- Vision model distance estimates inconsistent (±50% between frames)
- J0 direction confusion: was going negative when needed positive
- Reached ~1-3 inches from can at one point but couldn't fine-tune

## Power Trip
- Tried to lift shoulder (J1=30) with elbow extended (J2=70) + wrist down (J4=80)
- **Arm powered off** — overcurrent protection triggered
- J1 sagged to 69.7°, J4 to 114° under gravity
- Lesson: sequence moves — lift shoulder FIRST with elbow tucked, THEN extend

## Key Lessons
1. **Server restarts require killing ALL processes + clearing __pycache__** — flock/setsid makes watchdog survive exec cleanup
2. **LLM pixel detection has ±100px noise** — need 3x median averaging for servo
3. **Don't extend elbow while lifting shoulder** — gravity torque trips protection
4. **Move like a human**: raise arm, then reach, then angle wrist
5. **Use the arm as a sensor** — every move should be verified with camera
6. **Don't loop on failures** — use existing data, don't re-run 7 times

## Contact Detection
- Sub-agent spawned to research D1 torque/force feedback
- DDS currently only returns joint angles + status, NO torque
- Tracking error (commanded vs actual) is the only signal of resistance
- Plan document expected at `docs/contact-detection-plan.md`

## State at End of Session
- Arm: **POWERED OFF** (overcurrent trip), needs physical power cycle
- Server: running on :8080, cameras on :8081
- Git: committed up to `a00005d`, push failed (large frame files), added frames to .gitignore
